---
title:  "[Retry, k8s] 07. μ›ν¬λ΅λ“ API - μ¤ν…μ΄νΈν’€μ…‹" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-09-22
last_modified_at: 2023-09-22
---
# [Retry, k8s] 07. μ›ν¬λ΅λ“ API - μ¤ν…μ΄νΈν’€μ…‹
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## π”” μ‹μ‘ν•κΈ° μ „ ...

> λ ν”λ¦¬μΉ΄μ…‹μ€ νλ“ λ³µμ λ³Έμ„ μƒμ„±ν•  λ• μ΄λ¦„ λ° μ£Όμ†λ§ λ‹¤λ¥Ό λΏ λ‚λ¨Έμ§€λ” λ¨λ‘ λ‘κ°™μ€ νλ“λ¥Ό μƒμ„±λλ‹¤. <br><br>
λ§μ•½ <u>νλ“κ°€ PVCλ¥Ό μ°Έμ΅°ν•λ‹¤λ©΄ μ΄ μ—­μ‹ λ‘κ°™μ€ PVCλ¥Ό μ—°κ²°ν•κ² λκ³  ν•΄λ‹Ή PVCλ” νΉμ • ν•λ‚μ PVμ— μ—°κ²°ν•λ‹¤.</u> **(μ¦‰, ν•­μƒ λ‘κ°™μ€ λ³Όλ¥¨μ— μ—°κ²°ν•λ‹¤λ” μλ―Έ)**

![1](https://user-images.githubusercontent.com/42735894/225531010-9f3d1495-5286-4e3c-9898-b767f4d05e56.png){: width="100%" height="100%"}{: .align-center} <br>

- λ ν”λ¦¬μΉ΄μ…‹μ΄ μ κ³µν•λ” νλ“λ” <u>κ° λ³„λ„μ λ³Όλ¥¨μ„ μ‚¬μ©ν•  μ μλ” λ°©λ²•μ„ μ κ³µν•΄μ£Όμ§€ μ•μ•„ λ¨λ‘ κ°™μ€ λ³Όλ¥¨μΌλ΅ κ°™μ€ μƒνƒλ¥Ό κ°€μ§μ λ°–μ— μ—†μ—λ‹¤</u>.

- λν• λ°μ΄ν„°λ² μ΄μ¤μ²λΌ μƒνƒλ¥Ό κ°–λ”(Stateful) μ• ν”λ¦¬μΌ€μ΄μ…μ„ μΏ λ²„λ„¤ν‹°μ¤μ—μ„ μ‹¤ν–‰ν•λ” κ²ƒμ€ λ§¤μ° λ³µμ΅ν• μΌμ΄λ‹¤.

    - νλ“ λ‚΄λ¶€μ λ°μ΄ν„°λ¥Ό μ–΄λ–»κ² κ΄€λ¦¬ν•΄μ•Ό ν• μ§€, μƒνƒλ¥Ό κ°–λ” νλ“μ—λ” μ–΄λ–»κ² μ ‘κ·Όν•  μ μμ„μ§€ λ“±μ„ κΌΌκΌΌν κ³ λ ¤ν•΄μ•Ό ν•κΈ° λ•λ¬Έμ΄λ‹¤.

    - μΏ λ³΄λ„¤ν‹°μ¤λ” μ΄μ— λ€ν• <u>ν•΄κ²°μ±…μ„ μ¤ν…μ΄νΈν’€μ…‹μ΄λΌλ” μ¤λΈμ νΈλ¥Ό μ κ³µ</u>ν•κ³  μλ‹¤.

<br>

## π”” μ¤ν…μ΄νΈν’€μ…‹

> μ¤ν…μ΄νΈν’€μ…‹μ€ μƒνƒλ¥Ό κ°€μ§€κ³  μλ”(statefull) μ• ν”λ¦¬μΌ€μ΄μ…μ„ κ΄€λ¦¬ν•λ”λ° μ‚¬μ©ν•κΈ° μ„ν• λ¦¬μ†μ¤

- Stateful μ• ν”λ¦¬μΌ€μ΄μ… : μ• ν”λ¦¬μΌ€μ΄μ…μ μ‹¤ν–‰ μƒνƒλ‚ μ‚¬μ©μμ μ…λ ¥ λ“±μ„ μ €μ¥ν•κ³  μ μ§€ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…

- Stateless μ• ν”λ¦¬μΌ€μ΄μ… : μ‚¬μ©μμ μ”μ²­μ— λ”°λΌ κ²°κ³Όλ¥Ό λ°ν™ν•κ±°λ‚ μ²λ¦¬ν•λ”λ°λ§ μ§‘μ¤‘ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ νΉμ§•

#### γ€μ¤ν…μ΄νΈν’€μ…‹μ€ νλ“λ“¤μ μμ„μ™€ κ³ μ μ„±μ„ λ³΄μ¥ν•¨γ€‘

- κ° νλ“λ” κ³ μ ν• μ΄λ¦„κ³Ό λ„¤νΈμ›ν¬ μ‹λ³„μλ¥Ό κ°€μ§€λ©°, μ¤ν…μ΄νΈν’€μ…‹μ— μ†ν• νλ“λ“¤μ€ μμ°¨μ μΌλ΅ μƒμ„± λ° μ‚­μ λλ‹¤.

#### γ€μ¤ν…μ΄νΈν’€μ…‹μ€ μ•μ •μ μΈ μ§€μ†μ„±μ„ κ°–λ” κ°κ° κ³ μ ν• μ¤ν† λ¦¬μ§€λ¥Ό μ κ³µν•¨γ€‘

- κ° νλ“λ” μμ‹ μ—κ² ν• λ‹Ήλ νΌμ‹μ¤ν„΄νΈ λ³Όλ¥¨μ„ μ‚¬μ©ν•λ©°, νλ“κ°€ μ¬μƒμ„±λμ–΄λ„ λ°μ΄ν„°λ¥Ό μ μ§€ν•  μ μλ‹¤.

#### γ€μ¤ν…μ΄νΈν’€μ…‹μ€ λ΅¤λ§ μ—…λ°μ΄νΈ μ „λµμ„ ν†µν•΄ νλ“λ“¤μ„ μμ°¨μ μΌλ΅ μ‚­μ ν•κ³  μ¬μƒμ„±μ΄ κ°€λ¥ν•¨γ€‘

- μ΄λ• κ°€μ¥ ν° μμ„ μƒ‰μΈμ—μ„λ¶€ν„° μ‘μ€ μμ„ μƒ‰μΈμ½μΌλ΅ μ—…λ°μ΄νΈκ°€ μ§„ν–‰λλ©°, ν• λ²μ— ν•λ‚μ”© μ—…λ°μ΄νΈλλ‹¤.

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ μ£Όμμ‚¬ν•­

#### γ€νλ“μ— μ‚¬μ©ν•  μ¤ν† λ¦¬μ§€λ” PVCλ¥Ό ν†µν•΄μ„λ§ κ°€λ¥ν•λ‹¤.γ€‘

- λ―Έλ¦¬ PVλ¥Ό μƒμ„±ν•΄λ†“κ±°λ‚ StorageClassλ¥Ό μ‚¬μ©ν•΄ λ™μ  ν”„λ΅λΉ„μ €λ‹μ„ μ‚¬μ©

#### γ€μ¤ν…μ΄νΈν’€μ…‹μ„ μ‚­μ ν•κ±°λ‚ νλ“λ¥Ό μ‚­μ ν•λ”λΌλ„ λ³Όλ¥¨μ€ μ‚­μ λμ§€ μ•λ”λ‹¤.γ€‘

- **λ°μ΄ν„°μ μ•μ „μ„ λ³΄μ¥**ν•κΈ° μ„ν•΄μ„ μ¤ν…μ΄νΈν’€μ…‹ κ΄€λ¦¬ν•μ νλ“κ°€ λ¶„μ‹¤ν•λ” κ²½μ°, λ™μΌν• μ΄λ¦„μΌλ΅ μƒλ΅­κ² νλ“κ°€ κΈ°λ™λλ©° μ΄λ• κΈ°μ΅΄ νλ“κ°€ μ‚¬μ©ν–λ νΌμ‹μ¤ν„΄νΈ λ³Όλ¥¨μ„ μ΄μ–΄μ„ μ‚¬μ©ν•λ‹¤.

- **νΉμ • λ…Έλ“κ°€ μ—°κ²°μ΄ λμ–΄μ΅μ„ λ• μ¤ν…μ΄νΈν’€μ…‹μ€ μƒλ΅μ΄ νλ“λ¥Ό κΈ°λ™ν•μ§€ μ•λ”λ‹¤.** λ§μ•½ λ§μ¤ν„°μ™€μ ν†µμ‹ μ΄ μΌμ‹μ μΌλ΅ λκ²Όμ§€λ§ νλ“λ” κ³„μ†ν•΄μ„ λμ•„κ°€κ³  μλ” κ²½μ°, λ§μ¤ν„°κ°€ λ€μ²΄ νλ“λ¥Ό κΈ°λ™ν•μ—¬ νΌμ‹μ¤ν„΄νΈ λ³Όλ¥¨μ„ λ§μ΄νΈν•κ² λλ©΄ μ¤νλ ¤ λ°μ΄ν„°κ°€ νμ†λ  μ μκΈ° λ•λ¬Έμ΄λ‹¤.

- λ‹¤μ μ¤‘ ν• κ°€μ§€ κ²½μ°μ—λ§ μ¤ν…μ΄νΈν’€μ…‹μ΄ λ¶„μ‹¤λ νλ“λ¥Ό λ‹¤λ¥Έ λ…Έλ“μ—μ„ λ‹¤μ‹ κΈ°λ™ν•λ‹¤.

    - μ¥μ•  λ…Έλ“λ¥Ό K8s ν΄λ¬μ¤ν„°μ λ§΄λ²„μ—μ„ μ μ™Έν•¨

    - λ¬Έμ κ°€ μλ” νλ“λ¥Ό κ°•μ  μΆ…λ£ν•¨

    - μ¥μ• λ΅ μΈν•΄ μ •μ§€ν• λ…Έλ“λ¥Ό μ¬κΈ°λ™ν•¨

#### γ€ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤ ν•„μ”γ€‘

- Serviceλ” κΈ°λ³Έμ μΌλ΅ λ μ΄λΈ” μ…€λ ‰ν„°κ°€ μΌμΉν•λ” λλ¤ν• νλ“λ¥Ό μ„ νƒν•΄ νΈλν”½μ„ μ „λ‹¬ν•κΈ° λ•λ¬Έμ— μ”μ²­μ„ λ¶„μ‚°μ‹ν‚¤μ§€λ§, μ¤ν…μ΄νΈν’€μ…‹μ κ° νλ“λ” κ³ μ ν•κ² μ‹λ³„λμ–΄μ•Όν•λ©°, ν¬λ“μ— μ ‘κ·Όν•  λ•μ—λ„ κ°λ³„ νλ“μ— μ ‘κ·Όν•΄μ•Ό ν•λ‹¤.

- ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤λ” **ClusterIPκ°€ μ—†λ” μ„λΉ„μ¤λ¥Ό μλ―Έν•λ©°, κ° νλ“μ— κ³ μ ν• DNS μ΄λ¦„μ„ λ¶€μ—¬**ν•  μ μμ–΄ νλ“μ— μ§μ ‘ μ ‘κ·Όν•  μ μλ‹¤.

- ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤λ” λ΅λ“λ°Έλ°μ‹±μ΄λ‚ λ‹¨μΌ μ„λΉ„μ¤ IPκ°€ ν•„μ”ν•μ§€ μ•μ„ κ²½μ°μ— μ‚¬μ©λλ‹¤.

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹μ νλ“ μ΄λ¦„

```bash
# νλ“ μ΄λ¦„ ν•μ‹
{StatefulSet-Name}-{Order}

# μμ‹
mysql-0
mysql-1
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹μ νλ“ DNS μ£Όμ†

```bash
# ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤μ™€ μ¤ν…μ΄νΈν’€μ…‹μ„ κ°™μ΄ μ‚¬μ©ν• κ²½μ°, νλ“μ DNS μ£Όμ† ν•μ‹
# Governing-Service-Domainμ€ statefulset.spec.serviceNameμ— μ„ μ–Έν•λ©° ν•΄λ‹Ή ν•„λ“μ— ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤μ μ΄λ¦„μ„ μ§€μ •ν•¨
{Pod-Name}.{Governing-Service-Domain}.{Namespace}.svc.cluster.local

# μμ‹
mysql-0.mysql.default.svc.cluster.local
mysql-1.mysql.default.svc.cluster.local
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ μƒμ„±

> spec.volumeClaimTemplatesλ¥Ό ν†µν•΄ μ¤ν…μ΄νΈν’€μ…‹μΌλ΅ μƒμ„±λλ” κ° νλ“μ— μκµ¬ λ³Όλ¥¨ ν΄λ μ„μ„ μ„¤μ •ν•  μ μλ‹¤. <br><br>
μκµ¬ λ³Όλ¥¨ ν΄λ μ„μ„ μ‚¬μ©ν•λ©΄ ν΄λ¬μ¤ν„° μ™Έλ¶€μ λ„¤νΈμ›ν¬λ¥Ό ν†µν•΄ μ κ³µλλ” μκµ¬ λ³Όλ¥¨μ„ νλ“μ— μ—°κ²°ν•  μ μμΌλ―€λ΅, νλ“λ¥Ό μ¬κΈ°λ™ν•  λ•λ‚ λ‹¤λ¥Έ λ…Έλ“λ΅ μ΄λ™ν•  λ• κΉ¥μ€ λ°μ΄ν„°λ¥Ό λ³΄μ ν• μƒνƒλ΅ μ»¨ν…μ΄λ„κ°€ λ‹¤μ‹ μƒμ„±λλ‹¤.

```bash
cat <<EOF > sample-statefullset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sample-statefulset
spec:
  serviceName: sample-statefulset
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name: nginx-container
        image: nginx:1.16
        volumeMounts:
        - name: www
          mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes:
      - ReadWriteOncePod
      resources:
        requests:
          storage: 1Gi
      storageClassName: csi-fs-sc
EOF
```

```bash
$ kubectl get all,pvc,pv

NAME                       READY   STATUS    RESTARTS   AGE
pod/sample-statefulset-0   1/1     Running   0          98s
pod/sample-statefulset-1   1/1     Running   0          86s
pod/sample-statefulset-2   1/1     Running   0          73s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   49m

NAME                                  READY   AGE
statefulset.apps/sample-statefulset   3/3     99s

NAME                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/www-sample-statefulset-0   Bound    pvc-5633344a-787b-4b07-aed9-5c5f2ee3a766   956Mi      RWO            csi-fs-sc      98s
persistentvolumeclaim/www-sample-statefulset-1   Bound    pvc-e77285ae-be88-4c68-a23a-e4703eed1e22   956Mi      RWO            csi-fs-sc      86s
persistentvolumeclaim/www-sample-statefulset-2   Bound    pvc-5f7917a8-024e-428e-8a42-7e1169b441fc   956Mi      RWO            csi-fs-sc      73s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                              STORAGECLASS   REASON   AGE
persistentvolume/pvc-5633344a-787b-4b07-aed9-5c5f2ee3a766   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-0   csi-fs-sc               98s
persistentvolume/pvc-5f7917a8-024e-428e-8a42-7e1169b441fc   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-2   csi-fs-sc               73s
persistentvolume/pvc-e77285ae-be88-4c68-a23a-e4703eed1e22   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-1   csi-fs-sc               86s
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ μ¤μΌ€μΌλ§

> μ¤ν…μ΄νΈν’€μ…‹μ—μ„ λ ν”λ¦¬μΉ΄ μλ¥Ό λ³€κ²½ν•μ—¬ νλ“λ¥Ό μƒμ„±/μ‚­μ ν•λ©΄ λ ν”λ¦¬μΌ€μ…‹μ΄λ‚ λ°λ¬μ…‹ λ“±κ³Ό λ‹¬λ¦¬ ν•λ‚μ”© μ§„ν–‰ν•κΈ° λ•λ¬Έμ— μ΅°κΈ μ‹κ°„μ΄ κ±Έλ¦°λ‹¤.

+ μ¤μΌ€μΌ μ•„μ›ƒμΌ λ•λ” μΈλ±μ¤κ°€ κ°€μ¥ μ‘μ€ κ²ƒλ¶€ν„° νλ“λ¥Ό ν•λ‚μ”© μƒμ„±λλ‹¤.

+ μ¤μΌ€μΌ μΈμΌ λ•λ” μΈλ±μ¤κ°€ κ°€μ¥ ν° νλ“(κ°€μ¥ μµκ·Όμ— μƒμ„±λ μ»¨ν…μ΄λ„)λ¶€ν„° μ‚­μ λλ‹¤.

+ λ ν”λ¦¬μΉ΄μ…‹μ κ²½μ° νλ“κ°€ λ¬΄μ‘μ„λ΅ μ‚­μ λκΈ° λ•λ¬Έμ— νΉμ • νλ“κ°€ λ§μ¤ν„°κ°€ λλ” μ• ν”λ¦¬μΌ€μ΄μ…μ—λ” λ§μ§€ μ•μ§€λ§, <u>μ¤ν…μ΄νΈν’€μ…‹μ€ 0λ²μ§Έ νλ“κ°€ ν•­μƒ λ¨Όμ € μƒμ„±λκ³  λ¦κ² μ‚­μ λκΈ° λ•λ¬Έμ— 0λ²μ§Έ νλ“λ¥Ό λ§μ¤ν„° λ…Έλ“λ΅ μ‚¬μ©ν•λ” μ΄μ¤‘ν™” κµ¬μ΅° μ• ν”λ¦¬μΌ€μ΄μ…μ— μ ν•©</u>ν•λ‹¤.

```bash
# λ ν”λ¦¬μΉ΄ μλ¥Ό 3μ—μ„ 4λ΅ λ³€κ²½ν• λ§¤λ‹νμ¤νΈλ¥Ό apply
$ sed -i -e 's|replicas: 3|replicas: 4|' sample-statefullset.yaml
$ kubectl apply -f sample-statefullset.yaml

# kubectl scaleμ„ μ‚¬μ©ν• μ¤μΌ€μΌλ§
$ kubectl scale statefulset sample-statefulset --replicas=2
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ λΌμ΄ν”„μ‚¬μ΄ν΄

> μ¤ν…μ΄νΈν’€μ…‹μ—μ„λ„ <u>spec.podManagementPolicyλ¥Ό Parallel(κΈ°λ³Έκ°’μ€ OrderedReady)λ΅ μ„¤μ •ν•μ—¬ λ ν”λ¦¬μΉ΄μ…‹ λ“±κ³Ό λ§μ°¬κ°€μ§€λ΅ λ³‘λ Ήλ΅ λ™μ‹μ— νλ“λ¦΄ κΈ°λ™</u>μ‹ν‚¬ μ μλ‹¤.

```bash
cat <<EOF > sample-statefulset-parallel
apiVersion: apps/v1
kind: statefulset
metadata:
  name: sample-statefulset-parallel
spec
  podManagementPolicy: Parallel
  serviceName: sample-statefulset-parallel
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - naem: nginx-container
        image: nginx:1.16
EOF
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ μ—…λ°μ΄νΈ μ „λµ

+ **OnDelete :** μ¤ν…μ΄νΈν’€μ…‹ λ§¤λ‹νμ¤νΈκ°€ λ³€κ²½λμ—μ„ λ• νλ“λ¥Ό μ—…λ°μ΄νΈν•μ§€ μ•κ³  λ‹¤λ¥Έ μ΄μ λ΅ νλ“κ°€ λ‹¤μ‹ μƒμ„±λ  λ• μƒλ΅μ΄ μ„¤μ •μΌλ΅ νλ“κ°€ μƒμ„±λλ‹¤.

  + μ¤ν…μ΄νΈν’€μ…‹μ—μ„ OnDeleteλ” μμ†μ„± μμ—­μ„ κ°€μ§„ λ°μ΄ν„°λ² μ΄μ¤λ‚ ν΄λ¬μ¤ν„° λ“±μ—μ„ λ§μ΄ μ‚¬μ©λκΈ° λ•λ¬Έμ— μλ™μΌλ΅ μ—…λ°μ΄νΈλ¥Ό ν•κ³  μ‹¶μ€ κ²½μ° μ‚¬μ©

  + λν• typeμ™Έμ— μ§€μ •ν•  μ μλ” ν•­λ©μ€ μ—†λ‹¤.

```bash
cat <<EOF > sample-statefulset-ondelete
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sample-statefulset-ondelete
spec:
  updateStrategy:
    type: OnDelete
  serviceName: sample-statefulset-ondelete
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name: nginx-container
        image: nginx:1.16
EOF
```


+ **RollingUpdate :** λ””ν”λ΅μ΄λ¨ΌνΈμ™€ λ§μ°¬κ°€μ§€λ΅ μ¦‰μ‹ νλ“λ¥Ό μ—…λ°μ΄νΈν•λ‹¤. (μ¤ν…μ΄νΈν’€μ…‹μ μ—…λ°μ΄νΈ μ „λµλ„ κΈ°λ³Έκ°’μΌλ΅ μ„¤μ •λ¨)

  + κ·Έλ¬λ‚ <u>μ¤ν…μ΄νΈν’€μ…‹μ—λ” μμ†μ„± λ°μ΄ν„°κ°€ μμΌλ―€λ΅ λ””ν”λ΅μ΄λ¨ΌνΈμ™€ λ‹¤λ¥΄κ² μ¶”κ°€ νλ“λ¥Ό μƒμ„±ν•΄μ„ λ΅¤λ§ μ—…λ°μ΄νΈλ¥Ό ν•  μ μ—†κ³ , λν• λ™μ‹μ— μ •μ§€ κ°€λ¥ν• μµλ€ νλ“ μ(maxUnavailable)λ¥Ό μ§€μ •ν•μ—¬ λ΅¤λ§ μ—…λ°μ΄νΈλ¥Ό ν•  μ μ—†μΌλ―€λ΅ νλ“λ§λ‹¤ Ready μƒνƒμΈμ§€λ¥Ό ν™•μΈν•κ³  μ—…λ°μ΄νΈ</u>ν•κ² λλ‹¤.

  + spec.podManagementPolicyκ°€ Parallelλ΅ μ„¤μ •λμ–΄ μλ” κ²½μ°μ—λ„ λ³‘λ ¬λ΅ λ™μ‹μ— μ²λ¦¬λμ§€ μ•κ³  νλ“λ¥Ό ν•λ‚μ”© μ—…λ°μ΄νΈλ¥Ό ν•λ‹¤.

  + μ¤ν…μ΄νΈν’€μ…‹μ <u>RollingUpdateμ—μ„λ” partitionμ„ ν†µν•΄ μ „μ²΄ νλ“ μ¤‘ μ–΄λ–¤ νλ“κΉμ§€ μ—…λ°μ΄νΈν• μ§€λ¥Ό μ§€μ •ν•  μ μλ”λ°, μ΄ μ„¤μ •μ„ μ‚¬μ©ν•λ©΄ μ „μ²΄μ— μν–¥μ„ μ£Όμ§€ μ•κ³  λ¶€λ¶„μ μΌλ΅ μ—…λ°μ΄ν‹€ μ μ©ν•κ³  ν™•μΈν•  μ μμ–΄ μ•μ „ν• μ—…λ°μ΄νΈ</u>κ°€ κ°€λ¥ν•λ‹¤.

```bash
# 0~4 μΈλ±μ¤λ¥Ό κ°€μ§„ 5κ°μ νλ“κ°€ μƒμ„±λκ³ , partition=3(3 μ΄μƒμ μΈλ±μ¤λ¥Ό κ°€μ§„ νλ“κ°€ μ—…λ°μ΄νΈ λ€μƒ)μ΄κΈ° λ•λ¬Έμ— μΈλ±μ¤ 4μ™€ 3μΈ νλ“κ°€ μ΄ μμ„λ€λ΅ ν•λ‚μ”© μ—…λ°μ΄νΈλλ‹¤.
# μ΄λ• 0~2 μΈλ±μ¤λ¥Ό κ°€μ§„ νλ“λ” μ—…λ°μ΄νΈλμ§€ μ•μΌλ©°, μ΄ν›„μ— partition κ°’μ„ 3μ—μ„ 1λ΅ λ³€κ²½ν•λ©΄, λ€μƒ μΈλ±μ¤κ°€ 1μ΄μƒμ΄ λκ³  μ—…λ°μ΄νΈλμ§€ μ•μ€ μΈλ±μ¤ 2μ™€ 1μΈ νλ“λ„ μμ„λ€λ΅ μ—…λ°μ΄νΈ λλ‹¤.
cat <<EOF > sample-statefulset-rollingupdate.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sample-statefulset-rollingupdate
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 3
  serviceName: sample-statefulset-rollingupdate
  replicas: 5
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name: nginx-container
        image: nginx:1.16
EOF
```

<br>

### π“ μκµ¬ λ³Όλ¥¨ λ°μ΄ν„° ν™•μΈ

```bash
# μ•½ 1GB μκµ¬ λ³Όλ¥¨μ΄ λ§μ΄νΈλμ–΄ μλ” κ²ƒμ„ ν™•μΈ
$ kubectl exec -it sample-statefulset-0 -- df -h
Filesystem                                                                                                          Size  Used Avail Use% Mounted on
overlay                                                                                                             9.8G  6.1G  3.2G  66% /
tmpfs                                                                                                                64M     0   64M   0% /dev
/dev/mapper/ubuntu--vg-ubuntu--lv                                                                                   9.8G  6.1G  3.2G  66% /etc/hosts
shm                                                                                                                  64M     0   64M   0% /dev/shm
192.168.219.51:6789:/volumes/csi/csi-vol-d89ca152-6f76-47cb-a27b-34d6f6bf03a4/9099aa93-61d6-448c-96e4-d83cd530301f  956M     0  956M   0% /usr/share/nginx/html
tmpfs                                                                                                               1.8G   12K  1.8G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                                                                                               971M     0  971M   0% /proc/acpi
tmpfs                                                                                                               971M     0  971M   0% /proc/scsi
tmpfs                                                                                                               971M     0  971M   0% /sys/firmware


# μκµ¬ λ³Όλ¥¨μ— sample.htmlμ΄ μ—†λ”μ§€ ν™•μΈ
$ kubectl exec -it sample-statefulset-0 -- ls /usr/share/nginx/html/sample.html
ls: cannot access '/usr/share/nginx/html/sample.html': No such file or directory
command terminated with exit code 2


# μκµ¬ λ³Όλ¥¨μ— sample.html μƒμ„±
$ kubectl exec -it sample-statefulset-0 -- touch /usr/share/nginx/html/sample.html


# μκµ¬ λ³Όλ¥¨μ— sample.html νμΌμ΄ μλ”μ§€ ν™•μΈ
$ kubectl exec -it sample-statefulset-0 -- ls /usr/share/nginx/html/sample.html
/usr/share/nginx/html/sample.html
```

> νλ“κ°€ μ‚­μ λκ±°λ‚ μ»¨ν…μ΄λ„ λ‚΄λ¶€ μ—λ¬λ΅ μ»¨ν…μ΄λ„κ°€ μ •μ§€λ κ²½μ° λ“±μ μƒν™©μ—μ„λ„ λ³µκµ¬ ν›„μ— νμΌμ΄ μ μ‹¤λμ§€ μ•λ”λ‹¤.

```bash
# μμƒμΉ λ»ν• νλ“ μ •μ§€ 1(νλ“ μ‚­μ )
$ kubectl delete pod sample-statefulset-0

# μμƒμΉ λ»ν• νλ“ μ •μ§€ 2(nginx ν”„λ΅λ μ¤ μ •μ§€)
$ kubectl exec -it sample-statefulset-0 -- /bin/bash -c 'kill 1'

# νλ“ μ •μ§€, λ³µκµ¬ μ΄ν›„μ—λ„ νμΌ μ μ‹¤ μ—†μ
$ kubectl exec -it sample-statefulset-0 -- ls /usr/share/nginx/html/sample.html
/usr/share/nginx/html/sample.html
```

<br>

### π“ μ¤ν…μ΄νΈν’€μ…‹ μ‚­μ μ™€ μκµ¬ λ³Όλ¥¨ μ‚­μ 

+ μκµ¬ λ³Όλ¥¨μ€ μ¤ν…μ΄νΈν’€μ…‹μ΄ μ‚­μ λμ–΄λ„ λ™μ‹μ— ν•΄μ λμ§€ μ•λ”λ°, μ¤ν…μ΄νΈν’€μ…‹μ΄ μκµ¬ λ³Όλ¥¨μ„ ν•΄μ ν•κΈ° μ „μ— λ³Όλ¥¨μ—μ„ λ°μ΄ν„°λ¥Ό λ°±μ—…ν•  μ μλ„λ΅ μ‹κ°„μ„ μ£ΌκΈ° λ•λ¬Έμ΄λ‹¤.

+ μ¤ν…μ΄νΈν’€μ…‹μ„ μ‚­μ ν•κ³  μ¤ν…μ΄νΈν’€μ…‹μ΄ PVCμΌλ΅ ν™•λ³΄ν• PVμ„ ν•΄μ ν•μ§€ μ•κ³  λ‹¤μ‹ μ¤ν…μ΄νΈν’€μ…‹μ„ μƒμ„±ν• κ²½μ° PV λ°μ΄ν„°λ” κ·Έλ€λ΅ νλ“κ°€ κΈ°λ™λλ‹¤. (μ¤μΌ€μΌ μΈμΌλ΅ λ ν”λ¦¬μΉ΄ μλ¥Ό μ¤„μΌ κ²½μ°λ„ λ§μ°¬κ°€μ§€)

```bash
$ kubectl delete statefulset sample-statefulset
statefulset.apps "sample-statefulset" deleted


$ kubectl get pvc
NAME                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
www-sample-statefulset-0   Bound    pvc-623efc04-b12f-4df4-85c6-7750b5b3c9c1   956Mi      RWO            csi-fs-sc      16m
www-sample-statefulset-1   Bound    pvc-5911ed41-87e0-45a1-88e9-2c12c627ad7e   956Mi      RWO            csi-fs-sc      15m
www-sample-statefulset-2   Bound    pvc-1ee2d2d9-04e0-4289-9d7a-5cdccfb75e9d   956Mi      RWO            csi-fs-sc      15m
www-sample-statefulset-3   Bound    pvc-7293cc9f-00b7-4eca-afa4-061cfc2219f4   956Mi      RWO            csi-fs-sc      15m


$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                              STORAGECLASS   REASON   AGE
pvc-1ee2d2d9-04e0-4289-9d7a-5cdccfb75e9d   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-2   csi-fs-sc               16m
pvc-5911ed41-87e0-45a1-88e9-2c12c627ad7e   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-1   csi-fs-sc               16m
pvc-623efc04-b12f-4df4-85c6-7750b5b3c9c1   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-0   csi-fs-sc               16m
pvc-7293cc9f-00b7-4eca-afa4-061cfc2219f4   956Mi      RWO            Delete           Bound    default/www-sample-statefulset-3   csi-fs-sc               16m


$ kubectl apply -f sample-statefullset.yaml
statefulset.apps/sample-statefulset created


$ kubectl exec -it sample-statefulset-0 -- ls /usr/share/nginx/html/sample.html
/usr/share/nginx/html/sample.html


# μ¤ν…μ΄νΈν’€μ…‹μ΄ ν™•λ³΄ν• PV ν•΄μ 
$ kubectl delete pvc www-sample-statefulset-{0..3}
persistentvolumeclaim "www-sample-statefulset-0" deleted
persistentvolumeclaim "www-sample-statefulset-1" deleted
persistentvolumeclaim "www-sample-statefulset-2" deleted
persistentvolumeclaim "www-sample-statefulset-3" deleted
```