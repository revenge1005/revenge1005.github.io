---
title:  "[Ubuntu] 04. SSH ì„œë²„ - (2)" 

categories:
  - UBUNTU
tags:
  - [ubuntu, linux]

toc: true
toc_sticky: true

date: 2023-05-23
last_modified_at: 2023-05-23
---
<br>

# ğŸ”” SFTP ì „ìš© + Chroot
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

<br>

> SFTP ì „ìš© + Chrootë¥¼ êµ¬ì„±ìœ¼ë¡œ, ì´ ì„¤ì •ì´ ì ìš©ëœ ì¼ë¶€ ì‚¬ìš©ìëŠ” SFTP ë° chroot ë””ë ‰í† ë¦¬ë§Œ ì‚¬ìš©í•˜ì—¬ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

<big> **â–  ì˜ˆë¥¼ ë“¤ì–´ [/home]ì„ Chroot ë””ë ‰í„°ë¦¬ë¡œ ì„¤ì •** </big>

```bash
# SFTP ì „ìš© ê·¸ë£¹ ë§Œë“¤ê¸°
$ groupadd sftp_users


# SFTPì— ëŒ€í•´ì„œë§Œ ì‚¬ìš©ì [choi]ì—ê²Œ ì ìš©
$ usermod -aG sftp_users choi


$ vi /etc/ssh/sshd_config

# line 115 : ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì•„ë˜ì™€ ê°™ì´ í•œ ì¤„ì„ ì¶”ê°€
#Subsystem sftp /usr/lib/openssh/sftp-server
Subsystem sftp internal-sftp

# ëì— ì¶”ê°€
Match Group sftp_users
    X11Forwarding no
    AllowTcpForwarding no
    ChrootDirectory /home
    ForceCommand internal-sftp


$ systemctl restart ssh
```

<br>

<big> **â–  ì‚¬ìš©ì ì„¤ì • SFTP ì „ìš© ì„¤ì •ìœ¼ë¡œ ì‘ì—…í•˜ëŠ”ì§€ í™•ì¸** </big>

```bash
$ ssh choi@dlp.srv.test
choi@dlp.srv.test's password:
This service allows sftp connections only.
Connection to dlp.srv.test closed.    # ì •ìƒì ìœ¼ë¡œ ê±°ë¶€ë¨


$ sftp choi@dlp.srv.test
choi@dlp.srv.test's password:
Connected to dlp.srv.test.
sftp>
```

<br><br>

# ğŸ”” SSH-Agent
---

> SSH-AgentëŠ” SSH í‚¤ ìŒì˜ ë¹„ë°€í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê³ , SSH ì ‘ì† ì‹œ ë¹„ë°€í‚¤ì˜ ì…ë ¥ ì—†ì´ ìë™ìœ¼ë¡œ ì ‘ì†ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” í”„ë¡œê·¸ë¨

+ SSH ì ‘ì† ì‹œ, ë³´í†µ ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•˜ì—¬ ì¸ì¦ì„ í•´ì•¼í•˜ëŠ”ë° ì´ë•Œ SSH-Agentë¥¼ ì‚¬ìš©í•˜ë©´, í•œë²ˆ ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•˜ì—¬ SSH-Agentì— ë“±ë¡í•´ë†“ìœ¼ë©´ ì´í›„ SSH ì ‘ì† ì‹œ ë¹„ë°€í‚¤ë¥¼ ì…ë ¥í•  í•„ìš” ì—†ì´ ìë™ìœ¼ë¡œ ì¸ì¦ì´ ê°€ëŠ¥í•˜ë‹¤.

+ SSH-AgentëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ í™˜ê²½ì—ì„œë§Œ ì‹¤í–‰ë˜ë©°, ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•˜ë©´ SSH-Agentë„ í•¨ê»˜ ì¢…ë£Œë©ë‹ˆë‹¤. ë”°ë¼ì„œ SSH-Agentë¥¼ ì´ìš©í•˜ì—¬ ë¹„ë°€í‚¤ë¥¼ ë“±ë¡í•˜ë©´, í•´ë‹¹ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œë§Œ SSH ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤.

+ SSH-Agentë¥¼ ì‚¬ìš©í•˜ë©´, SSH ì ‘ì† ì‹œ ë¹„ë°€í‚¤ë¥¼ ë°˜ë³µí•´ì„œ ì…ë ¥í•˜ëŠ” ë²ˆê±°ë¡œì›€ì„ í•´ê²°í•  ìˆ˜ ìˆìœ¼ë©°, ë³´ì•ˆì„±ë„ ë†’ì¼ ìˆ˜ ìˆë‹¤.

<br>

<big> **â–  SSH í†µì‹  ê³¼ì •** </big>


1. í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²° ìš”ì²­ì„ í•©ë‹ˆë‹¤.

2. ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ê³µê°œí‚¤ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

3. í´ë¼ì´ì–¸íŠ¸ëŠ” ê³µê°œí‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ëŒ€í•œ ì•”í˜¸í™”ëœ ì„¸ì…˜ í‚¤ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ ì„œë²„ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.

4. ì„œë²„ëŠ” ìì‹ ì˜ ë¹„ë°€í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ í‚¤ë¥¼ ë³µí˜¸í™”í•©ë‹ˆë‹¤.

5. ì´ì œ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„¸ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ëœ í†µì‹ ì„ í•©ë‹ˆë‹¤.

> ì´ë¥¼ í†µí•´ ì¤‘ê°„ì— íƒˆì·¨ë  ê°€ëŠ¥ì„±ì´ ìˆëŠ” íŒ¨ìŠ¤ì›Œë“œ ë“±ì˜ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

<big> **â–  SSH-Agentë¥¼ ì‚¬ìš©í–ˆì„ ë•Œì˜ í†µì‹  ê³¼ì •** </big>


1. í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²° ìš”ì²­ì„ í•©ë‹ˆë‹¤.

2. ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ê³µê°œí‚¤ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

3. í´ë¼ì´ì–¸íŠ¸ëŠ” SSH-Agentì—ê²Œ ìì‹ ì˜ ë¹„ë°€í‚¤ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

4. SSH-AgentëŠ” ìš”ì²­ì— ëŒ€í•´ ì¸ì¦ëœ ë¹„ë°€í‚¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

5. í´ë¼ì´ì–¸íŠ¸ëŠ” SSH-Agentë¡œë¶€í„° ë°›ì€ ì¸ì¦ëœ ë¹„ë°€í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ëŒ€í•œ ì„¸ì…˜ í‚¤ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ ì„œë²„ì—ê²Œ ë³´ëƒ…ë‹ˆë‹¤.

6. ì„œë²„ëŠ” ìì‹ ì˜ ë¹„ë°€í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ í‚¤ë¥¼ ë³µí˜¸í™”í•©ë‹ˆë‹¤.

7. ì´ì œ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„¸ì…˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”ëœ í†µì‹ ì„ í•©ë‹ˆë‹¤.

> ì¦‰, SSH-Agentë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ëŠ” ë¹„ë°€í‚¤ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , SSH-Agentë¥¼ í†µí•´ ë¹„ë°€í‚¤ë¥¼ ìš”ì²­í•˜ê³ , SSH-AgentëŠ” ì¸ì¦ëœ ë¹„ë°€í‚¤ë¥¼ ì œê³µí•˜ì—¬ ì„¸ì…˜ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¹„ë°€í‚¤ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë…¸ì¶œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë”ìš± ì•ˆì „í•œ SSH í†µì‹ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<br>

<big> **â–  í´ë¼ì´ì–¸íŠ¸ì—ì„œ SSH í‚¤ ìŒì„ ìƒì„±í•˜ê³  ê³µê°œ í‚¤ë¥¼ ì„œë²„ì— ë³µì‚¬** </big>

```bash
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/test/.ssh/id_rsa):
Created directory '/home/test/.ssh'.
Enter passphrase (empty for no passphrase):             # PW ì…ë ¥
Enter same passphrase again:                            # PW ë‹¤ì‹œ ì…ë ¥
Your identification has been saved in /home/test/.ssh/id_rsa
Your public key has been saved in /home/test/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:vxroT8IqL1BnisexijpZmOAJpZsJrLIlVxW9yDB3vHQ test@dlp.srv.test
The key's randomart image is:
+---[RSA 3072]----+
|      .+         |
|  . o o = E      |
|.o   * + +       |
|=.o + o o        |
|*X.B    S        |
|%oO  . . .       |
|o@    + o .      |
|* o  o o . .     |
|o. +o ..o..      |
+----[SHA256]-----+

$ ssh-copy-id dlp.srv.test
```

<br>

<big> **â–  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ssh-agent ë¥¼ ì‹œì‘í•˜ê³  ssh-add ëª…ë ¹ìœ¼ë¡œ í‚¤ë¥¼ ì¶”ê°€** </big>

```bash
# SSH-Agent ì‹¤í–‰
$ eval $(ssh-agent)
Agent pid 1657

# ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€
$ ssh-add
Enter passphrase for /home/test/.ssh/id_rsa:
Identity added: /home/test/.ssh/id_rsa (test@dlp.srv.test)

# ë“±ë¡ëœ SSH í‚¤ í™•ì¸
$ ssh-add -l
3072 SHA256:vxroT8IqL1BnisexijpZmOAJpZsJrLIlVxW9yDB3vHQ test@dlp.srv.test (RSA)

# SSH ì ‘ì†
$ ssh dlp.srv.test hostname
dlp.test.srv

# SSH-Agent ì¢…ë£Œ
# ì¢…ë£Œí•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì•„ì›ƒí•˜ì—¬ë„ SSH-Agent í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜
$ eval $(ssh-agent -k)
Agent pid 1657 killed
```

<br><br>

# ğŸ”” SSHPass
---

> SSHPassëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ssh ì ‘ì† ì‹œ íŒ¨ìŠ¤ì›Œë“œ ìš”êµ¬ ì—†ì´ í•  ìˆ˜ ìˆëŠ” ë„êµ¬

+ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í‚¤ ìƒì„±(ssh-keygen)í•˜ì—¬ ì„œë²„ë¡œ ë°°í¬(ssh-copy-id)í•˜ì—¬, ssh, scp ìˆ˜í–‰ ì‹œ ë°°ì¹˜ëª¨ë“œë¡œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì „ë‹¬í•˜ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ì— íŒ¨ìŠ¤ì›Œë“œë¥¼ ê¸°ì¬í•˜ì—¬ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤.

<br>

<big> **â–  SSHPass ì„¤ì¹˜** </big>

```bash
$ apt -y install sshpass
```

<br>

<big> **â–  SSHPass ì‚¬ìš© ë°©ë²•** </big>

```bash
# [-p password] 
$ sshpass -p 1234 ssh dlp.srv.test hostname
dlp.srv.test

# [-f file] 
$ echo '1234' > sshpass.txt
$ chmod 600 sshpass.txt
$ sshpass -f sshpass.txt ssh dlp.srv.test hostname
dlp.srv.test

# [-e] : í™˜ê²½ë³€ìˆ˜ë¡œë¶€í„°
$ export SSHPASS=1234
$ sshpass -e ssh dlp.srv.test hostname
dlp.srv.test
```

<br><br>

# ğŸ”” SSH Port Forwarding
---

> SSH Port Forwardingì€ SSH ì—°ê²°ì„ í†µí•´ ë¡œì»¬ ë¨¸ì‹ ê³¼ ì›ê²© ì„œë²„ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ê¸°ìˆ  

<br>

<big> **â–  ë¡œì»¬ í¬íŠ¸ í¬ì›Œë”©(Local Port Forwarding)** </big>

+ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì›ê²© ì„œë²„ë¡œ ì—°ê²°ì„ ì „ë‹¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì›ê²© ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì•ˆì „í•˜ê²Œ í†µì‹ í•˜ë„ë¡ í•´ì¤ë‹ˆë‹¤. 

+ ì˜ˆë¥¼ ë“¤ì–´, ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì‹¤í–‰í•˜ê³ , SSH Port Forwardingì„ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ í¬íŠ¸ë¥¼ ì›ê²© ì„œë²„ì˜ ì›¹ ì„œë²„ í¬íŠ¸ì— ë§¤í•‘ì‹œì¼œì„œ ì›¹ ì„œë²„ì— ì ‘ì†í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.

<br>

<big> **â–  ì›ê²© í¬íŠ¸ í¬ì›Œë”©(Remote Port Forwarding)** </big>

+ ì›ê²© ì„œë²„ì—ì„œ ë¡œì»¬ ë¨¸ì‹ ìœ¼ë¡œ ì—°ê²°ì„ ì „ë‹¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì›ê²© ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì•ˆì „í•˜ê²Œ í†µì‹ í•˜ë„ë¡ í•´ì¤ë‹ˆë‹¤. 

+ ì˜ˆë¥¼ ë“¤ì–´, ì›ê²© ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ë°ì´í„°ë² ì´ìŠ¤ì— ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì ‘ì†í•˜ê¸° ìœ„í•´ì„œ SSH Port Forwardingì„ ì‚¬ìš©í•˜ì—¬ ì›ê²© í¬íŠ¸ë¥¼ ë¡œì»¬ ë¨¸ì‹ ì˜ ë°ì´í„°ë² ì´ìŠ¤ í¬íŠ¸ì— ë§¤í•‘ì‹œí‚¤ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.

<br>

<br>

<big> **â–  ì˜ˆì‹œ** </big>

+  ì˜ˆë¥¼ ë“¤ì–´ [92.168.219.195]ì˜ í¬íŠ¸ [8081]ì— ëŒ€í•œ ìš”ì²­ì´ [192.168.219.191]ì˜ í¬íŠ¸ [80]ë¡œ ì „ë‹¬ë˜ë„ë¡ SSH í¬íŠ¸ í¬ì›Œë”©ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```bash
# Source í˜¸ìŠ¤íŠ¸ì—ì„œ ëŒ€ìƒ í˜¸ìŠ¤íŠ¸ë¡œ SSH ë¡œê·¸ì¸
[root@dlp ~]# ssh -L 192.168.219.195:8081:192.168.219.191:80 root@192.168.219.191
root@node01.test.srv's password:
[root@node01 ~]# 

# í™•ì¸
[root@node01 ~]#  ssh 192.168.219.195 "ss -napt | grep 8081"
root@192.168.219.195's password:
LISTEN 0      128    192.168.219.195:8081          0.0.0.0:*     users:(("ssh",pid=2207,fd=4)) 
```

<br>

<big> **â–  í™•ì¸** </big>

![4894894](https://github.com/revenge1005/Kubernetes-Study/assets/42735894/b5b3e899-3098-4cbb-a0cc-64f49668b320)
