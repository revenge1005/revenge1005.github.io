---
title:  "[Ubuntu] 09. DNS - DNS ë³´ì¡° ì„œë²„(Slave Server) ë° ì „ë‹¬ì(Forward)ë¥¼ êµ¬ì„±" 

categories:
  - UBUNTU
tags:
  - [ubuntu, linux]

toc: true
toc_sticky: true

date: 2021-05-02
last_modified_at: 2021-05-02
---
<br>

# ğŸ”” DNS ë³´ì¡° ì„œë²„(Slave Server) ë° ì „ë‹¬ì(Forward)ë¥¼ êµ¬ì„±
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

<br>

<big> **â–  DNS ë§ˆìŠ¤í„° ì„œë²„ í˜¸ìŠ¤íŠ¸ì—ì„œ êµ¬ì„±** </big>

```bash
$ cat named.conf

...
...

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

# ì¶”ê°€
include "/etc/bind/named.conf.internal-zones";


$ cat /etc/default/named
# IPv6ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  IPv6 ê´€ë ¨ ë¡œê·¸ë„ í‘œì‹œí•˜ì§€ ì•ŠëŠ” ê²½ìš° ë³€ê²½ ê°€ëŠ¥
# IPv4ë§Œ ì‚¬ìš©í•˜ë„ë¡ BIND ì„¤ì •
OPTIONS="-u bind -4"


$ vi /etc/bind/named.conf.options

acl internal-network {
        192.168.219.0/24;
};

options {
        directory "/var/cache/bind";

        ...
        ...

        allow-query { localhost; internal-network; };
        # ì˜ì—­ íŒŒì¼ì„ ì „ì†¡í•  ìˆ˜ ìˆë„ë¡ ë³´ì¡° ì„œë²„ ì¶”ê°€
        allow-transfer { localhost; 192.168.219.192; };

        recursion yes;

        //========================================================================
        // If BIND logs error messages about the root key being expired,
        // you will need to update your keys.  See https://www.isc.org/bind-keys
        //========================================================================
        dnssec-validation auto;

        listen-on-v6 { any; };
};


$ cat /etc/bind/named.conf.internal-zones
zone "test.srv" IN {
        type master;
        file "/etc/bind/named/test.srv.lan";
        allow-update { none; };
        ## slave ì„œë²„ ì£¼ì†Œ
        allow-transfer { 192.168.219.195; };
        also-notify { 192.168.219.195; };
};
zone "219.168.192.in-addr.arpa" IN {
        type master;
        file "/etc/bind/named/219.168.192.db";
        allow-update { none; };
        ## slave ì„œë²„ ì£¼ì†Œ
        allow-transfer { 192.168.219.195; };
        also-notify { 192.168.219.195; };
};

```

```bash
$ cat /etc/bind/named/test.srv.lan
$TTL 86400
@   IN  SOA     dlp.test.srv. root.test.srv. (
        2022081001  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      dlp.test.srv.
        IN  A       192.168.219.101
        IN  MX 10   dlp.test.srv.

dlp     IN  A       192.168.219.101
www     IN  A       192.168.219.102


$ cat /etc/bind/named/219.168.192.db
$TTL 86400
@   IN  SOA     dlp.test.srv. root.test.srv. (
        2022081001  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      dlp.test.srv.

101     IN  PTR     dlp.test.srv.
102     IN  PTR     www.test.srv.


$ systemctl restart named
```

<br>

<big> **â–  DNS ë³´ì¡° ì„œë²„ í˜¸ìŠ¤íŠ¸ì—ì„œ êµ¬ì„±** </big>

```bash
$ cat /etc/bind/named.conf

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

# ì¶”ê°€
include "/etc/bind/named.conf.internal-zones";


$ cat named.conf.options
acl internal-network {
        192.168.219.0/24;
};

options {
        directory "/var/cache/bind";

        ....
        ....

        allow-query { localhost; internal-network; };
        allow-transfer { localhost; };

        recursion yes;

        ....
        ....

        dnssec-validation auto;

        listen-on-v6 { any; };
};


$ cat named.conf.internal-zones
zone "test.srv" IN {
        type slave;
        file "test.srv.lan";
        # master ì„œë²„ ì£¼ì†Œ
        masters { 192.168.219.192; };
        also-notify { 192.168.219.192; };
};
zone "219.168.192.in-addr.arpa" IN {
        type slave;
        file "219.168.192.db";
        # master ì„œë²„ ì£¼ì†Œ
        masters { 192.168.219.192; };
        also-notify { 192.168.219.192; };
};


$ systemctl restart named
```

```bash
# Zone íŒŒì¼ slave ì„œë²„ë¡œ ë³µì‚¬ë˜ëŠ” ê²ƒì„ í™•ì¸
$ ls -al /var/cache/bind/ | grep -e "test" -e "219"
-rw-r--r--  1 bind bind  315 Jun 12 21:21 219.168.192.db
-rw-r--r--  1 bind bind  315 Jun 12 21:37 test.srv.lan
```

<br>

# ğŸ”” ì „ë‹¬ì DNS Server êµ¬ì„±
---

> ì „ë‹¬ìëŠ” ë„¤ì„ ì„œë²„ê°€ ì§ì ‘ í•´ì„ì„ ìˆ˜í–‰ í•˜ì§€ ì•Šê³  ì§€ì •ëœ ë‹¤ë¥¸ ë„¤ì„ì„œë²„ì˜ ì‘ë‹µì„ ë°›ì•„ í´ë¼ì´ì–¸íŠ¸ì˜ ì§ˆì˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹

+ forward

    + only : ì „ë‹¬ìì—ê²Œë§Œ ì§ˆì˜

    + first : ì „ë‹¬ìë¥¼ ìš°ì„ ìœ¼ë¡œ ì§ˆì˜

    + ì „ë‹¬ìì— ì¿¼ë¦¬ ì‹¤íŒ¨ ì‹œ root hint ì§ˆì˜

<br>

# ğŸ”” í…ŒìŠ¤íŠ¸ êµ¬ì„±
---

<br>

![231321312](https://user-images.githubusercontent.com/42735894/232965423-54190c97-7200-4f08-9377-f1889e3d7b38.png)

<br>

<big> **â–  ë§ˆìŠ¤í„° ë„¤ì„ ì„œë²„** </big>

```bash
$ cat /etc/bind/named.conf

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

# ì¶”ê°€
include "/etc/bind/named.conf.internal-zones";


$ cat /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";

        ...
        ...

        allow-query { any; };
        allow-transfer { localhost; 192.168.219.103; };

        recursion yes;

        dnssec-validation auto;

        listen-on-v6 { any; };
};


$ cat /etc/bind/named.conf.internal-zones
# ë„¤íŠ¸ì›Œí¬ ë° ë„ë©”ì¸ ì´ë¦„ì— ëŒ€í•œ Zone ì¶”ê°€
zone "test.srv" IN {
        type master;
        file "/etc/bind/named/test.srv.lan";
        allow-update { none; };
};
zone "219.168.192.in-addr.arpa" IN {
        type master;
        file "/etc/bind/named/219.168.192.db";
        allow-update { none; };
};


$ cat /etc/default/named
# IPv6ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  IPv6 ê´€ë ¨ ë¡œê·¸ë„ í‘œì‹œí•˜ì§€ ì•ŠëŠ” ê²½ìš° ë³€ê²½ ê°€ëŠ¥
# IPv4ë§Œ ì‚¬ìš©í•˜ë„ë¡ BIND ì„¤ì •
OPTIONS="-u bind -4"
```

```bash
$ mkdir named


$ cat /etc/bind/named/test.srv.lan

$TTL 86400
@   IN  SOA     dlp.test.srv. root.test.srv. (
        2022081001  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      dlp.test.srv.
        IN  A       192.168.219.101
        IN  MX 10   dlp.test.srv.

dlp     IN  A       192.168.219.101
www     IN  A       192.168.219.102
```

+ ì„œë²„ê°€ IP ì£¼ì†Œì—ì„œ ë„ë©”ì¸ ì´ë¦„ì„ í™•ì¸í•˜ëŠ” Zone íŒŒì¼ì„ ì‘ì„±

```bash
$ vim /etc/bind/named/219.168.192.db

$TTL 86400
@   IN  SOA     dlp.test.srv. root.test.srv. (
        2022081001  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      dlp.test.srv.

101     IN  PTR     dlp.test.srv.
102     IN  PTR     www.test.srv.
```

<br>

<big> **â–  ë³´ì¡° ë„¤ì„ ì„œë²„** </big>

```bash
$ cat /etc/bind/named.conf

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

# ì¶”ê°€
include "/etc/bind/named.conf.internal-zones";


$ cat /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";

        ....
        ....

        allow-query { any; };
        allow-transfer { localhost; };

        recursion yes;

        ....
        ....

        dnssec-validation auto;

        listen-on-v6 { any; };
};


$ cat /etc/bind/named.conf.internal-zones
zone "test.srv" IN {
        type slave;
        file "test.srv.lan";
        # master ì„œë²„ ì£¼ì†Œ
        masters { 192.168.219.102; };
        also-notify { 192.168.219.102; };
};
zone "219.168.192.in-addr.arpa" IN {
        type slave;
        file "219.168.192.db";
        # master ì„œë²„ ì£¼ì†Œ
        masters { 192.168.219.102; };
        also-notify { 192.168.219.102; };
};


$ systemctl restart named


# Zone íŒŒì¼ slave ì„œë²„ë¡œ ë³µì‚¬ë˜ëŠ” ê²ƒì„ í™•ì¸
$ ls -al /var/cache/bind/ | grep -e "test" -e "219"
-rw-r--r--  1 bind bind  315 Jun 12 21:21 219.168.192.db
-rw-r--r--  1 bind bind  315 Jun 12 21:37 test.srv.lan
```

<br>

<big> **â–  forward ì„œë²„** </big>

```conf
$ cat /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";

        # DNS ì¬ê·€ë¥¼ í—ˆìš©
        recursion yes; 

        # ì¬ê·€ ì¿¼ë¦¬ í—ˆìš©ì„ ì–´ë””ì„œë“  ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        allow-recursion { any; };  
        # DNS ì¡´ ì „ì†¡ì„ ë¡œì»¬í˜¸ìŠ¤íŠ¸(localhost)ì—ì„œë§Œ í—ˆìš©
        allow-transfer { localhost; };  

        # DNSSEC ê²€ì¦ ë¹„í™œì„±í™”
        dnssec-validation no;  

        # ëª¨ë“  IP ì£¼ì†Œì—ì„œ DNS ì¿¼ë¦¬ë¥¼ ìˆ˜ì‹ í•˜ë„ë¡ ì„¤ì •
        listen-on { any; };  
        listen-on-v6 { any; };  
};


$ cat /etc/bind/named.conf.local
zone "test.srv" {
    type forward;
    forward only;
    forwarders { 192.168.219.102; };
};

zone "219.168.192.in-addr.arpa" {
    type forward;
    forward only;
    forwarders { 192.168.219.102; };
};


$ systemctl restart named
```

<br>

<big> **â–  í™•ì¸** </big>

```bash
# í•„ìš”í•œ ê²½ìš° ìì‹ ì˜ DNSë¥¼ ì°¸ì¡°í•˜ë„ë¡ DNS ì„¤ì •ì„ ë³€ê²½
$ vi /etc/netplan/01-netcfg.yaml
# change to self IP address
    nameservers:
        addresses: [192.168.219.101]



$ dig www.test.srv

; <<>> DiG 9.18.12-0ubuntu0.22.04.1-Ubuntu <<>> www.test.srv
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 33371
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;www.test.srv.                  IN      A

;; ANSWER SECTION:
www.test.srv.           85492   IN      A       192.168.219.102

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Fri Jun 16 14:05:52 UTC 2023
;; MSG SIZE  rcvd: 57



$ dig -x 192.168.219.102

; <<>> DiG 9.18.12-0ubuntu0.22.04.1-Ubuntu <<>> -x 192.168.219.102
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2065
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;102.219.168.192.in-addr.arpa.  IN      PTR

;; ANSWER SECTION:
102.219.168.192.in-addr.arpa. 86400 IN  PTR     www.test.srv.

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Fri Jun 16 14:06:51 UTC 2023
;; MSG SIZE  rcvd: 83
```