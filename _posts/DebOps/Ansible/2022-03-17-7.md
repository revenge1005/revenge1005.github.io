---
title:  "[Ansible] 06. Loop (1)"

categories:
  - ANSIBLE
tags:
  - [ansible]

toc: true
toc_sticky: true

date: 2022-03-17
last_modified_at: 2022-03-17
---
[Ansible] 06. Loop (1)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

## ğŸ”” ìì„¸í•œ ëª¨ë“ˆ ë‚´ìš©ì€ ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ê³ 

> **ëª¨ë“ˆ ë‚´ìš© :** <https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html#modules><br><br>
**ì˜ˆì œ Github :** <https://github.com/revenge1005/Ansible_study>

<br>

## ğŸ”” Loop

- Ansible 2.4 ê¹Œì§€ëŠ” with_* í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—… í•˜ì˜€ëŠ”ë°, 2.5 ë¶€í„°ëŠ” loop í‚¤ì›Œë“œë¥¼ ì‚¬ìš©

- with_* ëŠ” ì—¬ëŸ¬ê°€ì§€ ë°˜ë³µë¬¸ì„ ì™„ì „íˆ ëŒ€ì²´í•˜ëŠ” ê²ƒì€ ì•„ë‹ˆì§€ë§Œ, ê±°ì˜ ëŒ€ë¶€ë¶„ loopì—ì„œë„ ìœ íš¨ í•¨

- **íŒ¨í‚¤ì§€ ê´€ë ¨ëœ ëª¨ë“ˆì€ ë°˜ë³µë¬¸ì„ ì“°ì§€ ì•Šì„ê²ƒì„ ê¶Œì¥**í•¨

<br>

## ğŸ“œ 1. Standard Loops - with_items

```bash
# with_itemsë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ loop ì§€ì •í•  ìˆìœ¼ë©°, 
# ê° ë°˜ë³µì— í•´ë‹¹í•˜ëŠ” ê°’ì€ {{ item }}ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤.

$ cat loop01.yml
---
- name: Loops Playbook
  hosts: all
  become: yes

  tasks:

  - name: add group
    group: name={% raw %}{{ item }}{% endraw %} state=present
    with_items:
     - t_group01
     - t_group02

  - name: add several users
    user: name={% raw %}{{ item.name }}{% endraw %} state=present groups={% raw %}{{ item.groups }}{% endraw %}
    with_items:
     - { name: 't_user01', groups: 't_group01' }
     - { name: 't_user02', groups: 't_group02' }
```

![image](https://user-images.githubusercontent.com/42735894/223382021-7e7907a2-35c0-4662-8cc0-5355871b7a3f.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ“œ 2. Nested Loops - with_nested

```bash
# with_nestedë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ì²© loop ì‚¬ìš©í•  ìˆ˜ ìˆìŒ.

$ cat <<EOF > loop02.yml
---
- name: Loops Playbook
  hosts: all
  become: yes

  tasks:
  - name: add several group/users
    user: name={% raw %}{{ item[0] }}{% endraw %} state=present groups={% raw %}{{ item[1] }}{% endraw %}
    with_nested:
     - [ 't_user03', 't_user04' ]
     - [ 't_group01', 't_group02' ]
EOF
```

```bash
# ì•„ë˜ì™€ ê°™ì´ ë‹¤ë¥¸ list variableì—ì„œ ì½ì–´ì˜¬ ìˆ˜ ìˆìŒ

$ cat <<EOF > loop02.yml
---
- name: Loops Playbook
  hosts: all
  become: yes

  vars:
    users:
     - t_user03
     - t_user04  

  tasks:
  - name: add several group/users
    user: name={% raw %}{{ item[0] }}{% endraw %} state=present groups={% raw %}{{ item[1] }}{% endraw %}
    with_nested:
     - "{% raw %}{{ users }}{% endraw %}"
     - [ 't_group01', 't_group02' ] 
EOF
```

![image (1)](https://user-images.githubusercontent.com/42735894/223382027-2006ae43-9ee4-47a3-83be-f5157c701791.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ“œ 3. Looping over Hashes - with_dict

```bash
# with_dictë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ users hash listì— ëŒ€í•´ì„œë„ loop ë¥¼ ëŒë¦´ ìˆ˜ ìˆìŒ.

$ cat <<EOF > loop03.yml
---
- name: Loops Playbook
  hosts: all
  become: yes

  vars:
    users:
      alice:
        name: Alice Appleworth
        telephone: 123-456-7890
      bob:
        name: Bob Bananarama
        telephone: 987-654-3210

  tasks:
  - name: Print phone records
    debug: 
     msg: "User {% raw %}{{ item.key }}{% endraw %} is {% raw %}{{ item.value.name }}{% endraw %} ({% raw %}{{ item.value.telephone }}{% endraw %})"
    with_dict: "{% raw %}{{ users }}{% endraw %}"
EOF
```

![image (2)](https://user-images.githubusercontent.com/42735894/223382028-0369d423-609a-4d56-aa18-f511a452573a.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ“œ 4. Looping over Files - with_file

```bash
# with_fileë¥¼ ì‚¬ìš©í•˜ì—¬ ëª©ë¡ì— ìˆëŠ” íŒŒì¼ì˜ ë‚´ìš©ì— ëŒ€í•´ loopë¥¼ ëŒë¦´ ìˆ˜ ìˆìŒ. 
# {{ item }}ì€ ê° iteration fileì˜ contentsë¥¼ ê°€ë¦¬í‚´.

$ cat loop04.yml
---
- name: Loops Playbook
  hosts: all
  become: yes

  tasks:
  # ê° íŒŒì¼ì˜ ë‚´ìš©ì´ í¬í•¨ëœ ë””ë²„ê·¸ ë©”ì‹œì§€ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
  - name: Check the file contents
    debug: msg={% raw %}{{ item }}{% endraw %}
    with_file:
      - "~/test/test01.txt"
      - "~/test/test02.txt"
```

![image (3)](https://user-images.githubusercontent.com/42735894/223382395-80fe505b-abc7-403e-90e2-7f2ef123f4c4.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ“œ 5. Looping over Fileglobs - with_fileglob

```bash
# í•˜ë‚˜ì˜ ë””ë ‰í† ë¦¬ í•˜ì— ìˆëŠ” íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  íŒŒì¼ pathì— ëŒ€í•´ loopë¥¼ ëŒë¦´ ìˆ˜ ìˆìŒ.
# ìƒëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©í•  ë•Œì—ëŠ” ì£¼ì˜ê°€ í•„ìš”í•˜ë‹¤
# (role ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì ˆëŒ€ ê²½ë¡œê°€ role ê¸°ì¤€ìœ¼ë¡œ ë°”ë€œ)

$ tree
.
â”œâ”€â”€ files
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ test01.txt
â”‚   â”œâ”€â”€ test02.txt
â”‚   â”œâ”€â”€ test03.txt
â”‚   â”œâ”€â”€ test04.txt
â”‚   â””â”€â”€ test05.txt
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ inventory
â””â”€â”€ loop5.yml

$ cat <<EOF > loop05.yml
---
- name: Loops Playbook
  hosts: node01
  become: yes

  vars:
    s_folder: /root/ansible_test/files
    d_folder: /home/choi/

  tasks:
  - name: Copy File
    copy:
      src: "{% raw %}{{ item }}{% endraw %}"
      dest: "{% raw %}{{ d_folder }}{% endraw %}"
      mode: 0555
    with_fileglob: "{% raw %}{{ s_folder }}{% endraw %}/*"
EOF
```

![image (4)](https://user-images.githubusercontent.com/42735894/223382793-322f7616-3a13-41c0-9af5-46afcbd27cb9.png){: width="100%" height="100%"}{: .align-center}

<br>