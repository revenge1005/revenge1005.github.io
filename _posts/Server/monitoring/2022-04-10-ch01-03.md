---
title:  "[Monitoring] 03. 프로메테우스 - Target 노드 추가, 경고 알림 설정" 

categories:
  - MONITORING
tags:
  - [linux, monitoring]

toc: true
toc_sticky: true

date: 2022-04-10
last_modified_at: 2022-04-10
---
<br>

# 01. 프로메테우스 - Target 노드 추가 (node_exporter 설치)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
small { 
    font-size: 18px 
}
</style>

+ node exporter는 Linux 시스템의 메트릭 데이터(CPU/Memory/Disk/Network Traffic 등)를 수집하고, 제공한다.

+ https://prometheus.io/download/#node_exporter

<br>

<big> **■ node_exporter 사용자 생성** </big> <br>

```bash
useradd -m -s /bin/false node_exporter
```

<br>

<big> **■ node_exporter 패키지 다운로드** </big> <br>

```bash
{
    wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
    tar -zxpvf node_exporter-1.6.1.linux-amd64.tar.gz
    cp node_exporter-1.6.1.linux-amd64/node_exporter /usr/local/bin/
    chown node_exporter:node_exporter /usr/local/bin/node_exporter
}
```

<br>

<big> **■ 서비스 파일 생성** </big> <br>

```bash
cat <<EOF > /etc/systemd/system/node_exporter.service
[Unit]
Description=Prometheus Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF

{
    systemctl daemon-reload
    systemctl enable node_exporter --now
    systemctl status node_exporter
    netstat -nlp | grep 9100
}
```

<br>

<big> **■ 방화벽 설정** </big> <br>

```bash
{
	firewall-cmd --add-port=9100/tcp --permanent
	firewall-cmd --reload
}
```

<br>

<big> **■ node_exporter 노드 정보 추가 (프로메테우스 서버)** </big> <br>

```bash
vi /etc/prometheus/prometheus.yml

# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

  # 추가
  - job_name: "node"
    static_configs:
    - targets: ["localhost:9100", "node01.test.srv:9100"]

  # 추가
  - job_name: "Test"
    static_configs:
    - targets: ["node01.test.srv:9100"]
```

<br>

<big> **■ prometheus 서비스를 재기동** </big> <br>

```bash
systemctl restart prometheus
```

<br>

<big> **■ [Status] - [Targets]를 클릭하여 새 노드가 나열되는지 확인** </big> <br>

![77777](https://github.com/revenge1005/WEB-Server-3-Tier-Architecture/assets/42735894/d3a88484-ef19-466f-b724-27bf1994c734){: width="80%" height="80%"}{: .align-center}

<br>

# 02. 프로메테우스 - 경고 알림 설정
---

