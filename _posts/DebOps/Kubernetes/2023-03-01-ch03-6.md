---
title:  "[KUBERNETES] 15. 워크로드 API - 스테이트풀셋" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [KUBERNETES] 15. 워크로드 API - 스테이트풀셋
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## 🔔 시작하기 전 ...

> 레플리카셋은 파드 복제본을 생성할 때 이름 및 주소만 다를 뿐 나머지는 모두 똑같은 파드를 생성된다. <br><br>
만약 <u>파드가 PVC를 참조한다면 이 역시 똑같은 PVC를 연결하게 되고 해당 PVC는 특정 하나의 PV에 연결한다.</u> **(즉, 항상 똑같은 볼륨에 연결한다는 의미)**

![1](https://user-images.githubusercontent.com/42735894/225531010-9f3d1495-5286-4e3c-9898-b767f4d05e56.png){: width="100%" height="100%"}{: .align-center} <br>

- 레플리카셋이 제공하는 파드는 <u>각 별도의 볼륨을 사용할 수 있는 방법을 제공해주지 않아 모두 같은 볼륨으로 같은 상태를 가질수 밖에 없었다</u>.

- 또한 데이터베이스처럼 상태를 갖는(Stateful) 애플리케이션을 쿠버네티스에서 실행하는 것은 매우 복잡한 일이다.

    - 파드 내부의 데이터를 어떻게 관리해야 할지, 상태를 갖는 파드에는 어떻게 접근할 수 있을지 등을 꼼꼼히 고려해야 하기 때문이다.

    - 쿠보네티스는 이에 대한 <u>해결책을 스테이트풀셋이라는 오브젝트를 제공</u>하고 있다.

<br>

## 🔔 스테이트풀셋

> 스테이트풀셋은 상태를 가지고 있는(statefull) 애플리케이션을 관리하는데 사용하기 위한 리소스

- Stateful 애플리케이션 : 애플리케이션의 실행 상태나 사용자의 입력 등을 저장하고 유지하는 애플리케이션

- Stateless 애플리케이션 : 사용자의 요청에 따라 결과를 반환하거나 처리하는데만 집중하는 애플리케이션

<br>

### 📜 스테이트풀셋 특징

#### 【스테이트풀셋은 파드들의 순서와 고유성을 보장함】

- 각 파드는 고유한 이름과 네트워크 식별자를 가지며, 스테이트풀셋에 속한 파드들은 순차적으로 생성 및 삭제된다.

#### 【스테이트풀셋은 안정적인 지속성을 갖는 각각 고유한 스토리지를 제공함】

- 각 파드는 자신에게 할당된 퍼시스턴트 볼륨을 사용하며, 파드가 재생성되어도 데이터를 유지할 수 있다.

#### 【스테이트풀셋은 롤링 업데이트 전략을 통해 파드들을 순차적으로 삭제하고 재생성이 가능함】

- 이때 가장 큰 순서 색인에서부터 작은 순서 색인쪽으로 업데이트가 진행되며, 한 번에 하나씩 업데이트된다.

<br>

### 📜 스테이트풀셋 주의사항

#### 【파드에 사용할 스토리지는 PVC를 통해서만 가능하다.】

- 미리 PV를 생성해놓거나 StorageClass를 사용해 동적 프로비저닝을 사용

#### 【스테이트풀셋을 삭제하거나 파드를 삭제하더라도 볼륨은 삭제되지 않는다.】**

- **데이터의 안전을 보장**하기 위해서 스테이트풀셋 관리하의 파드가 분실하는 경우, 동일한 이름으로 새롭게 파드가 기동되며 이때 기존 파드가 사용했던 퍼시스턴트 볼륨을 이어서 사용한다.

- **특정 노드가 연결이 끊어졌을 때 스테이트풀셋은 새로운 파드를 기동하지 않는다.** 만약 마스터와의 통신이 일시적으로 끊겼지만 파드는 계속해서 돌아가고 있는 경우, 마스터가 대체 파드를 기동하여 퍼시스턴트 볼륨을 마운트하게 되면 오히려 데이터가 파손될 수 있기 때문이다.

- 다음 중 한 가지 경우에만 스테이트풀셋이 분실된 파드를 다른 노드에서 다시 기동한다.

    - 장애 노드를 K8s 클러스터의 맴버에서 제외함

    - 문제가 있는 파드를 강제 종료함

    - 장애로 인해 정지한 노드를 재기동함

#### 【헤드리스 서비스 필요】

- Service는 기본적으로 레이블 셀렉터가 일치하는 랜덤한 파드를 선택해 트래픽을 전달하기 때문에 요청을 분산시키지만, 스테이트풀셋의 각 파드는 고유하게 식별되어야하며, 포드에 접근할 때에도 개별 파드에 접근해야 한다.

- 헤드리스 서비스는 **ClusterIP가 없는 서비스를 의미하며, 각 파드에 고유한 DNS 이름을 부여**할 수 있어 파드에 직접 접근할 수 있다.

- 헤드리스 서비스는 로드밸런싱이나 단일 서비스 IP가 필요하지 않을 경우에 사용된다.

<br>

### 📜 스테이트풀셋의 파드 이름

```bash
# 파드 이름 형식
{StatefulSet-Name}-{Order}

# 예시
mysql-0
mysql-1
```

<br>

### 📜 스테이트풀셋의 파드 DNS 주소

```bash
# 헤드리스 서비스와 스테이트풀셋을 같이 사용한 경우, 파드의 DNS 주소 형식
# Governing-Service-Domain은 statefulset.spec.serviceName에 선언하며 해당 필드에 헤드리스 서비스의 이름을 지정함
{Pod-Name}.{Governing-Service-Domain}.{Namespace}.svc.cluster.local

# 예시
mysql-0.mysql.default.svc.cluster.local
mysql-1.mysql.default.svc.cluster.local
```