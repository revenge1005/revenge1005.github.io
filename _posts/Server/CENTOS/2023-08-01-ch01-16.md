---
title:  "[CentOS] 14. WEB(Apache) + WAS(PHP) + DB(MariaDB)" 

categories:
  - CENTOS
tags:
  - [centos, linux]

toc: true
toc_sticky: true

date: 2023-05-23
last_modified_at: 2023-10-23
---
<br>

# ğŸ”” WEB êµ¬ì„±ìš”ì†Œ
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

![www](https://github.com/revenge1005/kubernetes_build_ansible_playbook/assets/42735894/a3a86ff9-2509-4165-80be-7bde890f3b77)

|êµ¬ì„±ìš”ì†Œ|ì„¤ëª…|
|:---:|:---|
|WEB ì„œë²„|ì •ì ì¸ ì»¨í…ì¸ (ë¬¸ì, ê·¸ë¦¼, ì˜¤ë””ì˜¤, ë¹„ë””ì˜¤ ë“±)ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì„œë²„|
|WAS ì„œë²„|ë™ì ì¸ ì»¨í…ì¸ (ì‚¬ìš©ìì˜ ì…ë ¥ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡œê·¸ë¨ì˜ ë™ì‘ì´ ë‹¬ë¼ ì§)ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì„œë²„|
|DB ì„œë²„|ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±, ê´€ë¦¬, ì‚¬ìš©, ì œì–´í•˜ëŠ” ì„œë²„|

<br>

# 02) ì„œë²„ ì •ë³´
---

![333223](https://user-images.githubusercontent.com/42735894/236788668-c4e0a9ef-fe97-4a70-850a-7f2bf67c1022.PNG){: width="100%" height="100%"}

![3213](https://user-images.githubusercontent.com/42735894/236788943-63ad04dc-95cd-4c82-a026-98b878d6af70.png){: width="100%" height="100%"}

<br>

# 03) ì„œë²„ êµ¬ì„±
---

<br>

## a) WAS Server - JAVA, Tomcat install

```bash
# /etc/hostsì— ì„œë²„ IP ì£¼ì†Œ ì •ë³´ ì¶”ê°€
$ cat <<EOF >> /etc/hosts

192.168.219.100 web
192.168.219.111 was01
192.168.219.200 db
EOF
```

```bash
# JAVA install - https://jdk.java.net/
$ yum -y install wget 

$ { 
    wget https://download.java.net/openjdk/jdk8u43/ri/openjdk-8u43-linux-x64.tar.gz
    tar xvzf openjdk-8u43-linux-x64.tar.gz
    mkdir /usr/local/jvm
    mv java-se-8u43-ri /usr/local/jvm/
}

$ cat <<EOF >> /etc/profile

JAVA_HOME=/usr/local/jvm/java-se-8u43-ri/
export JAVA_HOME
PATH=\$PATH:\$JAVA_HOME/bin
export PATH
EOF

$ source /etc/profile

# í™•ì¸
$ java -version
```

```bash
# Tomcat install - https://tomcat.apache.org/
$ {
    wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.82/bin/apache-tomcat-9.0.82.tar.gz
    tar xvzf apache-tomcat-9.0.82.tar.gz
    mv apache-tomcat-9.0.82 /usr/local/tomcat9
}

$ cat <<EOF > /usr/lib/systemd/system/tomcat.service
[Unit]
Description=tomcat9
After=network.target syslog.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/local/jvm/java-se-8u43-ri/
User=root
Group=root

ExecStart=/usr/local/tomcat9/bin/startup.sh
ExecStop=/usr/local/tomcat9/bin/shutdown.sh

UMask=0007
RestartSec=10
Restart=always

SuccessExitStatus=143

[Install]
WantedBy=multi-user.target
EOF

# SELinuxëŠ” ExecStartì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ system_u:object_r:bin_t:s0 ì†ì„±ì´ ì„¤ì •ëœ ê²½ë¡œ(/usr/bin, /usr/sbin, /usr/libexec, /usr/local/bin)ë¡œ ì œí•œí•œë‹¤.
# ì´ ë””ë ‰í† ë¦¬ ì¤‘ í•˜ë‚˜ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ë™í•˜ê±°ë‚˜ systemdê°€ ì›í•˜ëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ selinux ì •ì±…ì„ ë³€ê²½í•´ì•¼ í•œë‹¤. (SELinux ë¹„í™œì„±í™”í•˜ë©´ í¸í•¨...)
# ì°¸ê³  - https://serverfault.com/questions/1032597/selinux-is-preventing-from-execute-access-on-the-file-centos
$ chcon -R -t bin_t /usr/local/tomcat9/bin/

$ systemctl enable --now tomcat

$ netstat -anlp | grep 8080
tcp6       0      0 :::8080                 :::*                    LISTEN      2039/java

# ë°©í™”ë²½ ì„¤ì •
$ {
    firewall-cmd --add-service=http
    firewall-cmd --add-port=8080/tcp
    firewall-cmd --add-port=8009/tcp
    firewall-cmd --add-port=3306/tcp
    firewall-cmd --runtime-to-permanent
    # Apacheê°€ SELinuxë¥¼ í†µí•´ ì›ê²© ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ë„ë¡ í—ˆìš©
    setsebool -P httpd_can_network_connect_db 1
}
```

<br>

## b) WEB Server - Apache install and configuration

```bash
# /etc/hostsì— ì„œë²„ IP ì£¼ì†Œ ì •ë³´ ì¶”ê°€
$ cat <<EOF >> /etc/hosts

192.168.219.100 web
192.168.219.111 was01
192.168.219.200 db
EOF
```

```bash
# Tomcat Connectors (mod_jk) Downloads
# https://tomcat.apache.org/download-connectors.cgi
$ {
    yum -y install httpd httpd-devel gcc gcc-c++ wget redhat-rpm-config make
    wget https://dlcdn.apache.org/tomcat/tomcat-connectors/jk/tomcat-connectors-1.2.49-src.tar.gz
    tar xvzf tomcat-connectors-1.2.49-src.tar.gz
    cd tomcat-connectors-1.2.49-src/native/
    ./configure --with-apxs=/bin/apxs
    make && make install
}
```

```bash
# Apache ì„¤ì •
$ vim /etc/httpd/conf/httpd.conf

# line 58
LoadModule jk_module modules/mod_jk.so

<VirtualHost *:80>
        ServerName localhost
        JkMount /*.jsp tomcat1
</VirtualHost>

$ cat <<EOF > /etc/httpd/conf.modules.d/mod_jk.conf
<IfModule jk_module>
    JkWorkersFile conf/workers.properties
    JkLogFile logs/mod_jk.log
    JkLogLevel info
    JkLogStampFormat "[%a %b %d %H:%M:%S %Y] "
</IfModule>
EOF

$ cat <<EOF > /etc/httpd/conf/workers.properties
worker.list=tomcat1

worker.tomcat1.type=ajp13
worker.tomcat1.host=192.168.219.111
worker.tomcat1.port=8009
EOF
```

<br>

## c) WAS Server - tomcat configure

```bash
$ vim /usr/local/tomcat9/conf/server.xml

# line 115 
<Connector protocol="AJP/1.3"
           address="0.0.0.0"
           secretRequired="false"
           port="8009"
           redirectPort="8443" />

# line 131 "jvmRoute=tomcat1" add
<Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat1">

# line 150 - tomcat home directory 
<Host name="localhost"  appBase="webapps"
    unpackWARs="true" autoDeploy="true">

    <Context path="" docBase="source" reloadable="true" />

$ mkdir /usr/local/tomcat9/webapps/source

$ cat << EOF > /usr/local/tomcat9/webapps/source/index.jsp
Hello World
EOF
```

```bash
$ systemctl restart tomcat

$ netstat -anlp | grep 8080

$ netstat -anlp | grep 8009
```

<br>

## d) WEB Server - ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ë° ë°©í™”ë²½ ì„¤ì •

```bash
$ {
    systemctl restart httpd
    cat /var/log/httpd/mod_jk.log
    firewall-cmd --add-service=http
    firewall-cmd --add-port=8080/tcp
    firewall-cmd --add-port=8009/tcp
    firewall-cmd --runtime-to-permanent
    # Apacheê°€ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
    setsebool -P httpd_can_network_connect on
}

# SELinuxê°€ í™œì„±í™” ë˜ì–´ìˆëŠ” ê²½ìš°, ìœ„ ì„¤ì • í›„ 'systemctl restart httpd' ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ httpd ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

# /var/log/message ë¡œê·¸ íŒŒì¼ì„ ë³´ë©´, SELinuxê°€ /var/log/httpd/jk-runtime-status íŒŒì¼ì— ëŒ€í•œ httpdì˜ ì“°ê¸° ì•¡ì„¸ìŠ¤ë¥¼ ì°¨ë‹¨í•˜ê³  ìˆìŒì„ ì•Œë ¤ì¤€ë‹¤.
SELinux is preventing /usr/sbin/httpd from write access on the file /var/log/httpd/jk-runtime-status.1630. 

# í•´ë‹¹ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ëª…ë ¹ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤.
# /var/log/httpd/ ë””ë ‰í† ë¦¬ì™€ ê·¸ í•˜ìœ„ ë””ë ‰í† ë¦¬ì˜ SELinux ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ httpd_sys_rw_content_të¡œ ë³€ê²½
# ì¦‰, httpd ì›¹ ì„œë²„ê°€ ì“°ê¸° ê¶Œí•œì„ ê°€ì§€ëŠ” ë¡œê·¸ íŒŒì¼ì— ëŒ€í•œ ì ì ˆí•œ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µ
chcon -R -t httpd_sys_rw_content_t /var/log/httpd/

$ systemctl restart httpd
```

<br>

## e) DB Server - MariaDB Install

```bash
# MariaDB ì„¤ì¹˜
$ yum -y install mariadb-server mariadb
```

```bash
# ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì‹œì‘(start)í•˜ë„ë¡ ì§€ì •
$ systemctl enable --now mariadb

# ë°©í™”ë²½ í—ˆìš©
$ firewall-cmd --add-port=3306/tcp
```

```bash
# MariaDB ì„¤ì •
$ mysql_secure_installation
```

```bash
# test ìš© DB ìƒì„±
$ mysql -u root -p

$ create database test;

# ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©
$ GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'PASSWORD';

$ exit;
```

<br>

## f) WAS Server - DB Connectation Check

```bash
# https://downloads.mysql.com/archives/c-j/
{ 
    wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-8.0.26.tar.gz
    tar xvzf mysql-connector-java-8.0.26.tar.gz
    cd mysql-connector-java-8.0.26
    cp mysql-connector-java-8.0.26.jar /usr/local/tomcat9/lib/
}
```

```bash
systemctl restart tomcat

netstat -anlp | grep 8080

netstat -anlp | grep 8009
```

```bash
vim /usr/local/tomcat9/webapps/source/db.jsp

<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8" import="java.sql.*"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
 <html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>DB Connection Test</title>
</head>
<body>
        <%
                String DB_URL = "jdbc:mysql://192.168.219.200:3306/test";
                String DB_USER = "root";
                String DB_PASSWORD= "1234";

                Connection conn;
                Statement stmt;

                try {
                        Class.forName("com.mysql.jdbc.Driver");
                        conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
                        stmt = conn.createStatement();
                        conn.close();
                        out.println("MySql jdbc test: connect ok!!");
                } catch(Exception e) {
                        out.println(e.getMessage());
                }
        %>
</body>
</html>
```