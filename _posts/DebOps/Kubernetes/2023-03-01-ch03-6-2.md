---
title:  "[Retry, k8s] 06-2. (Heketi + GlusterFS) 스토리지 시스템 마운트 확인" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 06-2. (Heketi + GlusterFS) 스토리지 시스템 마운트 확인
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## 🔔 gfs-sc.yml / gfs-pvc.yml 작성 

<br>

### 📜 gfs-sc.yml

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: "gluster-heketi"
provisioner: kubernetes.io/glusterfs
parameters:
  resturl: "http://192.168.219.200:8080"
  restuser: "admin"
  restuserkey: "keypassword"
  volumetype: "none"
```

<br>

### 📜 gfs-pvc.yml

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
 name: gvol-1
spec:
 storageClassName: gluster-heketi
 accessModes:
  - ReadWriteOnce
 resources:
   requests:
     storage: 2Gi
```

<br>

### 📜 결과 확인

```bash
$ kubectl apply -f gfs-sc.yml
storageclass.storage.k8s.io/gluster-heketi created

$ kubectl apply -f gfs-pvc.yml
persistentvolumeclaim/gvol-1 created

$ kubectl get sc,pvc,pv
NAME                                         PROVISIONER               RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
storageclass.storage.k8s.io/gluster-heketi   kubernetes.io/glusterfs   Delete          Immediate           false                  3m50s

NAME                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS     AGE
persistentvolumeclaim/gvol-1   Bound    pvc-ddfacba8-af3a-4800-97b8-fa4d16547e55   10Gi       RWO            gluster-heketi   3m47s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM            STORAGECLASS     REASON   AGE
persistentvolume/pvc-ddfacba8-af3a-4800-97b8-fa4d16547e55   10Gi       RWO            Delete           Bound    default/gvol-1   gluster-heketi            3m42s
```

<br>

## 🔔 GlusterFS을 적용한 파드 기동

<br>

#### 📜 gfs-pvc.yml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gfs-client
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ubuntu
  template:
    metadata:
      labels:
        app: ubuntu
    spec:
      containers:
      - name: ubuntu
        image: ubuntu
        volumeMounts:
        - name: gfs
          mountPath: /mnt
        command: ["/usr/bin/tail","-f","/dev/null"]
      volumes:
      - name: gfs
        persistentVolumeClaim:
          claimName: gvol-1
```

<br>

#### 📜 결과 확인

```bash
$ kubectl get pod
NAME                          READY   STATUS    RESTARTS   AGE
gfs-client-6557c98dbd-cpqwd   1/1     Running   0          6s
gfs-client-6557c98dbd-vznk2   1/1     Running   0          6s


## 첫 번째 파드
$ kubectl exec -it gfs-client-6557c98dbd-cpqwd bash
root@gfs-client-6557c98dbd-cpqwd:/# df -h
Filesystem                                            Size  Used Avail Use% Mounted on
overlay                                               9.8G  2.6G  6.8G  28% /
tmpfs                                                  64M     0   64M   0% /dev
tmpfs                                                 980M     0  980M   0% /sys/fs/cgroup
192.168.219.201:vol_d97ad92869bbafbfb71d2e5e3210d21e   10G  207M  9.8G   3% /mnt
/dev/mapper/ubuntu--lvm-var                           9.8G  2.6G  6.8G  28% /etc/hosts
shm                                                    64M     0   64M   0% /dev/shm
tmpfs                                                 1.9G   12K  1.9G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                                 980M     0  980M   0% /proc/acpi
tmpfs                                                 980M     0  980M   0% /proc/scsi
tmpfs                                                 980M     0  980M   0% /sys/firmware

root@gfs-client-6557c98dbd-cpqwd:/# ls -lR / > /mnt/test.dat

root@gfs-client-6557c98dbd-cpqwd:/# md5sum /mnt/test.dat
fb22dcbcde6b282e21bf77784a99bf5b  /mnt/test.dat



## 두 번째 파드
$ kubectl exec -it gfs-client-6557c98dbd-vznk2 bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
groups: cannot find name for group ID 2000
root@gfs-client-6557c98dbd-vznk2:/# df -h
Filesystem                                            Size  Used Avail Use% Mounted on
overlay                                               9.8G  2.4G  6.9G  26% /
tmpfs                                                  64M     0   64M   0% /dev
tmpfs                                                 980M     0  980M   0% /sys/fs/cgroup
192.168.219.202:vol_d97ad92869bbafbfb71d2e5e3210d21e   10G  207M  9.8G   3% /mnt
/dev/mapper/ubuntu--lvm-var                           9.8G  2.4G  6.9G  26% /etc/hosts
shm                                                    64M     0   64M   0% /dev/shm
tmpfs                                                 1.9G   12K  1.9G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                                 980M     0  980M   0% /proc/acpi
tmpfs                                                 980M     0  980M   0% /proc/scsi
tmpfs                                                 980M     0  980M   0% /sys/firmware

root@gfs-client-6557c98dbd-vznk2:/# md5sum /mnt/test.dat
fb22dcbcde6b282e21bf77784a99bf5b  /mnt/test.dat
```