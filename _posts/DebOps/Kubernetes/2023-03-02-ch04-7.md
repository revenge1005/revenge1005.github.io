---
title:  "[Retry, k8s] 16. ì„œë¹„ìŠ¤ API - í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 16. ì„œë¹„ìŠ¤ API - í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤

> **í´ëŸ¬ìŠ¤í„° IPê°€ ì—†ëŠ” ì„œë¹„ìŠ¤**


+ ë¡œë“œë°¸ëŸ°ì‹±ì´ í•„ìš”ì—†ê±°ë‚˜ ë‹¨ì¼ ì„œë¹„ìŠ¤ IPê°€ í•„ìš” ì—†ëŠ” ê²½ìš°ì— í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.

  + ì˜ˆë¥¼ ë“¤ì–´, DBì™€ ê°™ì´ ë§ˆìŠ¤í„°/ìŠ¬ë ˆì´ë¸Œ êµ¬ì¡°ê°€ ìˆëŠ” ì„œë¹„ìŠ¤ë“¤ì˜ ê²½ìš° ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ë¡œë“œë°¸ëŸ°ì‹±ì„ í•˜ì§€ ì•Šê³  ê°œë³„ íŒŒë“œì˜ ì£¼ì†Œë¥¼ ì•Œê³  ì ‘ì†í•´ì•¼ í•˜ëŠ”ë°, ì´ëŸ° ê²½ìš° í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ëŠ” ì„œë¹„ìŠ¤ì˜ ì´ë¦„ìœ¼ë¡œ íŒŒë“œì˜ ì ‘ê·¼ ìœ„ì¹˜ë¥¼ ì•Œì•„ë‚´ê¸° ìœ„í•´ ì‚¬ìš©ë˜ë©° ì„œë¹„ìŠ¤ì˜ ì´ë¦„ê³¼ íŒŒë“œì˜ ì´ë¦„ì„ í†µí•´ì„œ íŒŒë“œì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤. 

  + ì´ëŸ¬í•œ ì´ìœ ë¡œ í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ìŠ¤í…Œì´íŠ¸í’€ì…‹ì—ì„œ ì‚¬ìš©ëœë‹¤.


+ IP ì£¼ì†Œê°€ ì—†ê¸° ë•Œë¬¸ì— ë¡œë“œ ë°¸ëŸ°ì‹± ë˜ëŠ” í”„ë¡ì‹œê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë©°, <u>DNS ë¼ìš´ë“œ ë¡œë¹ˆì„ ì‚¬ìš©í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µ</u>í•œë‹¤. 

  + ëª©ì ì§€ íŒŒë“œ IP ì£¼ì†Œê°€ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ DNSì—ì„œ ë°˜í™˜ë˜ëŠ” í˜•íƒœë¡œ ë¶€í•˜ ë¶„ì‚°ì„ í•˜ê¸° ë•Œë¬¸ì— <u>í´ë¼ì´ì–¸íŠ¸ì—ì„œ DNS ìºì‹œë¥¼ ì£¼ì˜</u>í•´ì•¼ í•œë‹¤.


![12](https://user-images.githubusercontent.com/42735894/229305873-4ef39736-a38d-4409-af00-19241c53866d.png){: width="90%" height="90%"}{: .align-center}


<br>

### ğŸ“œ í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ ìƒì„±

> í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ (1), (2) ì¡°ê±´ì„ ë§Œì¡±í•œë‹¤.

|ì¡°ê±´|ì„¤ëª…|
|:---:|---|
|(1)|ì„œë¹„ìŠ¤ì˜ spec.typeì´ ClusterIPì¼ ê²ƒ|
|(2)|ì„œë¹„ìŠ¤ì˜ spec.clusterIPê°€ Noneì¼ ê²ƒ|
|(3)|<u>ìŠ¤í…Œì´íŠ¸í’€ì…‹ìœ¼ë¡œ ìƒì„±ëœ íŒŒë“œëª…ìœ¼ë¡œ ë””ìŠ¤ì»¤ë²„ë¦¬í•˜ëŠ” ê²½ìš°</u>, metadata.nameì´ ìŠ¤í…Œì´íŠ¸í’€ì…‹ì˜ spec.serviceNameê³¼ ê°™ì„ ê²ƒ|

```bash
$ cat <<EOF > sample-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: sample-headless
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: "http-port"
    protocol: "TCP"
    port: 80
    targetPort: 80
  selector:
    app: sample-app
EOF
```

```bach
$ cat <<EOF > sample-statefulset-headless.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sample-statefulset-headless
spec:
  serviceName: sample-headless
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name : nginx-container
        image: amsy810/echo-nginx:v2.0
EOF
```

<br>

```bash
$ kubectl get pod -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP          NODE         NOMINATED NODE   READINESS GATES
sample-statefulset-headless-0   1/1     Running   0          34s   10.46.0.1   k8s-node02   <none>           <none>
sample-statefulset-headless-1   1/1     Running   0          27s   10.40.0.2   k8s-node01   <none>           <none>
sample-statefulset-headless-2   1/1     Running   0          19s   10.46.0.2   k8s-node02   <none>           <none>
root@k8s-master:~/test#


# ì„œë¹„ìŠ¤ ì´ë¦„ í•´ì„ - "ì„œë¹„ìŠ¤ëª….ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëª….svc.cluster.local"
# ìŠ¤í…Œì´íŠ¸í’€ì…‹ì˜ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ì—ì„œ DNS ë¼ìš´ë“œ ë¡œë¹ˆìœ¼ë¡œ IP ì£¼ì†Œë¥¼ ë°˜í™˜
$ kubectl run --image=amsy810/tools:v2.0 --restart=Never --rm -i testpod --command -- dig sample-headless.default.svc.cluster.local

(ìƒëµ)

;; QUESTION SECTION:
;sample-headless.default.svc.cluster.local. IN A

;; ANSWER SECTION:
sample-headless.default.svc.cluster.local. 30 IN A 10.40.0.2
sample-headless.default.svc.cluster.local. 30 IN A 10.46.0.2
sample-headless.default.svc.cluster.local. 30 IN A 10.46.0.1
```

<br>

> í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ DNSì—ì„œ íŒŒë“œëª…ìœ¼ë¡œ ì´ë¦„ì„ í•´ì„ì„ í•  ìˆ˜ ì—†ê²Œ ë˜ì–´ ìˆë‹¤.

+ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ ClusterIP ë“±ê³¼ ê°™ì€ ì—¬ëŸ¬ íŒŒë“œì— ëŒ€í•´ ì—”ë“œí¬ì¸íŠ¸ê°€ í• ë‹¹ë˜ì–´ ê·¸ ì—”ë“œí¬ì¸íŠ¸ì˜ ì´ë¦„ í•´ì„ì€ ì œê³µë˜ì§€ë§Œ, ê°œë³„ íŒŒë“œëª…ì—ì„œ ì´ë¦„ í•´ì„ì€ í•  ì„œ ì—†ë‹¤.

> ìŠ¤í…Œì´íŠ¸í’€ì…‹ì´ í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ì„œë¹„ìŠ¤ì˜ metadata.nameì´ ìŠ¤í…Œì´íŠ¸í’€ì…‹ì˜ spec.serviceNameê³¼ ê°™ì€ ê²½ìš° ì¶”ê°€ë¡œ ë‹¤ìŒê³¼ ê°™ì´ íŒŒë“œ ë‹¨ìœ„ì˜ ì´ë¦„ì„ í•´ì„í•  ìˆ˜ ìˆë‹¤.

+ "íŒŒë“œëª….ì„œë¹„ìŠ¤ëª….ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëª….svc.cluster.local"


```bash
# íŒŒë“œëª…ìœ¼ë¡œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
$ kubectl run --image=amsy810/tools:v2.0 --restart=Never --rm -i testpod --command \
> -- dig sample-statefulset-headless-0.sample-headless.default.svc.cluster.local

(ìƒëµ)

;; QUESTION SECTION:
;sample-statefulset-headless-0.sample-headless.default.svc.cluster.local. IN A

;; ANSWER SECTION:
sample-statefulset-headless-0.sample-headless.default.svc.cluster.local. 30 IN A 10.46.0.1
```

<br>

> ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ resolv.conf ë“±ì—ëŠ” search ì§€ì‹œìë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì—”íŠ¸ë¦¬ê°€ ë“¤ì–´ ìˆì–´ "íŒŒë“œëª….ì„œë¹„ìŠ¤ëª…", "íŒŒë“œëª….ì„œë¹„ìŠ¤ëª….ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëª…"ìœ¼ë¡œë„ ì§ˆì˜í•  ìˆ˜ ìˆë‹¤.

```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ resolv.conf í™•ì¸
$ kubectl run --image=amsy810/tools:v2.0 --restart=Never --rm -i testpod --command -- cat /etc/resolv.conf
nameserver 10.96.0.10
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5
pod "testpod" deleted
```

<br>

### ğŸ“œ ìŠ¤í…Œì´íŠ¸í’€ì…‹ ì™¸ì˜ íŒŒë“œëª…ìœ¼ë¡œ ì´ë¦„ í•´ì„

> **ìŠ¤í…Œì´íŠ¸í’€ì…‹ì˜ ê²½ìš°ë§Œ íŒŒë“œëª…ìœ¼ë¡œ ì´ë¦„ í•´ì„ì´ ê°€ëŠ¥í•˜ë‹¤ê³  í–ˆì§€ë§Œ, íŒŒë“œì— ì„¤ì •ì„ ì¶”ê°€í•˜ì—¬ íŒŒë“œëª…ìœ¼ë¡œ ì´ë¦„ì„ í•´ì„í•  ìˆ˜ ìˆë‹¤.**

+ íŒŒë“œì˜ spec.hostnameê³¼ í—¤ë“œë¦¬ì‹œ ì„œë¹„ìŠ¤ëª…ê³¼ ë™ì¼í•œ spec.subdomain ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.(ì´ë•Œ, spec.hostnameì€ íŒŒë“œëª… ì•„ë‹ˆì—¬ ëœë‹¤.)

```bash
cat <<EOF > sample-subdomain.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-subdomain
  labels:
    app: sample-app
spec:
  hostname: sample-hostname
  subdomain: sample-subdomain
  containers:
  - name: nginx-container
    image: amsy810/tools:v2.0
  
---

apiVersion: v1
kind: Service
metadata:
  name: sample-subdomain
spec:
  type: ClusterIP
  clusterIP: None
  ports: []
  selector:
    app: sample-app
EOF
```

<br>

> "Hostnameëª….subdomain/ì„œë¹„ìŠ¤ëª….ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëª….svc.cluster.local"

+ ë””í”Œë¡œì´ë¨¼íŠ¸ ë“±ì—ì„œ ì„¤ì •ì„ í•  ê²½ìš°, ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì¡°ìƒ ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ì—ì„œ ê°™ì€ hostnameë§Œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

+ ë˜í•œ, ê°™ì€ hostnameì´ ì§€ì •ëœ ê²½ìš°ëŠ” í•˜ë‚˜ì˜ A ë ˆì½”ë“œë§Œ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì— ë””í”Œë¡œì´ë¨¼íŠ¸ ë“±ì—ëŠ” ê°œë³„ íŒŒë“œëª…ìœ¼ë¡œ ì´ë¦„ í•´ì„ì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.

```bash
$ kubectl get pod -o wide
NAME                                READY   STATUS    RESTARTS   AGE     IP          NODE         NOMINATED NODE   READINESS GATES
pod/sample-subdomain                1/1     Running   0          4m50s   10.40.0.3   k8s-node01   <none>           <none>

# íŒŒë“œëª…ìœ¼ë¡œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
$ kubectl run --image=amsy810/tools:v2.0 --restart=Never --rm -i testpod \
> --command -- dig sample-hostname.sample-subdomain.default.svc.cluster.local

(ìƒëµ)

;; ANSWER SECTION:
sample-hostname.sample-subdomain.default.svc.cluster.local. 30 IN A 10.40.0.3
```