---
title:  "[Retry, k8s] 15. ì„œë¹„ìŠ¤ API - ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 15. ì„œë¹„ìŠ¤ API - ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” ì˜ˆì œì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•  Deployment, Pod

```bash
cat <<EOF > sample-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sample-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: sample-app
  template:
    metadata:
      labels:
        app: sample-app
    spec:
      containers:
      - name: nginx-container
        image: amsy810/echo-nginx:v2.0
EOF
```

```bash
cat <<EOF > sample-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-pod
spec:
  containers:
  - name: tools-container
    image: amsy810/tools:v2.0
EOF
```

<br>

## ğŸ”” ì„¸ì…˜ ì–´í”¼ë‹ˆí‹° 

> ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ë•Œ, **í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” íŒŒë“œë¥¼ ì§€ì •í•˜ëŠ” ê¸°ëŠ¥**

+ ì´ ê¸°ëŠ¥ì€ ì„œë¹„ìŠ¤ì˜ spec.sessionAffinityì™€ spec.sessionAffinityConfigë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

![1](https://user-images.githubusercontent.com/42735894/229264568-5d30b4ae-35e0-41a9-b753-53c100d3ad31.png){: width="90%" height="90%"}{: .align-center}

+ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ì˜ ê¸°ëŠ¥ì€ ê° ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì— iptablesë¡œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, ìµœëŒ€ ì„¸ì…˜ ê³ ì • ì‹œê°„(sessionAffinityConfig.clientIP.timeoutSeconds)ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```bash
# ë§ˆì§€ë§‰ ìš”ì²­ í›„ 10ì´ˆ ì´ë‚´ì˜ ìš”ì²­ì€ ê°™ì€ íŒŒë“œë¡œ ì „ì†¡í•œë‹¤.
cat <<EOF > sample-session-affinity.yaml
apiVersion: v1
kind: Service
metadata:
  name: sample-session-affinity
spec:
  type: LoadBalancer
  selector: 
    app: sample-app
  ports:
  - name: http-port
    portocol: TCP
    port: 8080
    targetPort: 80
    nodePort: 30084
  sessionAffinity: ClusterIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10
EOF
```

```bash
# ì²« ë²ˆì§¸ ìš”ì²­ ì „ì†¡
$ kubectl exec -it sample-pod -- curl http://sample-session-affinity.default.svc.cluster.local:8080
Host=sample-session-affinity.default.svc.cluster.local  Path=/  From=sample-deployment-7f47966499-459f6  ClientIP=10.40.0.0  XFF=


# ë§ˆì§€ë§‰ ìš”ì²­ í›„ 10ì´ˆ ì´ë‚´ì— ìš”ì²­ì„ ì „ì†¡
$ kubectl exec -it sample-pod -- curl http://sample-session-affinity.default.svc.cluster.local:8080
Host=sample-session-affinity.default.svc.cluster.local  Path=/  From=sample-deployment-7f47966499-459f6  ClientIP=10.40.0.0  XFF=


# ë§ˆì§€ë§‰ ìš”ì²­ í›„ 10ì´ˆ ì´ìƒ ê°„ê²©ì„ ë‘ê³  ìš”ì²­ ì „ì†¡
$ kubectl exec -it sample-pod -- curl http://sample-session-affinity.default.svc.cluster.local:8080
Host=sample-session-affinity.default.svc.cluster.local  Path=/  From=sample-deployment-7f47966499-7pz8b  ClientIP=10.40.0.0  XFF=
```


+ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ ë¹„í™œì„±í™”í•˜ê³  ê°™ì€ ìš”ì²­ì„ ì „ì†¡í•´ë³´ë©´, 10ì´ˆ ì´ë‚´ì— ë³´ë‚¸ ìš”ì²­ì´ ë‹¤ë¥¸ íŒŒë“œì— ì „ì†¡ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
# ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ ë¹„í™œì„±í™”
$ kubectl patch service sample-session-affinity -p '{"spec": {"sessionAffinity": "None"}}'
service/sample-session-affinity patched


# ì²« ë²ˆì§¸ ìš”ì²­ ì „ì†¡
$ kubectl exec -it sample-pod -- curl http://sample-session-affinity.default.svc.cluster.local:8080
Host=sample-session-affinity.default.svc.cluster.local  Path=/  From=sample-deployment-7f47966499-jc25k  ClientIP=10.46.0.0  XFF=


# ë§ˆì§€ë§‰ ìš”ì²­ í›„ 10ì´ˆ ì´ë‚´ì— ìš”ì²­ì„ ì „ì†¡
$ kubectl exec -it sample-pod -- curl http://sample-session-affinity.default.svc.cluster.local:8080
Host=sample-session-affinity.default.svc.cluster.local  Path=/  From=sample-deployment-7f47966499-459f6  ClientIP=10.46.0.0  XFF=
```


+ <u>NodePort/LoadBalancerì—ì„œë„ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ í™œì„±í™” í•  ìˆ˜ ìˆë‹¤.<u>


  + **ê·¸ëŸ¬ë‚˜ ì–´ëŠ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì— ì „ì†¡í•˜ëŠ”ì§€ì— ë”°ë¼ ê°™ì€ í´ë¼ì´ì–¸íŠ¸ IPë¼ë„ ê°™ì€ íŒŒë“œì— ì „ì†¡ëœë‹¤ê³  ë‹¨ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ** NodePort/LoadBalancerì—ì„œëŠ” ì„¸ì…˜ ì–´í”¼ë‹ˆí‹° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ì œí•œì ì´ë‹¤.


  + ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ ì‚¬ìš©í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì¼í•œ Podë¡œ ì—°ê²°ë˜ë„ë¡ ë³´ì¥í•  ìˆ˜ ìˆì§€ë§Œ, ì´ëŠ” **ë¡œë“œ ë°¸ëŸ°ì„œì˜ ë¶€í•˜ ë¶„ì‚° ëŠ¥ë ¥ì„ ì œí•œ**í•  ìˆ˜ ìˆë‹¤.


![2](https://user-images.githubusercontent.com/42735894/229267307-c159de8c-0c30-4fde-97f3-adf2ae352517.png){: width="90%" height="90%"}{: .align-center}

<br>

## ğŸ”” ë…¸ë“œ ê°„ í†µì‹  ì œì™¸ì™€ ë°œì‹  ì¸¡ IP ì£¼ì†Œ ìœ ì§€

> NodePort/LoadBalancer ì„œë¹„ìŠ¤ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì— ë„ì°©í•œ ìš”ì²­ì€ ë…¸ë“œë¥¼ í†µí•´ íŒŒë“œì—ë„ ë¡œë“œë°¸ëŸ°ì‹±í•˜ê²Œ ë˜ì–´ ìˆì–´ ë¶ˆí•„ìš”í•œ 2ë‹¨ê³„ ë¡œë“œ ë°¸ëŸ°ì‹±ì´ ì´ë£¨ì–´ì§„ë‹¤.


+ LoadBalancer/NodePort ì„œë¹„ìŠ¤ì— 2ë‹¨ê³„ ë¡œë“œ ë°¸ëŸ°ì‹±

![4](https://user-images.githubusercontent.com/42735894/229267967-662dcacf-918d-4b4a-8113-bfc5dd93bde5.png){: width="90%" height="90%"}{: .align-center}


![5](https://user-images.githubusercontent.com/42735894/229267965-b4ee6a08-fb07-4ff9-b6cd-856ef0a337a1.png){: width="90%" height="90%"}{: .align-center}


