---
title:  "[Retry, k8s] 14. ì„œë¹„ìŠ¤ API - LoadBalancer (MetalLB)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-10-05
last_modified_at: 2023-10-05
---
# [Retry, k8s] 14. ì„œë¹„ìŠ¤ API - LoadBalancer (MetalLB)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>



<br>

## ğŸ”” LoadBalancer

+ **LoadBalancer ì„œë¹„ìŠ¤ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ë¡œë“œ ë°¸ëŸ°ì„œì— ì™¸ë¶€ í†µì‹ ì´ ê°€ëŠ¥í•œ ê°€ìƒ IPë¥¼ í• ë‹¹**í•  ìˆ˜ ìˆë‹¤.

+ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ê°€ êµ¬ì¶•ëœ ì¸í”„ë¼ê°€ ì´ êµ¬ì¡°ì— ë§ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´ì•¼ í•˜ëŠ”ë°, í˜„ì¬ëŠ” GCP/AWS/ì• ì €(Azure)/OpenStackì„ ë¹„ë¡¯í•œ í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë”ê°€ LoadBalancer ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ì œê³µí•˜ê³  ìˆë‹¤.

+ NodePort/ExternalIPì—ì„œëŠ” í•˜ë‚˜ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì— í• ë‹¹ëœ IP ì£¼ì†Œë¡œ í†µì‹ í•˜ê¸° ë•Œë¬¸ì— ê·¸ ë…¸ë“œê°€ ë‹¨ì¼ ì¥ì• ì (SPOF)ì´ ë˜ì–´ ë²„ë¦¬ì§€ë§Œ, <u>LoadBalancerì—ì„œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œì™€ ë³„ë„ë¡œ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë…¸ë“œ ì¥ì• ê°€ ë°œìƒí•´ë„ í¬ê²Œ ë¬¸ì œê°€ ì—†ë‹¤</u>.

+ êµ¬ì¡°ëŠ” NodePort ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ê³  í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ ë¡œë“œ ë°¸ëŸ°ì„œì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œë¡œ ë°¸ëŸ°ì‹±ì„ í•˜ëŠ” í˜•íƒœë¡œ, k8s í´ëŸ¬ìŠ¤í„° ë…¸ë“œì— ì¥ì• ê°€ ë°œìƒí•œ ê²½ìš° ê·¸ ë…¸ë“œì— íŠ¸ë˜í”½ì„ ì „ì†¡í•˜ì§€ ì•ŠìŒìœ¼ë¡œì¨ ìë™ìœ¼ë¡œ ë³µêµ¬í•˜ê²Œ ë˜ì–´ ìˆë‹¤.

<br>

## ğŸ”” MetalLB

> <https://metallb.universe.tf/>


+ Kubernetes ì‚¬ìš© ì‹œ AWS, GCP, Azure ì™€ ê°™ì€ í´ë¼ìš°ë“œ í”Œë«í¼ì—ì„œëŠ” ìì²´ì ìœ¼ë¡œ ë¡œë“œ ë²¨ëŸ°ì„œ(Load Balancer)ë¥¼ ì œê³µí•´ ì£¼ì§€ë§Œ, ì˜¨í”„ë ˆë¯¸ìŠ¤ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” ë¡œë“œ ë²¨ëŸ°ì‹± ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ëª¨ë“ˆì„ ì¶”ê°€ì ìœ¼ë¡œ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.


+ **MetalLBëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë¡œë“œë°¸ëŸ°ì„œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” í”„ë¡œì íŠ¸**ì´ë‹¤.


+ MetaLBëŠ” L2 ë„¤íŠ¸ì›Œí¬(ARP/NDP)ì™€ L3 ë„¤íŠ¸ì›Œí¬(BGP) ë‘ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.


|ë°©ì‹|ì„¤ëª…|
|:---:|---|
|L2 ë„¤íŠ¸ì›Œí¬(ARP/NDP) ë°©ì‹|ã†ARP ìš”ì²­ì— ì‘ë‹µí•˜ì—¬ ì„œë¹„ìŠ¤ IPì™€ ë…¸ë“œì˜ MAC ì£¼ì†Œë¥¼ ì•Œë ¤ì£¼ëŠ” ë°©ì‹<br><br>ã†ì„¤ì •ì´ ê°„ë‹¨í•˜ì§€ë§Œ ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ì™€ í˜¸í™˜ë˜ì–´ì•¼ í•˜ê³ , ê°™ì€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë„ë©”ì¸ì— ìˆì–´ì•¼í•¨<br><br>ã†ë¼ìš°íŒ… ì œì–´ê°€ ë¶ˆê°€ëŠ¥|
|L3 ë„¤íŠ¸ì›Œí¬(BGP) ë°©ì‹|ã†BGP ë°©ì‹ì€ ì™¸ë¶€ BGP ë¼ìš°í„°ì™€ ì„¸ì…˜ì„ ë§ºê³  ì„œë¹„ìŠ¤ IPì— ëŒ€í•œ ë¼ìš°íŒ… ì •ë³´ë¥¼ êµí™˜í•˜ëŠ” ë°©ì‹<br><br>ã†ì„¤ì •ì´ ë³µì¡í•˜ì§€ë§Œ ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ì™€ ë…ë¦½ì <br><br>ã†ë¼ìš°íŒ… ì œì–´ê°€ ê°€ëŠ¥í•˜ê³ , ì„œë¹„ìŠ¤ IPê°€ ë³€ê²½ë˜ë©´ BGP ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ë¥¼ í†µí•´ ë¼ìš°íŒ… ì •ë³´ë¥¼ ê°±ì‹ í•¨|


<br>

## ğŸ”” NodePort / (Cloud) LoadBalancer / (MetalLB) LoadBalancerë™ì‘ ì°¨ì´


### (1) NodePort


1. ì‚¬ìš©ìê°€ ì›Œí¬ ë…¸ë“œì— ìˆëŠ” í¬íŠ¸ì— ì ‘ì†

2. ì ‘ì† í•œ ì´í›„ì— í•´ë‹¹ ì›Œí¬ ë…¸ë“œê°€ ì„œë¹„ìŠ¤ë¡œ ì´ë¥¼ ë°”ì¸ë”© 

3. ì„œë¹„ìŠ¤ê°€ í˜„ì¬ ë…¸ë“œì˜ ìƒíƒœ ë“±ì˜ ê¸°ì¤€ìœ¼ë¡œ ë…¸ë“œì— ì—°ê²° ì‹œí‚´


![222](https://user-images.githubusercontent.com/42735894/229718438-79d0e84f-ea2b-410e-802a-86fc11fe2548.png){: width="90%" height="90%"}{: .align-center}<br>


### (2) (Cloud) LoadBalancer


![223](https://user-images.githubusercontent.com/42735894/229718443-3224a4fc-2612-427f-a15a-f3d6f800875e.png){: width="90%" height="90%"}{: .align-center}<br>


### (3) (MetalLB) LoadBalancer


+ MetalLBì€ "ì»¨íŠ¸ë¡¤ëŸ¬"ì™€ "ìŠ¤í”¼ì»¤"ë¼ëŠ” ë‘ ê°€ì§€ êµ¬ì„± ìš”ì†Œë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.


+ **ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì‘ë™ ë°©ì‹ê³¼ EXTERNAL-IPë¥¼ ì •ì˜í•˜ê³  ê´€ë¦¬í•˜ë©°, ìŠ¤í”¼ì»¤ëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ ê´‘ê³ í•˜ê³  ìˆ˜ì§‘í•˜ì—¬ ê° íŒŒë“œì˜ ê²½ë¡œë¥¼ ì œê³µ**í•œë‹¤.


![224](https://user-images.githubusercontent.com/42735894/229718446-8e6204f4-a3af-4f87-8a83-16869a8624db.png){: width="90%" height="90%"}{: .align-center}


<br>

## ğŸ””  MetalLB ì„¤ì¹˜

> <https://metallb.universe.tf/installation/>

### (1) strict ARP mode í™œì„±í™”

```bash
kubectl edit configmap -n kube-system kube-proxy
```

```bash
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"
ipvs:
  strictARP: true  # <- falseì—ì„œ trueë¡œ ë³€ê²½
```


### (2) Manifestë¥¼ ì´ìš©í•´  MetalLB ì„¤ì¹˜

```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.9/config/manifests/metallb-native.yaml
```


### (3) IP Address Pool + L2Advertisement ì„¤ì •

```bash
$ cat <<EOF > my-network.yaml 
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.219.190-192.168.219.199

---

apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: mt-network-l2
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
EOF
```


### (4) MetalLB ë™ì‘ í™•ì¸

```bash
cat <<EOF > test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: almighty
  labels:
    app: almighty
spec:
  containers:
  - name: almighty
    image: docker.io/andrewloyolajeong/almighty:0.2.4

---

apiVersion: v1
kind: Service
metadata:
  name: almighty
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: almighty
  ports:
    - name: myweb
      protocol: TCP
      port: 8080
      targetPort: 8080
    - name: yourweb
      protocol: TCP
      port: 8081
      targetPort: 8081
EOF
```

```bash
$ kubectl get all
NAME                                     READY   STATUS    RESTARTS   AGE
pod/almighty                             1/1     Running   0          4m9s

NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)                         AGE
service/almighty          LoadBalancer   10.96.105.251    192.168.219.190   8080:31468/TCP,8081:31823/TCP   4m9s
service/kubernetes        ClusterIP      10.96.0.1        <none>            443/TCP                         4h36m

$ curl 192.168.219.190:8080

 Hello from example application. (written by Andrew)

$ curl 192.168.219.190:8081
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```


<br>

## ğŸ”” LoadBalancer ì„œë¹„ìŠ¤ ìƒì„±

|ì„¤ì •|ê°œìš”|
|:---:|---|
|spec.ports[].port|LoadBalancerì— í• ë‹¹ë˜ëŠ” ê°€ìƒ IPì™€ ClusterIPì—ì„œ ìˆ˜ì‹ í•  í¬íŠ¸ ë²ˆí˜¸|
|spec.ports[].targetPort|ëª©ì ì§€ ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë²ˆí˜¸|
|spec.ports[].nodePort|ëª¨ë“  ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œ IP ì£¼ì†Œì—ì„œ ìˆ˜ì‹ í•  í¬íŠ¸ ë²ˆí˜¸|

```bash
cat <<EOF > sample-lb.yaml
apiVersion: v1
kind: Service
metadata:
  name: sample-lb
spec:
  type: LoadBalancer
  ports:
  - name: "http-port"
    protocol: "TCP"
    port: 8080
    targetPort: 80
    nodePort: 30082
  selector:
    app: sample-app
EOF
```

```bash
$ kubectl get service sample-lb
NAME        TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)          AGE
sample-lb   LoadBalancer   10.96.194.169   192.168.219.191   8080:32659/TCP   5s


$ curl -s http://192.168.219.191:8080
Host=192.168.219.191  Path=/  From=sample-deployment-7f47966499-k7vk7  ClientIP=10.40.0.0  XFF=

$ curl -s http://192.168.219.191:8080
Host=192.168.219.191  Path=/  From=sample-deployment-7f47966499-82lld  ClientIP=10.40.0.0  XFF=

$ curl -s http://192.168.219.191:8080
Host=192.168.219.191  Path=/  From=sample-deployment-7f47966499-llctj  ClientIP=10.40.0.0  XFF=
```

![12](https://user-images.githubusercontent.com/42735894/228855798-a72c9abd-84dc-4845-8db7-a2347f261176.png){: width="90%" height="90%"}{: .align-center}


<br>

## ğŸ”” ë¡œë“œë°¸ëŸ°ì„œì— í• ë‹¹ë˜ëŠ” ê°€ìƒ IP ì •ì  ì§€ì •

```bash
cat <<EOF > sample-lb-fixip.yaml
apiVersion: v1
kind: Service
metadata:
  name: sample-lb-fixip
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.219.195
  ports:
  - name: "http-port"
    protocol: "TCP"
    port: 8080
    targetPort: 80
  selector:
    app: sample-app
EOF
```

```bash
$ kubectl get service sample-lb-fixip
NAME              TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)          AGE
sample-lb-fixip   LoadBalancer   10.109.42.211   192.168.219.195   8080:30202/TCP   11s
```


<br>

## ğŸ”” ë¡œë“œ ë°¸ëŸ°ì„œ ë°©í™”ë²½ ì •ì±… ì„¤ì •


+ ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œì—ì„œ ì ‘ì† ì œì–´ê°€ êµ¬í˜„ë˜ì§€ ì•Šì€ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œ ì´ loadBalancerSourceRangesë¥¼ ì„¤ì •í•˜ë©´, ì¿ ë²„ë„¤í‹°ìŠ¤ ë…¸ë“œ ì¸¡ì˜ iptablesë¥¼ ì‚¬ìš©í•˜ì—¬ ì ‘ì† ì œì–´ ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§„ë‹¤.

```bash
apiVersion: v1
kind: Service
metadata:
  name: sample-lb-fw
spec:
  type: LoadBalancer
  ports:
  - name: "http-port"
    protocol: "TCP"
    port: 8080
    targetPort: 80
  selector:
    app: sample-app
  loadBalancerSourceRanges:
  - 10.0.0.0/8
```

<br>