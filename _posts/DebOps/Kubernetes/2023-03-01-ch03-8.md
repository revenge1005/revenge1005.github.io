---
title:  "[Retry, k8s] 08. ì›Œí¬ë¡œë“œ API - ì¡" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-09-22
last_modified_at: 2023-09-22
---
# [Retry, k8s] 08. ì›Œí¬ë¡œë“œ API - ì¡
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” ì¡

> ì¡ì€ ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” ë¦¬ì†ŒìŠ¤, ë” ì •í™•íˆ ë§í•˜ë©´ Nê°œì˜ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ë©´ì„œ ì§€ì •í•œ íšŸìˆ˜ì˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰(ì •ìƒ ì¢…ë£Œ)ë¥¼ ë³´ì¥í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì´ë‹¤.

+ ì¡ê³¼ ë ˆí”„ë¦¬ì¹´ì…‹ ê°„ì˜ ì°¨ì´ì ì€ "ê¸°ë™ ì¤‘ì¸ íŒŒë“œê°€ ì •ì§€ë˜ëŠ” ê²ƒì„ ì „ì œë¡œ ë§Œë“¤ì–´ ì¡ŒëŠ”ì§€"ì— ìˆë‹¤.

+ ë ˆí”Œë¦¬ì¹´ì…‹ ë“±ì—ì„œëŠ” ì •ìƒ ì¢…ë£Œ íšŸìˆ˜ ë“±ì„ ì…€ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ë°°ì¹˜ ì²˜ë¦¬ì¸ ê²½ìš°ì—ëŠ” ì¡ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì.

<br>

### ğŸ“œ ì¡ ìƒì„±

> ë ˆí”Œë¦¬ì¹´ì…‹ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë ˆì´ë¸”ê³¼ ì„¹ë ‰í„°ëŠ” ëª…ì‹ì ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ, ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ìœ ë‹ˆí¬í•œ uuidë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ì¡ì—ì„œëŠ” ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•˜ì§€ ì•ŠëŠ”ë‹¤.

```bash
cat <<EOF > sample-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-job
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 10
  template: 
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["slepp"]
        args: ["60"]
      restartPolicy: Never
EOF
```

```bash
$ kubectl apply -f sample-job.yaml
job.batch/sample-job created


# ì¡ ëª©ë¡ í‘œì‹œ
$ kubectl get jobs
NAME         COMPLETIONS   DURATION   AGE
sample-job   0/1           48s        48s


# ì¡ì´ ìƒì„±í•œ íŒŒë“œ í™•ì¸
$ kubectl get pod
NAME                   READY   STATUS    RESTARTS   AGE
pod/sample-job-8wwpf   1/1     Running   0          37s


# ì¡ ëª©ë¡ í‘œì‹œ(íŒŒë“œ ì‹¤í–‰ ì™„ë£Œ í›„)
$ kubectl get pod
NAME                   READY   STATUS      RESTARTS   AGE
pod/sample-job-8wwpf   0/1     Completed   0          101s
```

<br>

### ğŸ“œ restartPolicyì— ë”°ë¥¸ ë™ì‘ ì°¨ì´

+ **ã€restartPolicy: Neverì˜ ê²½ìš°ã€‘**

  + íŒŒë“œì— ì¥ì• ê°€ ë°œìƒí•˜ë©´ ì‹ ê·œ íŒŒë“œê°€ ìƒì„±

```bash
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-job-never-restart
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 10
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sh", "-c"]
        args: ["$(sleep 3600)"]
      restartPolicy: Never
```

```bash
$ kubectl get pod
NAME                             READY   STATUS    RESTARTS   AGE
sample-job-never-restart-42fsr   1/1     Running   0          11s


# ì»¨í…Œì´ë„ˆìƒì˜ sleep í”„ë¡œì„¸ìŠ¤ ì •ì§€
$ kubectl exec -it sample-job-never-restart-42fsr -- sh -c 'kill -9 `pgrep sleep`'


# ìƒì„±ëœ íŒŒë“œê°€ ê¸°ë™ë¨
$ kubectl get pod
NAME                             READY   STATUS    RESTARTS   AGE
sample-job-never-restart-42fsr   0/1     Error     0          45s
sample-job-never-restart-p8cbz   1/1     Running   0          3s
```


+ **ã€restartPolicy: OnFailureì˜ ê²½ìš°ã€‘**

  + ë™ì¼í•œ íŒŒë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡ì„ ë‹¤ì‹œ ì‹œì‘

```bash
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-job-onfailure-restart
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 10
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sh", "-c"]
        args: ["$(sleep 3600)"]
      restartPolicy: OnFailure
```

```bash
$ kubectl get pods
NAME                                 READY   STATUS    RESTARTS   AGE
sample-job-onfailure-restart-lgtjw   1/1     Running   0          8s


# ì»¨í…Œì´ë„ˆìƒì˜ sleep í”„ë¡œì„¸ìŠ¤ ì •ì§€
$ kubectl exec -it sample-job-onfailure-restart-lgtjw -- sh -c 'kill -9 `pgrep sleep`'


# ê°™ì€ íŒŒë“œ ì¬ì‹œì‘
$ kubectl get pods
NAME                                 READY   STATUS    RESTARTS     AGE
sample-job-onfailure-restart-lgtjw   1/1     Running   1 (6s ago)   38s
```

<br>

### ğŸ“œ íƒœìŠ¤í¬ì™€ ì‘ì—… í ë³‘ë ¬ ì‹¤í–‰

> completions(ì„±ê³µ íšŸìˆ˜ë¥¼ ì§€ì •), parallelism(ë³‘ë ¬ì„±ì„ ì§€ì •), backoffLimit(ì‹¤íŒ¨ë¥¼ í—ˆìš©í•˜ëŠ” íšŸìˆ˜ë¥¼ ì§€ì •)


#### (a) 1íšŒë§Œ ì‹¤í–‰í•˜ëŠ” íƒœìŠ¤í¬ - completions=1/parallelism=1/backoffLimit=0

```bash 
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-oneshot-task-job
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 0
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sleep"]
        args: ["30"]
      restartPolicy: Never
```


#### (b) Nê°œ ë³‘ë ¬ë¡œ ì‹¤í–‰ì‹œí‚¤ëŠ” íƒœìŠ¤í¬ - completions=N/parallelism=M/backoffLimit=P

```bash 
# íŒŒë“œê°€ 5íšŒ ì •ìƒ ì¢…ë£Œí•  ë•Œê¹Œì§€ ì„¸ ê°œ ë³‘ë ¬ë¡œ ì‹¤í–‰í•œë‹¤.

apiVersion: batch/v1
kind: Job
metadata:
  name: sample-multi-task-job
spec:
  completions: 5
  parallelism: 3
  backoffLimit: 5
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sleep"]
        args: ["30"]
      restartPolicy: Never
```


#### (c) Nê°œ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ëŠ” ì‘ì—… í - completions=ë¯¸ì§€ì •/parallelism=M/backoffLimit=P

```bash 
# íŒŒë“œê°€ 5íšŒ ì •ìƒ ì¢…ë£Œí•  ë•Œê¹Œì§€ ì„¸ ê°œ ë³‘ë ¬ë¡œ ì‹¤í–‰í•œë‹¤.

apiVersion: batch/v1
kind: Job
metadata:
  name: sample-multi-workqueue-job
spec:
  # completions: 1
  parallelism: 3
  backoffLimit: 1
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sleep"]
        args: ["30"]
      restartPolicy: Never
```

+ íƒœìŠ¤í¬ì™€ ì‘ì—… íëŠ” ì¡ì„ í‘œì‹œí•  ë•Œ COMPLETIONSì˜ ì¶œë ¥ í˜•ì‹ì´ ë‹¤ë¥´ë‹¤. (íƒœìŠ¤í¬: 0/5, ì‘ì—… í: 0/1 of 3)

+ ì´ëŠ” ì„¸ ê°œ ë³‘ë ¬ë¡œ ì‹¤í–‰ ì¤‘ í•˜ë‚˜ê°€ ì •ìƒ ì¢…ë£Œí•˜ë©´ ë˜ì§€ë§Œ ì•„ì§ í•˜ë‚˜ë„ ì •ìƒ ì¢…ë£Œë˜ì§€ ì•Šì€ ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.

```bash
kubectl get job
NAME                         COMPLETIONS   DURATION   AGE
sample-multi-task-job        0/5           12s        12s
sample-multi-workqueue-job   0/1 of 3      6s         6s
```


#### (d) í•œ ê°œì”© ì‹¤í–‰í•˜ëŠ” ì‘ì—… í - completions=ë¯¸ì§€ì •/parallelism=1/backoffLimit=P

```bash
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-single-workqueue-job
spec:
  # completions: 1
  parallelism: 1
  backoffLimit: 1
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sleep"]
        args: ["30"]
      restartPolicy: Never
```

+ ì„±ê³µ íšŸìˆ˜(completions)ëŠ” ë‚˜ì¤‘ì— ë³€ê²½í•  ìˆ˜ ì—†ëŠ” íŒŒë¼ë¯¸í„°ì´ì§€ë§Œ, ë³‘ë ¬ ìˆ˜(parallelism)ëŠ” ë³€ê²½ì´ ê°€ëŠ¥í•˜ë‹¤.

```bash
$  kubectl get job
NAME                          COMPLETIONS   DURATION   AGE
sample-single-workqueue-job   0/1           11s        11s


$ kubectl patch job sample-single-workqueue-job -p '{"spec": {"parallelism": 2}}'
job.batch/sample-single-workqueue-job patched


$ kubectl get job
NAME                          COMPLETIONS   DURATION   AGE
sample-single-workqueue-job   1/1 of 2      34s        55s
```

<br>

### ğŸ“œ ì¼ì • ê¸°ê°„ ê²½ê³¼ í›„ ì¡ ì‚­ì œ

> ì¡ì€ ì¢…ë£Œ í›„ì— ì‚­ì œë˜ì§€ ì•Šê³  ë‚¨ëŠë°, spec.ttlSecondsAfterFinished í†µí•´ ì¡ì´ ì¢…ë£Œí•œ í›„ì— ì¼ì • ê¸°ê°„(ì´ˆ) ê²½ê³¼ í›„ ì‚­ì œí•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```bash
apiVersion: batch/v1
kind: Job
metadata:
  name: sample-job-ttl
spec:
  ttlSecondsAfterFinished: 30
  completions: 1
  parallelism: 1
  backoffLimit: 10
  template:
    spec:
      containers:
      - name: tools-container
        image: amsy810/tools:v2.0
        command: ["sleep"]
        args: ["60"]
      restartPolicy: Never
```

```bash
# job ìƒíƒœ ëª¨ë‹ˆí„°ë§
$ kubectl get job sample-job-ttl --watch --output-watch-events
EVENT      NAME             COMPLETIONS   DURATION   AGE
ADDED      sample-job-ttl   0/1           52s        52s
MODIFIED   sample-job-ttl   1/1           64s        94s
DELETED    sample-job-ttl   1/1           64s        94s
```

<br>