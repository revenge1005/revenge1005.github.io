---
title:  "[Rocky] 13. iSCSI Target/initiator" 

categories:
  - ROCKY
tags:
  - [rocky, linux]

toc: true
toc_sticky: true

date: 2022-08-10
last_modified_at: 2022-08-10
---
<br>

# ğŸ”” iSCSIë€?
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

> iscsiëŠ” ì¸í„°ë„· í”„ë¡œí† ì½œ(IP) ê¸°ë°˜ì˜ ìŠ¤í† ë¦¬ì§€ ë„¤íŠ¸ì›Œí‚¹ í‘œì¤€ìœ¼ë¡œ, ë°ì´í„° ìŠ¤í† ë¦¬ì§€ ì¥ì¹˜ë¥¼ ì—°ê²°í•˜ëŠ”ë° ì‚¬ìš© ì¦‰, IP ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ SCSI ëª…ë ¹ì„ ì „ë‹¬í•¨ìœ¼ë¡œì¨, ì¸í„°ë„·ì„ ê±°ì³ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê³  ë³´ê´€í•˜ê²Œ ëœë‹¤.

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target)/ì´ë‹ˆì‹œì—ì´í„°(initiator)** </big>

<br>

+ **íƒ€ê²Ÿ(Target) :** iscsi ì„œë²„ë¡œì„œ ìŠ¤í† ë¦¬ì§€ë¥¼ ì œê³µí•˜ëŠ” ì—­í• 


+ **ì´ë‹ˆì‹œì—ì´í„°(initiator) :** iscsi í´ë¼ì´ì–¸íŠ¸ë¡œì„œ ìŠ¤í† ë¦¬ì§€ì— ì ‘ê·¼í•˜ëŠ” ì—­í• 


<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target)/ì´ë‹ˆì‹œì—ì´í„°(initiator)** </big>

<br>

+ íƒ€ê²Ÿê³¼ ì´ë‹ˆì‹œì—ì´í„°ëŠ” **IQN(iSCSI Qualified Name)ì´ë¼ëŠ” ê³ ìœ í•œ ì´ë¦„ìœ¼ë¡œ ì‹ë³„í•œë‹¤.** (ì˜ˆì‹œ : iqn.2022-08.com.test:target)

    |í¬ë§· í˜•íƒœ|Type.Date.Naming_Auth:String_defined_by_example.com_Naming_authority|
    |:---:|:---|
    |Type|iqnìœ¼ë¡œ ê³ ì •|
    |Date|YYYY-MM|
    |Naming_Auth|ë„ë©”ì¸ì˜ ì—­ìˆœ í˜•íƒœ|
    |String_...|ì„¤ëª…|

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target) êµ¬ì¡°** </big>

<br>

**1) backstores**


+ ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, íŒŒì¼ì´ë‚˜ ë””ìŠ¤í¬ì™€ ê°™ì€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ìƒí™”í•œë‹¤.


+  backstoresì—ëŠ” fileio, block, pscsi, ramdisk ë“±ì˜ í•˜ìœ„ ë…¸ë“œê°€ ìˆë‹¤.


    |í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |fileio|íŒŒì¼ì„ ë””ìŠ¤í¬ ì´ë¯¸ì§€ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|
    |block|ë¬¼ë¦¬ì ì¸ ë””ìŠ¤í¬ ë¸”ë¡ ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|
    |pscsi|ë¡œì»¬ SCSI ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜, ë””ìŠ¤í¬ë¿ë§Œ ì•„ë‹ˆë¼ í…Œì´í”„ë‚˜ CD-ROMê³¼ ê°™ì€ ë‹¤ì–‘í•œ ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë‹¤.|
    |ramdisk|ë©”ëª¨ë¦¬ë¥¼ ë””ìŠ¤í¬ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|


    |ê·¸ ì™¸ í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |alua|Asymmetric Logical Unit Accessì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ìƒíƒœì™€ ìš°ì„  ìˆœìœ„ë¥¼ ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥|
    |default_tg_pt_gp|Target Port Groupì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´|

<br>

**2) iscsi**

+ iscsi íƒ€ê²Ÿì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, IQNìœ¼ë¡œ ì‹ë³„ëœë‹¤.

+ iscsiì—ëŠ” íƒ€ê²Ÿì˜ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” í•˜ìœ„ ë…¸ë“œê°€ ìˆìœ¼ë©°, ê·¸ ì•ˆì—ëŠ” TPG, LUN, ACL ë“±ì˜ í•˜ìœ„ ë…¸ë“œê°€ ìˆë‹¤.


    |í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |TPG|Target Portal Groupì˜ ì•½ìë¡œ, íƒ€ê²Ÿì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë„¤íŠ¸ì›Œí¬ í¬í„¸ì˜ ê·¸ë£¹ìœ¼ë¡œ TPGì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” acls, luns, portalsì´ ìˆë‹¤.|
    |acls|Access Control Listì˜ ì•½ìë¡œ, ì´ë‹ˆì‹œì—ì´í„°ì˜ ì ‘ê·¼ ê¶Œí•œì„ ì œì–´í•˜ëŠ” ëª©ë¡ìœ¼ë¡œ aclsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” ì´ë‹ˆì‹œì—ì´í„°ì˜ IQNì´ ìˆìœ¼ë©°, ê·¸ ì•ˆì—ëŠ” mapped_lunì´ ìˆë‹¤.|
    |luns|Logical Unit Numberì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì™€ ì´ë‹ˆì‹œì—ì´í„°ì˜ ì—°ê²°ì„ ë‚˜íƒ€ë‚´ëŠ” ìˆ«ì, lunsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” lun0, lun1 ë“±ì´ ìˆë‹¤.|
    |portals|ë„¤íŠ¸ì›Œí¬ í¬í„¸ì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´, portalsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” IP ì£¼ì†Œì™€ í¬íŠ¸ ë²ˆí˜¸ê°€ ìˆë‹¤.|

    |ê·¸ ì™¸...|ì„¤ëª…|
    |:---:|:---|
    |LUN|Logical Unit Numberì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì™€ ì´ë‹ˆì‹œì—ì´í„°ì˜ ì—°ê²°ì„ ë‚˜íƒ€ë‚´ëŠ” ìˆ«ì, LUNì€ íƒ€ê²Ÿê³¼ ì´ë‹ˆì‹œì—ì´í„°ì—ì„œ ë™ì¼í•œ ê°’ì„ ê°€ì§„ë‹¤.|
    |mapped_lun|ì´ë‹ˆì‹œì—ì´í„°ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” LUNì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´, mapped_lunì€ ì´ë‹ˆì‹œì—ì´í„°ë³„ë¡œ ë‹¤ë¥¸ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.|

<br>

**3) loopback**

+ loopback íƒ€ê²Ÿì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, ë¡œì»¬ ì‹œìŠ¤í…œì—ì„œ ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target) êµ¬ì„± - (Targetcli)** </big>

```bash
$ dnf -y install targetcli
 

$ mkdir /var/lib/iscsi_disks


$ targetcli


$ cd backstores/fileio 


/> cd backstores/fileio 


# [disk01]ì´ë¼ëŠ” ì´ë¦„ì˜ 10Gì˜ ë””ìŠ¤í¬ ì´ë¯¸ì§€([/var/lib/iscsi_disks/disk01.img])ë¥¼ ìƒì„±
/backstores/fileio> create disk01 /var/lib/iscsi_disks/disk01.img 10G 
Created fileio disk01 with size 10737418240
/backstores/fileio> cd /iscsi 


# íƒ€ê²Ÿ(Target) ìƒì„±
# [ iqn.(year)-(month).(reverse of domain name):(any name you like) ]
/iscsi> create iqn.2022-08.com.test:dlp.target01 
Created target iqn.2022-08.com.test:dlp.target01.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
/iscsi> cd iqn.2022-08.com.test:dlp.target01/tpg1/luns 


# LUN ì„¤ì •
/iscsi/iqn.20...t01/tpg1/luns> create /backstores/fileio/disk01 
Created LUN 0.
/iscsi/iqn.20...t01/tpg1/luns> cd ../acls 


# ACL ì„¤ì •(ì—°ê²°ì„ í—ˆìš©í•˜ëŠ” ì´ë‹ˆì‹œì—ì´í„°(initiator)ì˜ IQN)
/iscsi/iqn.20...t01/tpg1/acls> create iqn.2022-08.com.test:node01.initiator01 
Created Node ACL for iqn.2022-08.com.test:node01.initiator01
Created mapped LUN 0.
/iscsi/iqn.20...t01/tpg1/acls> cd iqn.2022-08.com.test:node01.initiator01 


# ì¸ì¦ì„ ìœ„í•œ ì‚¬ìš©ì ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
/iscsi/iqn.20...w.initiator01> set auth userid=username 
Parameter userid is now 'username'.
/iscsi/iqn.20...w.initiator01> set auth password=password 
Parameter password is now 'password'.
/iscsi/iqn.20...w.initiator01> exit 
Global pref auto_save_on_exit=true
Configuration saved to /etc/target/saveconfig.json


$ ss -napt | grep 3260
LISTEN 0      256          0.0.0.0:3260       0.0.0.0:*


$ systemctl enable target


# ë°©í™”ë²½ ì„¤ì •
$ firewall-cmd --add-service=iscsi-target; firewall-cmd --runtime-to-permanent
```

<br>

<big> **â–  iSCSI ì´ë‹ˆì‹œì—ì´í„°(initiator) êµ¬ì„± - (iscsi-initiator-utils)** </big>

```bash
$ dnf -y install iscsi-initiator-utils



$ vi /etc/iscsi/initiatorname.iscsi

# iSCSI ëŒ€ìƒ ì„œë²„ì— ì„¤ì •í•œ ê²ƒê³¼ ë™ì¼í•œ IQNìœ¼ë¡œ ë³€ê²½
InitiatorName=iqn.2022-08.com.test:node01.initiator01


$ vi /etc/iscsi/iscsid.conf

# line 58
node.session.auth.authmethod = CHAP

# line 69,70 : ì£¼ì„ ì²˜ë¦¬ í•´ì œí•˜ê³  iSCSI ëŒ€ìƒ ì„œë²„ì—ì„œ ì„¤ì •í•œ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§€ì •
node.session.auth.username = username
node.session.auth.password = password


# íƒ€ê²Ÿ(Target) discovery
$ iscsiadm -m discovery -t sendtargets -p 192.168.219.101
[ 2704.827383] Loading iSCSI transport class v2.0-870.
[ 2704.848709] iscsi: registered transport (tcp)
192.168.219.101:3260,1 iqn.2022-08.com.test:dlp.target01


# discovery í›„ ìƒíƒœ í™•ì¸
$ iscsiadm -m node -o show
# BEGIN RECORD 2.1.2
node.name = iqn.2022-08.com.test:dlp.target01
node.tpgt = 1
node.startup = automatic
node.leading_login = No
iface.iscsi_ifacename = default
.....
.....
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD


# íƒ€ê²Ÿ(Target)ì— ë¡œê·¸ì¸
$ iscsiadm -m node --login
Logging in to [iface: default, target: iqn.2022-08.com.test:dlp.target01, portal: 192.168.219.101,3260]
Login to [iface: default, target: iqn.2022-08.com.test:dlp.target01, portal: 192.168.219.101,3260] successful.


# ì„¤ì •ëœ ì„¸ì…˜ í™•ì¸
$ iscsiadm -m session -o show
tcp: [1] 192.168.219.101:3260,1 iqn.2022-08.com.test:dlp.target01 (non-flash)


# íŒŒí‹°ì…˜ í™•ì¸
$ cat /proc/partitions
major minor  #blocks  name

 252        0   31457280 sda
 252        1    1048576 sda1
 252        2   30407680 sda2
 252       16   83886080 sdb
 252       17   83885056 sdb1
 253        0   27258880 dm-0
 253        1    3145728 dm-1
   8        0   10485760 sdc
# íƒ€ê²Ÿ(Target) ì„œë²„ì—ì„œ ì œê³µí•œ ìƒˆ ì¥ì¹˜ë¥¼ [sdc]ë¡œ ì¶”ê°€ë¨
```

```bash
# label ë§Œë“¤ê¸°
$ parted --script /dev/sdc "mklabel gpt"


# íŒŒí‹°ì…˜ ìƒì„±
$ parted --script /dev/sdc "mkpart primary 0% 100%"


# XFS í¬ë§·
$ mkfs.xfs -i size=1024 -s size=4096 /dev/sdc1
meta-data=/dev/sdc1              isize=1024   agcount=4, agsize=654336 blks
         =                       sectsz=4096  attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1
data     =                       bsize=4096   blocks=2617344, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=4096  sunit=1 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0


$ mount /dev/sdc1 /mnt
$ df -hT
Filesystem          Type      Size  Used Avail Use% Mounted on
devtmpfs            devtmpfs  1.9G     0  1.9G   0% /dev
tmpfs               tmpfs     1.9G     0  1.9G   0% /dev/shm
tmpfs               tmpfs     1.9G  8.6M  1.9G   1% /run
tmpfs               tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup
/dev/mapper/rl-root xfs        26G  2.2G   24G   9% /
/dev/vda1           xfs      1014M  201M  814M  20% /boot
tmpfs               tmpfs     374M     0  374M   0% /run/user/0
/dev/sda1           xfs        10G   99M  9.9G   1% /mnt
```