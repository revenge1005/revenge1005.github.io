---
title:  "[시스템 관리] 02. 웹 서버의 로그(Log)" 

categories:
  - SYS_MGMT
tags:
  - [sys_mgmt, linux]

toc: true
toc_sticky: true

date: 2021-05-02
last_modified_at: 2021-05-02
---
<br>

# 🔔 웹 서버의 로그(Log)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 20%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
} 
big { 
    font-size: 25px 
}
small { 
    font-size: 18px 
}
</style>

<br>

<big> **■ 액세스(Access) 로그** </big> <br>

요청받은 페이지가 정상으로 응답되었을 때도 액세스 로그에 기록하고 HTTP 상태 코드로 'Not Found(404)'와 같은 오류 상태를 회신했을 때도 액세스 로그에 출력됩니다. (단, 웹 서버에서 요청받은 페이지를 찾지 못한 원인은 로그에 포함되지 않습니다.)

<br>

<big> **■ 오류(Error) 로그** </big> <br>

오류 로그는 HTTP 오류 상태를 응답했다는 정보가 아니라, 웹 서버에서 오류가 발생한 경우에 출력됩니다. (404(Not Found)를 응답한 로그 정보는 액세스 로그에 출력되고, 이때 오류가 발생한 원인에 해당하는 내용이 오류 로그로 출력됩니다.)

<br>

<big> **■ HTTP 상태 코드 목록** </big> <br>

![dadad](https://github.com/revenge1005/WEB-Server-3-Tier-Architecture/assets/42735894/e4220576-2840-407e-8816-369f740dff02){: width="90%" height="90%"}{: .align-center}

<br>

<big> **■ apache log 관련 설정 (/etc/httpd/conf/httpd.conf)** </big> <br>

```bash

~(생략)~

ErrorLog "logs/error_log"

LogLevel warn

<IfModule log_config_module>

    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common

    <IfModule logio_module>
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>

    CustomLog "logs/access_log" combined
</IfModule>

~(생략)~
```

| 옵션 | 내용 |
| :-----: | :------- |
| ErrorLog | 실제 로그 파일의 경로는 "ServerRoot"의 설정 + 여기서 설정한 경로가 됨 (/etc/httpd/logs/error_log) |
| LogLevel | 오류 로그로 추력할 로그 레벨을 지정 (emerg, alert, crit, error, warn, notice, info, debug) |
| CustomLog | 실제 로그 파일의 경로는 "ServerRoot"의 설정 + 여기서 설정한 경로가 됨 (/etc/httpd/logs/access_log), 포맷은 combined 사용, combined는 LogFormat에 지정되어 있다. |
| LogFormat |%h : 원격 호스트명 , %l : 원격 로그명 , %u : 원격 사용자 , %t : 요청을 받아들인 시간 , <br> %r : 요청의 첫행 , %>s : 마지막 status , %b : 응답 바이트 수 , <br> %{Referer}i : Referer 정보 , %{User-Agent}i : User-Agent 정보 |

<br>

<details>

<summary><big> **■ apache 로그 출력** </big></summary>

<br>

<small> **▶ apache 로그 출력** </small> <br>

+ apache 설치 후 페이지에 접근하면 아래와 같이 로그가 출력되는 것을 볼 수 있다.

+ 오류 로그 내용은 "Options 지시문에 의해 /var/www/html 디렉터리 목록 출력이 금지되었다"는 내용으로 즉, 이 오류 때문에 액세스 로그에 403이 출려되었다고 짐작할 수 있다.

```bash
# cat /var/log/httpd/access_log
192.168.219.1 - - [27/Jul/2023:20:27:52 +0900] "GET / HTTP/1.1" 403 456389 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36"
...

# tail -f /var/log/httpd/error_log
[Thu Jul 27 20:27:52.080921 2023] [autoindex:error] [pid 23025:tid 23220] [client 192.168.219.1:7152] AH01276: Cannot serve directory /var/www/html/: No matching DirectoryIndex (index.html) found, and server-generated directory index forbidden by Options directive
...
```

<br>

<small> **▶ 로그 회피** </small> <br>

+ 우선 기본 사이트 설정(/etc/httpd/conf.d/welcom.conf)를 확인하면 아래와 같다.

+ "Options -Indexes" 설정은 URL에 파일명이 생략된 경우 **'표시할 것이 아무것도 없더라도 디렉터리 목록은 표시하지 않는다'는 의미**로 즉, 오류 로그의 내용과 일치한다.

+ "ErrorDocument 403 /.noindex.html" 설정은 **'403이 발생하면 /.noindex.html을 출력하라'**는 의미다.

```bash
# cat /etc/httpd/conf.d/welcome.conf

<LocationMatch "^/+$">
    Options -Indexes
    ErrorDocument 403 /.noindex.html
</LocationMatch>

...

Alias /.noindex.html /usr/share/httpd/noindex/index.html
```

+ 정리하면 URL에 파일명을 지정하지 않았으므로(http://server_addr/index.html) 미리 설정되어 있는 기본 파일을 찾는데, 기본 파일은 DirectoryIndex으로 설정한다.

+ DirectoryIndex 설정은 다음과 같이 index.html을 찾아가도록 설정되어 있다.

```bash
# cat /etc/httpd/conf/httpd.conf | grep DirectoryIndex
    DirectoryIndex index.html
```

+ 그럼 어느 디렉터리에 있는 index.html 파일을 찾아가는가? 

+ DocumentRoot에는 '/var/www/html'를 지정되어 있으므로 여기가 도큐먼트 루트 디렉터리가 된다.

```bash
# cat /etc/httpd/conf/httpd.conf | grep DocumentRoot
DocumentRoot "/var/www/html"
```

> 최종적으로 위 내용은 다음과 같다 <br> **"/var/www/html에 표시해야 할 파일(index.html)이 존재하지 않으므로 디렉터리 목록을 출력하려고 했으나 금지되어 있으므로 403을 출력했습니다. 403이 발생했을 때 이동할 곳으로 /.noindex.html이 지정되어 있으므로 해당 파일을 응답했습니다."** <br><br> 즉, /var/www/html 디렉터리에 index.html이 있으면 오류를 피할 수 있다.

</details>