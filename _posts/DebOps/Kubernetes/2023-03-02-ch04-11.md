---
title:  "[Retry, k8s] 20. ì„œë¹„ìŠ¤ API - ì¸ê·¸ë ˆìŠ¤(Ingress) (2)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 20. ì„œë¹„ìŠ¤ API - ì¸ê·¸ë ˆìŠ¤(Ingress) (2)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” ì¸ê·¸ë ˆìŠ¤(Ingress) - SSL/TLS ì•”í˜¸í™”

<br>

### (1) TLS ì•”í˜¸í™”ë¥¼ í¬í•¨í•œ ì¸ê·¸ë ˆìŠ¤ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„±

+ "nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'"ëŠ” HTTPë¡œ ì ‘ì†í•œ ê²½ìš° HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” ì„¤ì •

+ "tls"ëŠ” ì•”í˜¸ ì„¤ì • ì„¹ì…˜ìœ¼ë¡œ ëŒ€ìƒì´ ë˜ëŠ” ë„ë©”ì¸("tls.hosts")ê³¼ í•´ë‹¹ ë„ë©”ì¸ì˜ ("tls.secretName") ì„œë²„ ì¸ì¦ì„œê°€ ë³´ê´€ëœ ì‹œí¬ë¦¿ì„ ì§€ì •

```bash
cat << EOF > ingress-tls.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress
  annotations:
    kubernetes.io/ingress.class: 'nginx'
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'  

spec:
  tls:               
  - hosts:
    - abc.sample.com 
    secretName: tls-certificate  

  rules:
  - host: abc.sample.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: helloworld-svc
            port:
              number: 8080
      - path: /apl2
        pathType: Prefix
        backend:
          service:
            name: nginx-svc
            port:
              number: 9080
  - host: xyz.sample.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: java-svc
            port:
              number: 9080
EOF
```

<br>

### (2) ìì²´ ì„œëª… ì¸ì¦ì„± ìƒì„±

```bash
$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout nginx-selfsigned.key -out ngin-selfsigned.crt
```

<br>

### (3) ìì²´ ì„œëª… ì¸ì¦ì„œë¥¼ ì‹œí¬ë¦¿ì— ë³´ê´€

```bash
$ kubectl create secret tls tls-certificate --key nginx-selfsigned.key --cert ngin-selfsigned.crt
secret/tls-certificate created


$ kubectl get secrets
NAME                  TYPE                                  DATA   AGE
default-token-62jwj   kubernetes.io/service-account-token   3      37d
tls-certificate       kubernetes.io/tls                     2      7s
```

<br>

### (4) ë³´ì•ˆ í”„ë¡œí† ì½œì„ ì ìš©í•œ ì¸ê·¸ë ˆìŠ¤ ìƒì„±ê³¼ í™•ì¸

```bash
$ kubectl apply -f ingress-tls.yaml
ingress.networking.k8s.io/hello-ingress created


$ kubectl get ingress
NAME            CLASS    HOSTS                           ADDRESS           PORTS     AGE
hello-ingress   <none>   abc.sample.com,xyz.sample.com   192.168.219.190   80, 443   65s


## abc.sample.comì˜ ë„ë©”ì¸ê³¼ ëŒ€ì‘í•˜ëŠ” ì‹œí¬ë¦¿ì˜ ì´ë¦„ì´ ì¶œë ¥ë˜ì–´ ì •ìƒì ìœ¼ë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ê°€ ì ìš©ëœ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
$ kubectl describe ingress
Name:             hello-ingress
Labels:           <none>
Namespace:        default
Address:          192.168.219.190
Ingress Class:    <none>
Default backend:  <default>
TLS:
  tls-certificate terminates abc.sample.com  ## <- ì´ ë¶€ë¶„ì— ì£¼ëª©
Rules:
  Host            Path  Backends
  ----            ----  --------
  abc.sample.com
                  /       helloworld-svc:8080 (10.46.0.2:80)
                  /apl2   nginx-svc:9080 (10.40.0.2:80,10.40.0.3:80,10.46.0.3:80)
  xyz.sample.com
                  /   java-svc:9080 (10.46.0.4:9080)
Annotations:      kubernetes.io/ingress.class: nginx
                  nginx.ingress.kubernetes.io/force-ssl-redirect: true
                  nginx.ingress.kubernetes.io/rewrite-target: /
Events:
  Type    Reason  Age                From                      Message
  ----    ------  ----               ----                      -------
  Normal  Sync    70s (x2 over 85s)  nginx-ingress-controller  Scheduled for sync
```

<br>

![twewe](https://user-images.githubusercontent.com/42735894/229831355-13f4d337-90bf-4fde-ba95-483d50a3c572.gif){: width="70%" height="70%"}{: .align-center}<br>


<br>

## ğŸ”” ì¸ê·¸ë ˆìŠ¤(Ingress) - ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°


+ **ë¡œë“œ ë°¸ëŸ°ì„œì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°(Sticky Session)ì™€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ëŠ” ë¹„ìŠ·í•œ ê°œë…ì´ì§€ë§Œ êµ¬í˜„ ë°©ì‹ì´ ë‹¤ë¥´ë‹¤.**


    + ë¡œë“œ ë°¸ëŸ°ì„œì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°(Sticky Session)ëŠ” **<u>í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ íŠ¹ì • ì„œë²„ì— ê³ ì •ì‹œí‚¤ëŠ” ê¸°ëŠ¥**ìœ¼ë¡œ, ì¿ í‚¤ë‚˜ IP ì£¼ì†Œ ë“±ì„ ì´ìš©í•˜ì—¬ êµ¬í˜„</u>í•  ìˆ˜ ìˆë‹¤.


    + ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ëŠ” ì„œë¹„ìŠ¤ ì˜¤ë¸Œì íŠ¸ì˜ spec.sessionAffinity í•„ë“œë¥¼ ì´ìš©í•˜ì—¬ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë©°, <u>í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŒŒë“œì— ìš”ì²­ì„ ë¶„ë°°</u>í•œë‹¤.


+ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ëŠ” ë¡œë“œë°¸ëŸ°ì„œì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë³´ë‹¤ ê°„ë‹¨í•˜ê³  ì œí•œì ì¸ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.


    + <u>ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ëŠ” í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œë§Œì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì—, ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ë“±ì˜ ì„¸ì…˜ì„ ìœ ì§€ í•  ìˆ˜ ì—†ë‹¤.</u>


    + ê·¸ë˜ì„œ ingressë‚˜ LoadBalancer ì„œë¹„ìŠ¤ì™€ ê°™ì€ L7 ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œë“œ ë°¸ëŸ°ì„œì˜ ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤.


![111](https://user-images.githubusercontent.com/42735894/144751653-0c6fbea5-e55b-4f65-8305-915fc91e9773.PNG){: width="70%" height="70%"}{: .align-center}


<br>


### (1) ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°ë¥¼ ì„¤ì •í•˜ëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸


+ "nginx.ingress.kubernetes.io/affinity: 'cookie'" : ì„¸ì…˜ ì–´í”¼ë‹ˆí‹° í™œì„±í™”


```bash
cat <<EOF > ingress-session.yaml
cat ingress-session.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress
  annotations:
    kubernetes.io/ingress.class: 'nginx'
    nginx.ingress.kubernetes.io/affinity: 'cookie'
spec:
  rules:
  - host: abc.sample.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: session-svc
            port:
              number: 9080
EOF
```


### (2) Test ìš© Deployment ë§¤ë‹ˆí˜ìŠ¤íŠ¸

```bash
cat <<EOF > session-test.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: session-deployment
spec:
  selector:
    matchLabels:
      app: session
  replicas: 10
  template:
    metadata:
      labels:
        app: session
    spec:
      containers:
        - image: 'maho/session-test:latest'
          name: session
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: session-svc
spec:
  selector:
    app: session
  ports:
    - port: 9080
      targetPort: 80
EOF
```


### (3) ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©

```bash
$ kubectl get all,ingress
NAME                                      READY   STATUS    RESTARTS   AGE
pod/session-deployment-79977b8778-268rk   1/1     Running   0          111s
pod/session-deployment-79977b8778-2r2hz   1/1     Running   0          111s
pod/session-deployment-79977b8778-4x2l5   1/1     Running   0          111s
pod/session-deployment-79977b8778-6ljlp   1/1     Running   0          111s
pod/session-deployment-79977b8778-gvhq8   1/1     Running   0          111s
pod/session-deployment-79977b8778-hdq6w   1/1     Running   0          111s
pod/session-deployment-79977b8778-k9fml   1/1     Running   0          111s
pod/session-deployment-79977b8778-nxlnt   1/1     Running   0          111s
pod/session-deployment-79977b8778-trmbs   1/1     Running   0          111s
pod/session-deployment-79977b8778-wn2rf   1/1     Running   0          111s

NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/kubernetes    ClusterIP   10.96.0.1        <none>        443/TCP    6h10m
service/session-svc   ClusterIP   10.110.133.243   <none>        9080/TCP   111s

NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/session-deployment   10/10   10           10          111s

NAME                                            DESIRED   CURRENT   READY   AGE
replicaset.apps/session-deployment-79977b8778   10        10        10      111s

NAME                                      CLASS    HOSTS            ADDRESS           PORTS   AGE
ingress.networking.k8s.io/hello-ingress   <none>   abc.sample.com   192.168.219.190   80      4m1s
```


### (4) ê²°ê³¼ í™•ì¸

+ curl -c ì˜µì…˜ : ìš”ì²­ì„ ë³´ë‚´ê³ , ì‘ë‹µ ì¿ í‚¤ë¥¼ íŒŒì¼ì— ì €ì¥

+ curl -b ì˜µì…˜ : ì €ì¥í•œ ì¿ í‚¤ë¥¼ í—¤ë”ì— ì¶”ê°€í•´ì„œ ìš”ì²­

+ ì¿ í‚¤ ê°’ì— ë”°ë¼ íŒŒë“œê°€ ê²°ì •ë˜ì–´ ì¹´ìš´íŠ¸ ê°’ì´ ì¦ê°€í•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```bash
$  curl -c cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
1th time access.

$ curl -b cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
2th time access.

$ curl -b cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
3th time access.

$ curl -b cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
4th time access.

$ curl -b cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
5th time access.

$ curl -b cookie.dat http://abc.sample.com
Hostname: session-deployment-79977b8778-79lrc<br>
6th time access.
```