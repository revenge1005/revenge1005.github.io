---
title:  "[Redundancy] 06. HAProxy 구성"

categories:
  - REDUNDANCY
tags:
  - [linux, redundancy]

toc: true
toc_sticky: true

date: 2023-05-30
last_modified_at: 2022-05-30
---
<br>

# 06-1. HAProxy 기본 설치 및 설정(CentOS 8 Stream 기준)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 18pt;
}
small { 
    font-size: 18px 
}
</style>

<br>

```
-----------+---------------------------+--------------------------+------------
           |                           |                          |
           |192.168.219.134            |192.168.219.135           |192.168.219.136
+----------+-----------+   +-----------+----------+   +-----------+----------+
|   [ dlp.test.srv ]   |   | [ node01.test.srv ]  |   | [ node02.test.srv ]  |
|        HAProxy       |   |      Web Server#1    |   |      Web Server#2    |
+----------------------+   +----------------------+   +----------------------+
```

<br>

<big> **■ HAProxy 설치** </big> <br>

```bash
[root@dlp ~]# dnf -y install haproxy
```

<br>

<big> **■ HAProxy 설정** </big> <br>

```bash
[root@dlp ~]# vi /etc/haproxy/haproxy.cfg
# 기존 [frontend ***] [backend ***] 섹션에 대해 모두 주석 처리하고 끝에 다음을 추가
# 프런트엔드 정의
frontend http-in
    bind *:80
    # 기본 백엔드 설정
    default_backend    backend_servers
    # X-Forwarded-For 헤더 보내기
    option             forwardfor

# 백엔드 정의
backend backend_servers
    # 부하분산 알고리즘 - 라운드로빈 설정
    balance            roundrobin
    # 백엔드 서버 정의
    server             node01 192.168.219.135:80 check
    server             node02 192.168.219.136:80 check
```

<br>

<big> **■ HAProxy 시작 및 HAProxy가 수신하는 포트 허용** </big> <br>

```bash
[root@dlp ~]# {
    systemctl enable --now haproxy
    firewall-cmd --add-service=http --permanent
    firewall-cmd --reload
}
```

<br>

<big> **■ HAproxy의 기본 설정에 따라 로그는 [local2]으로 전송되므로 파일에 기록하도록 Rsyslog를 구성** </big> <br>

```bash
[root@dlp ~]# vi /etc/rsyslog.conf
# 19,20행 : 주석을 제거하고 한 줄 추가
module(load="imudp") # needs to be done just once
input(type="imudp" port="514")
$AllowedSender UDP, 127.0.0.1
# 46행 : 다음과 같이 변경
*.info;mail.none;authpriv.none;cron.none;local2.none    /var/log/messages
local2.*                                                /var/log/haproxy.log


[root@dlp ~]# systemctl restart rsyslog
```

<br>

<big> **■ 백엔드 웹 서버(httpd)의 설정을 X-Forwarded-For 헤더 로깅으로 변경** </big> <br>

> "X-Forwarded-For(XFF)" 헤더는 HTTP 프록시나 로드 밸런서를 통해 웹 서버에 접속하는 클라이언트의 원 IP 주소를 식별하는 사실상의 표준 헤더이다. 클라이언트와 서버 중간에서 트래픽이 프록시나 로드 밸런서를 거치면, 서버 접근 로그에는 프록시나 로드 밸런서의 IP 주소만을 담고 있다. 클라이언트의 원 IP 주소를 보기위해 X-Forwarded-For 요청 헤더가 사용된다.

```bash
[root@node01 ~]# vi /etc/httpd/conf/httpd.conf
# 199행 : 다음과 같이 변경
LogFormat "\"%{X-Forwarded-For}i\" %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined


[root@node01 ~]# systemctl restart httpd
```

<br>

<big> **■ 결과 확인** </big> <br>

![555eewww](https://github.com/revenge1005/System-Redundancy/assets/42735894/45a1e7a6-96fd-4bbb-b578-2984990e6106){: width="90%" height="90%"}{: .align-center}