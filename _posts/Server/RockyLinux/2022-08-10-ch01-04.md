---
title:  "[Rocky] 02. SSH μ„λ²„ - (2)" 

categories:
  - ROCKY
tags:
  - [rocky, linux]

toc: true
toc_sticky: true

date: 2022-08-10
last_modified_at: 2022-08-10
---
<br>

# π”” SFTP μ „μ© + Chroot
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

> SFTP μ „μ© + Chrootλ¥Ό κµ¬μ„±μΌλ΅, μ΄ μ„¤μ •μ΄ μ μ©λ μΌλ¶€ μ‚¬μ©μλ” SFTP λ° chroot λ””λ ‰ν† λ¦¬λ§ μ‚¬μ©ν•μ—¬ μ•΅μ„Έμ¤ν•  μ μμµλ‹λ‹¤.

<br>

<big> **β–  μλ¥Ό λ“¤μ–΄ [/home]μ„ Chroot λ””λ ‰ν„°λ¦¬λ΅ μ„¤μ •** </big>

```bash
# SFTP μ „μ© κ·Έλ£Ή λ§λ“¤κΈ°
$ groupadd sftp_users

$ vi /etc/ssh/sshd_config

# line 138 : μ½”λ©νΈ μ•„μ›ƒ ν›„ λΌμΈ μ¶”κ°€
#Subsystem      sftp    /usr/libexec/openssh/sftp-server
Subsystem       sftp    internal-sftp

Match Group sftp_users
  X11Forwarding no
  AllowTcpForwarding no
  ChrootDirectory /home
  ForceCommand internal-sftp

$ systemctl restart sshd

# [test] μ‚¬μ©μλ¥Ό SFTP μ „μ© μ‚¬μ©μλ΅ μ„¤μ •
$ usermod -aG sftp_users test
```

<br>

<big> **β–  μ‚¬μ©μ μ„¤μ • SFTP μ „μ© μ„¤μ •μΌλ΅ μ‘μ—…ν•λ”μ§€ ν™•μΈ** </big>

```bash
$ ssh test@node01.test.srv
Enter passphrase for key '/home/rocky/.ssh/id_rsa':
This service allows sftp connections only.
Connection to dlp.srv.world closed.   # μ •μƒμ μΌλ΅ κ±°λ¶€λ¨


$ sftp test@node01.test.srv
Enter passphrase for key '/home/test/.ssh/id_rsa':
Connected to node01.test.srv.
sftp>
sftp> ls -l
drwx------    2 1000     1000           62 Apr 16 07:13 test
sftp> pwd
Remote working directory: /
sftp> quit
```

<br><br>

# π”” SSH-Agent
---

> SSH-Agentλ” SSH ν‚¤ μμ λΉ„λ°€ν‚¤λ¥Ό μ•μ „ν•κ² λ³΄κ΄€ν•κ³ , SSH μ ‘μ† μ‹ λΉ„λ°€ν‚¤μ μ…λ ¥ μ—†μ΄ μλ™μΌλ΅ μ ‘μ†μ„ κ°€λ¥ν•κ² ν•΄μ£Όλ” ν”„λ΅κ·Έλ¨

+ SSH μ ‘μ† μ‹, λ³΄ν†µ λΉ„λ°€ν‚¤λ¥Ό μ…λ ¥ν•μ—¬ μΈμ¦μ„ ν•΄μ•Όν•λ”λ° μ΄λ• SSH-Agentλ¥Ό μ‚¬μ©ν•λ©΄, ν•λ² λΉ„λ°€ν‚¤λ¥Ό μ…λ ¥ν•μ—¬ SSH-Agentμ— λ“±λ΅ν•΄λ†“μΌλ©΄ μ΄ν›„ SSH μ ‘μ† μ‹ λΉ„λ°€ν‚¤λ¥Ό μ…λ ¥ν•  ν•„μ” μ—†μ΄ μλ™μΌλ΅ μΈμ¦μ΄ κ°€λ¥ν•λ‹¤.

+ SSH-Agentλ” μ‚¬μ©μκ°€ λ΅κ·ΈμΈν• ν™κ²½μ—μ„λ§ μ‹¤ν–‰λλ©°, μ‚¬μ©μκ°€ λ΅κ·Έμ•„μ›ƒν•λ©΄ SSH-Agentλ„ ν•¨κ» μΆ…λ£λ©λ‹λ‹¤. λ”°λΌμ„ SSH-Agentλ¥Ό μ΄μ©ν•μ—¬ λΉ„λ°€ν‚¤λ¥Ό λ“±λ΅ν•λ©΄, ν•΄λ‹Ή μ‚¬μ©μκ°€ λ΅κ·ΈμΈν• μƒνƒμ—μ„λ§ SSH μ ‘μ†μ΄ κ°€λ¥ν•λ‹¤.

+ SSH-Agentλ¥Ό μ‚¬μ©ν•λ©΄, SSH μ ‘μ† μ‹ λΉ„λ°€ν‚¤λ¥Ό λ°λ³µν•΄μ„ μ…λ ¥ν•λ” λ²κ±°λ΅μ›€μ„ ν•΄κ²°ν•  μ μμΌλ©°, λ³΄μ•μ„±λ„ λ†’μΌ μ μλ‹¤.

<br>

<big> **β–  SSH ν†µμ‹  κ³Όμ •** </big>


1. ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ— μ—°κ²° μ”μ²­μ„ ν•©λ‹λ‹¤.

2. μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ—κ² κ³µκ°ν‚¤λ¥Ό λ³΄λƒ…λ‹λ‹¤.

3. ν΄λΌμ΄μ–ΈνΈλ” κ³µκ°ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ„λ²„μ— λ€ν• μ•”νΈν™”λ μ„Έμ… ν‚¤λ¥Ό μƒμ„±ν•κ³ , μ΄λ¥Ό μ„λ²„μ—κ² λ³΄λƒ…λ‹λ‹¤.

4. μ„λ²„λ” μμ‹ μ λΉ„λ°€ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ„Έμ… ν‚¤λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤.

5. μ΄μ  μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈλ” μ„Έμ… ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ ν†µμ‹ μ„ ν•©λ‹λ‹¤.

> μ΄λ¥Ό ν†µν•΄ μ¤‘κ°„μ— νƒμ·¨λ  κ°€λ¥μ„±μ΄ μλ” ν¨μ¤μ›λ“ λ“±μ μ •λ³΄λ¥Ό μ•μ „ν•κ² μ „μ†΅ν•  μ μμµλ‹λ‹¤.

<br>

<big> **β–  SSH-Agentλ¥Ό μ‚¬μ©ν–μ„ λ•μ ν†µμ‹  κ³Όμ •** </big>


1. ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ— μ—°κ²° μ”μ²­μ„ ν•©λ‹λ‹¤.

2. μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ—κ² κ³µκ°ν‚¤λ¥Ό λ³΄λƒ…λ‹λ‹¤.

3. ν΄λΌμ΄μ–ΈνΈλ” SSH-Agentμ—κ² μμ‹ μ λΉ„λ°€ν‚¤λ¥Ό μ”μ²­ν•©λ‹λ‹¤.

4. SSH-Agentλ” μ”μ²­μ— λ€ν•΄ μΈμ¦λ λΉ„λ°€ν‚¤λ¥Ό μ κ³µν•©λ‹λ‹¤.

5. ν΄λΌμ΄μ–ΈνΈλ” SSH-Agentλ΅λ¶€ν„° λ°›μ€ μΈμ¦λ λΉ„λ°€ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ„λ²„μ— λ€ν• μ„Έμ… ν‚¤λ¥Ό μƒμ„±ν•κ³ , μ΄λ¥Ό μ„λ²„μ—κ² λ³΄λƒ…λ‹λ‹¤.

6. μ„λ²„λ” μμ‹ μ λΉ„λ°€ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ„Έμ… ν‚¤λ¥Ό λ³µνΈν™”ν•©λ‹λ‹¤.

7. μ΄μ  μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈλ” μ„Έμ… ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ ν†µμ‹ μ„ ν•©λ‹λ‹¤.

> μ¦‰, SSH-Agentλ¥Ό μ‚¬μ©ν•λ” κ²½μ°, ν΄λΌμ΄μ–ΈνΈλ” λΉ„λ°€ν‚¤λ¥Ό μ§μ ‘ μ‚¬μ©ν•μ§€ μ•κ³ , SSH-Agentλ¥Ό ν†µν•΄ λΉ„λ°€ν‚¤λ¥Ό μ”μ²­ν•κ³ , SSH-Agentλ” μΈμ¦λ λΉ„λ°€ν‚¤λ¥Ό μ κ³µν•μ—¬ μ„Έμ… ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ λΉ„λ°€ν‚¤κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² λ…Έμ¶λμ§€ μ•μΌλ―€λ΅ λ”μ± μ•μ „ν• SSH ν†µμ‹ μ΄ κ°€λ¥ν•©λ‹λ‹¤.

<br>

<big> **β–  ν΄λΌμ΄μ–ΈνΈμ—μ„ SSH ν‚¤ μμ„ μƒμ„±ν•κ³  κ³µκ° ν‚¤λ¥Ό μ„λ²„μ— λ³µμ‚¬** </big>

```bash
[root@node01 ~]# ssh-keygen -t ed25519
[root@node01 ~]# ssh-copy-id dlp.test.srv
```

<br>

<big> **β–  ν΄λΌμ΄μ–ΈνΈμ—μ„ ssh-agent λ¥Ό μ‹μ‘ν•κ³  ssh-add λ…λ ΉμΌλ΅ ν‚¤λ¥Ό μ¶”κ°€** </big>

```bash
[root@node01 ~]# eval $(ssh-agent)
Agent pid 1640

[root@node01 ~]# ssh-add ~/.ssh/id_ed25519
Identity added: /root/.ssh/id_ed25519 (root@node01.test.srv)

[root@node01 ~]# ssh-add -l
256 SHA256:YAs49pPOQucRDEUE5OWsAk4E+bFXx/gRgdnC2ICc3qQ root@node01.test.srv (ED25519)

[root@node01 ~]# ssh dlp.test.srv hostname
dlp.test.srv


```