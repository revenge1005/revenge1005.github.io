---
title:  "[Retry, k8s] 06-3. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  ë³¼ë¥¨ í”„ë¡œë¹„ì €ë‹(CephFS) - (3)"

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-09-02
last_modified_at: 2023-09-02
---
# [Retry, k8s] 06-3. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  ë³¼ë¥¨ í”„ë¡œë¹„ì €ë‹(CephFS) - (3)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” kubernetesì— ceph-csi êµ¬ì„± (Helm chartë¡œ ì„¤ì¹˜í•˜ê³  ì‚¬ìš©í•˜ê¸°)

> [(í•´ë‹¹ í˜ì´ì§€ ì°¸ê³ í•¨)](https://devocean.sk.com/blog/techBoardDetail.do?ID=163924) ceph-csiëŠ” ceph ì»¤ë®¤ë‹ˆí‹°ì—ì„œ kubernetesì˜ ì €ì¥ì†Œ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ [cephìš© êµ¬í˜„ì²´](https://github.com/ceph/ceph-csi)ì´ë‹¤. <br><br>
Ceph CSI í”ŒëŸ¬ê·¸ì¸ì€ container orchestrator(kubernetes)ì™€ ceph í´ëŸ¬ìŠ¤í„°ê°„ ì¸í„°í˜ì´ìŠ¤ì— ëŒ€í•œ êµ¬í˜„ì´ë‹¤. <br><br>
eph ë³¼ë¥¨ì„ ë™ì ìœ¼ë¡œ ë°°í¬í•˜ê³  ì›Œí¬ë¡œë“œì™€ ì—°ê²°ì‹œí‚¨ê³ , cephì˜ ë‹¤ì–‘í•œ ì œê³µê¸°ëŠ¥ì¸ [rbd(rbd ë¬¸ì„œ ì°¸ì¡°)](https://github.com/ceph/ceph-csi/blob/devel/docs/deploy-rbd.md)ì™€ [cephfs ë³¼ë¥¨(cephFS ë¬¸ì„œì°¸ì¡°)](https://github.com/ceph/ceph-csi/blob/devel/docs/deploy-cephfs.md), nfs ë³¼ë¥¨ì„ ì§€ì›í•œë‹¤.

<br>

### (1) Helm repo

> <https://github.com/ceph/ceph-csi/tree/devel/charts/ceph-csi-cephfs>

```bash
root@k8s-master:~# helm repo add ceph-csi https://ceph.github.io/csi-charts


root@k8s-master:~# helm search repo ceph-csi
NAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       
ceph-csi/ceph-csi-cephfs        3.6.1           3.6.1           Container Storage Interface (CSI) driver, provi...
ceph-csi/ceph-csi-rbd           3.6.1           3.6.1           Container Storage Interface (CSI) driver, provi...helm repo add ceph-csi https://ceph.github.io/csi-charts
```


### (2) í™˜ê²½ë°˜ì˜

> Helm ì„¤ì¹˜ë¥¼ ìœ„í•´ í™˜ê²½ì— ë§ë„ë¡ ê°’ ì¬ì§€ì •(value-override) íŒŒì¼ì„ ì¤€ë¹„í•˜ì. ì „ì²´ ê°’ì€ ë‹¤ìŒ ë§í¬(<https://github.com/ceph/ceph-csi/tree/devel/charts/ceph-csi-rbd#configuration>)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ê³  ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì—°ê²°í•œ ceph í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ monitorë§Œ ì§€ì •í•œë‹¤. ê·¸ ì™¸ storage classë“±ì„ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë‚˜ ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë”°ë¡œ ì¶”ê°€í•œë‹¤.

```bash
root@k8s-master:~# cat <<EOF > ceph-csi.vo
csiConfig:
- clusterID: "3adf5d85-7d69-455d-82cf-f799e63981e4"
  monitors:
  - "192.168.219.51:6789"
EOF
```


### (3) ì„¤ì¹˜í•˜ê¸° (í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ì„¤ì¹˜í•˜ëŠ”ë° ì‹œê°„ì´ ì¢€ ê±¸ë¦¼)

```bash
root@k8s-master:~# kubectl create namespace "ceph-csi-cephfs"

root@k8s-master:~# helm install --namespace "ceph-csi-cephfs" "ceph-csi-cephfs" ceph-csi/ceph-csi-cephfs -f ceph-csi.vo

root@k8s-master:~# kubectl get all -n ceph-csi-cephfs
```


### (4) secret êµ¬ì„± ë° ë°°í¬

> **â˜… ì£¼ì˜-1 : 23-09-01 (k8s 1.28ë²„ì „, ceph-csi 3.9.0 ë²„ì „) ê¸°ì¤€ - ì´ì „ ë²„ì „ê¹Œì§€ëŠ” secretì„ ì•„ë¬´ ê³³ì´ë‚˜ ì €ì¥í•´ë„ í•´ë‹¹ ì˜ˆì œê°€ ì˜ë˜ì—ˆìœ¼ë‚˜, í˜„ì¬ ìµœì‹  ë²„ì „ì—ì„œëŠ” kube-systemì—ë§Œ ì €ì¥í•´ì•¼ í•œë‹¤. <br><br> ë§Œì•½ ë‹¤ë¥¸ ê³³ì— ì €ì¥í•˜ë©´ í•´ë‹¹ ì—ëŸ¬ ë°œìƒ : "unable to get monitor info from DNS SRV with service name: ceph-mon [errno 2] RADOS object not found (error connecting to the cluster)"**

> **â˜… ì£¼ì˜-2 : k8s 1.28 ë²„ì „ ë¶€í„°ëŠ” cephfs, rbdëŠ” "deprecated(ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ) [(k8s ë³¼ë¥¨ ë¬¸ì„œ cephfs)](https://kubernetes.io/docs/concepts/storage/volumes/#cephfs), [(k8s ë³¼ë¥¨ ë¬¸ì„œ rbd)](https://kubernetes.io/docs/concepts/storage/volumes/#rbd)" í‘œì‹œë˜ì–´ ìˆì§€ë§Œ, ceph-csië¥¼ í†µí•´ì„œëŠ” ì•„ì§ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.<br><br> ì´í›„ ì§€ì›ì´ ê³„ì† ë  ìˆ˜ë„ ìˆê³ , ì•ˆë  ìˆ˜ ë„ ìˆìœ¼ë‹ˆ k8s ê³µì‹ ë¬¸ì„œì™€ ceph-csi(github) í”„ë¡œì íŠ¸ë¥¼ í™•ì¸í•˜ì.**

```bash
# userkeyëŠ” ceph í´ëŸ¬ìŠ¤íŠ¸ì˜ ê´€ë¦¬ ë…¸ë“œì—ì„œ "ceph auth list" ëª…ë ¹ìœ¼ë¡œ í™•ì¸
root@k8s-master:~# cat csi-fs-secret.yaml 
---
apiVersion: v1
kind: Secret
metadata:
  name: csi-fs-secret
  namespace: kube-system
stringData:
  userID: cephfs
  userKey: AQBgJ1Rg9DMzEhAA/y3+g2tDGHOujxPVjFHS6A==
  adminID: admin
  adminKey: AQBs/FJgC6z2OhAAoPp0WFfPvhp0DiLEKk01xw==


root@k8s-master:~# kubectl apply -f csi-fs-secret.yaml 
```


### (5) StorageClass êµ¬ì„± ë° ë°°í¬í•˜ê³ 

```bash
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
   name: csi-fs-sc
allowVolumeExpansion: true
provisioner: cephfs.csi.ceph.com
parameters:
   clusterID: 3adf5d85-7d69-455d-82cf-f799e63981e4
   fsName: kubernetes
   csi.storage.k8s.io/controller-expand-secret-name: csi-fs-secret
   csi.storage.k8s.io/controller-expand-secret-namespace: kube-system
   csi.storage.k8s.io/provisioner-secret-name: csi-fs-secret
   csi.storage.k8s.io/provisioner-secret-namespace: kube-system
   csi.storage.k8s.io/node-stage-secret-name: csi-fs-secret
   csi.storage.k8s.io/node-stage-secret-namespace: kube-system
reclaimPolicy: Delete
mountOptions:
   - debug

root@k8s-master:~# kubectl apply -f csi-fs-sc.yaml 
```


### (6) pvc ìƒì„± ë° ë°°í¬

```bash
root@k8s-master:~# cat fs-pvc.yaml 
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: csi-cephfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: csi-fs-sc


root@k8s-master:~# kubectl apply -f fs-pvc.yaml 
```


### (7) í™•ì¸

```bash
# k8s í´ëŸ¬ìŠ¤í„°ì˜ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í™•ì¸
root@k8s-master:~# kubectl get sc,pvc,pv
NAME                                    PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
storageclass.storage.k8s.io/csi-fs-sc   cephfs.csi.ceph.com   Delete          Immediate           true                   2m3s

NAME                                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/csi-cephfs-pvc   Bound    pvc-2a95b26a-df5b-4d36-b13e-7f1ed6791b35   1Gi        RWX            csi-fs-sc      106s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
persistentvolume/pvc-2a95b26a-df5b-4d36-b13e-7f1ed6791b35   1Gi        RWX            Delete           Bound    default/csi-cephfs-pvc   csi-fs-sc               103s
```


### (8) pod ìƒì„± ë° ë°°í¬

```bash
root@k8s-master:~# cat pod.yaml
---
apiVersion: v1
kind: Pod
metadata:
  name: csi-cephfs-demo-pod
spec:
  containers:
    - name: web-server
      image: docker.io/library/nginx:latest
      volumeMounts:
        - name: mypvc
          mountPath: /var/lib/www
  volumes:
    - name: mypvc
      persistentVolumeClaim:
        claimName: csi-cephfs-pvc
        readOnly: false


root@k8s-master:~# kubectl apply -f fs-pvc.yaml 


root@k8s-master01:~/k8s# kubectl get all,sc,pvc,pv
NAME                      READY   STATUS    RESTARTS   AGE
pod/csi-cephfs-demo-pod   1/1     Running   0          9s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   3h18m

NAME                                    PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
storageclass.storage.k8s.io/csi-fs-sc   cephfs.csi.ceph.com   Delete          Immediate           true                   2m3s

NAME                                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/csi-cephfs-pvc   Bound    pvc-2a95b26a-df5b-4d36-b13e-7f1ed6791b35   1Gi        RWX            csi-fs-sc      106s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
persistentvolume/pvc-2a95b26a-df5b-4d36-b13e-7f1ed6791b35   1Gi        RWX            Delete           Bound    default/csi-cephfs-pvc   csi-fs-sc               103s
```

<br>