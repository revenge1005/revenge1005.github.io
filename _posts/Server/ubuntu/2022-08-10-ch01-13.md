---
title:  "[Ubuntu] 13. iSCSI Target/initiator" 

categories:
  - UBUNTU
tags:
  - [ubuntu, linux]

toc: true
toc_sticky: true

date: 2023-05-23
last_modified_at: 2023-05-23
---
<br>

# ğŸ”” iSCSIë€?
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

> iscsiëŠ” ì¸í„°ë„· í”„ë¡œí† ì½œ(IP) ê¸°ë°˜ì˜ ìŠ¤í† ë¦¬ì§€ ë„¤íŠ¸ì›Œí‚¹ í‘œì¤€ìœ¼ë¡œ, ë°ì´í„° ìŠ¤í† ë¦¬ì§€ ì¥ì¹˜ë¥¼ ì—°ê²°í•˜ëŠ”ë° ì‚¬ìš© ì¦‰, IP ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ SCSI ëª…ë ¹ì„ ì „ë‹¬í•¨ìœ¼ë¡œì¨, ì¸í„°ë„·ì„ ê±°ì³ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê³  ë³´ê´€í•˜ê²Œ ëœë‹¤.

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target)/ì´ë‹ˆì‹œì—ì´í„°(initiator)** </big>

<br>

+ **íƒ€ê²Ÿ(Target) :** iscsi ì„œë²„ë¡œì„œ ìŠ¤í† ë¦¬ì§€ë¥¼ ì œê³µí•˜ëŠ” ì—­í• 


+ **ì´ë‹ˆì‹œì—ì´í„°(initiator) :** iscsi í´ë¼ì´ì–¸íŠ¸ë¡œì„œ ìŠ¤í† ë¦¬ì§€ì— ì ‘ê·¼í•˜ëŠ” ì—­í• 


<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target)/ì´ë‹ˆì‹œì—ì´í„°(initiator)** </big>

<br>

+ íƒ€ê²Ÿê³¼ ì´ë‹ˆì‹œì—ì´í„°ëŠ” **IQN(iSCSI Qualified Name)ì´ë¼ëŠ” ê³ ìœ í•œ ì´ë¦„ìœ¼ë¡œ ì‹ë³„í•œë‹¤.** (ì˜ˆì‹œ : iqn.2022-08.com.test:target)

    |í¬ë§· í˜•íƒœ|Type.Date.Naming_Auth:String_defined_by_example.com_Naming_authority|
    |:---:|:---|
    |Type|iqnìœ¼ë¡œ ê³ ì •|
    |Date|YYYY-MM|
    |Naming_Auth|ë„ë©”ì¸ì˜ ì—­ìˆœ í˜•íƒœ|
    |String_...|ì„¤ëª…|

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target) êµ¬ì¡°** </big>

<br>

**1) backstores**


+ ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, íŒŒì¼ì´ë‚˜ ë””ìŠ¤í¬ì™€ ê°™ì€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ìƒí™”í•œë‹¤.


+  backstoresì—ëŠ” fileio, block, pscsi, ramdisk ë“±ì˜ í•˜ìœ„ ë…¸ë“œê°€ ìˆë‹¤.


    |í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |fileio|íŒŒì¼ì„ ë””ìŠ¤í¬ ì´ë¯¸ì§€ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|
    |block|ë¬¼ë¦¬ì ì¸ ë””ìŠ¤í¬ ë¸”ë¡ ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|
    |pscsi|ë¡œì»¬ SCSI ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜, ë””ìŠ¤í¬ë¿ë§Œ ì•„ë‹ˆë¼ í…Œì´í”„ë‚˜ CD-ROMê³¼ ê°™ì€ ë‹¤ì–‘í•œ ì¥ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë‹¤.|
    |ramdisk|ë©”ëª¨ë¦¬ë¥¼ ë””ìŠ¤í¬ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì˜ ì¢…ë¥˜|


    |ê·¸ ì™¸ í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |alua|Asymmetric Logical Unit Accessì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ìƒíƒœì™€ ìš°ì„  ìˆœìœ„ë¥¼ ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥|
    |default_tg_pt_gp|Target Port Groupì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ì ‘ê·¼ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´|

<br>

**2) iscsi**

+ iscsi íƒ€ê²Ÿì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, IQNìœ¼ë¡œ ì‹ë³„ëœë‹¤.

+ iscsiì—ëŠ” íƒ€ê²Ÿì˜ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” í•˜ìœ„ ë…¸ë“œê°€ ìˆìœ¼ë©°, ê·¸ ì•ˆì—ëŠ” TPG, LUN, ACL ë“±ì˜ í•˜ìœ„ ë…¸ë“œê°€ ìˆë‹¤.


    |í•˜ìœ„ ë…¸ë“œ|ì„¤ëª…|
    |:---:|:---|
    |TPG|Target Portal Groupì˜ ì•½ìë¡œ, íƒ€ê²Ÿì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë„¤íŠ¸ì›Œí¬ í¬í„¸ì˜ ê·¸ë£¹ìœ¼ë¡œ TPGì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” acls, luns, portalsì´ ìˆë‹¤.|
    |acls|Access Control Listì˜ ì•½ìë¡œ, ì´ë‹ˆì‹œì—ì´í„°ì˜ ì ‘ê·¼ ê¶Œí•œì„ ì œì–´í•˜ëŠ” ëª©ë¡ìœ¼ë¡œ aclsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” ì´ë‹ˆì‹œì—ì´í„°ì˜ IQNì´ ìˆìœ¼ë©°, ê·¸ ì•ˆì—ëŠ” mapped_lunì´ ìˆë‹¤.|
    |luns|Logical Unit Numberì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì™€ ì´ë‹ˆì‹œì—ì´í„°ì˜ ì—°ê²°ì„ ë‚˜íƒ€ë‚´ëŠ” ìˆ«ì, lunsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” lun0, lun1 ë“±ì´ ìˆë‹¤.|
    |portals|ë„¤íŠ¸ì›Œí¬ í¬í„¸ì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´, portalsì˜ í•˜ìœ„ ë…¸ë“œë¡œëŠ” IP ì£¼ì†Œì™€ í¬íŠ¸ ë²ˆí˜¸ê°€ ìˆë‹¤.|

    |ê·¸ ì™¸...|ì„¤ëª…|
    |:---:|:---|
    |LUN|Logical Unit Numberì˜ ì•½ìë¡œ, ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì™€ ì´ë‹ˆì‹œì—ì´í„°ì˜ ì—°ê²°ì„ ë‚˜íƒ€ë‚´ëŠ” ìˆ«ì, LUNì€ íƒ€ê²Ÿê³¼ ì´ë‹ˆì‹œì—ì´í„°ì—ì„œ ë™ì¼í•œ ê°’ì„ ê°€ì§„ë‹¤.|
    |mapped_lun|ì´ë‹ˆì‹œì—ì´í„°ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” LUNì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´, mapped_lunì€ ì´ë‹ˆì‹œì—ì´í„°ë³„ë¡œ ë‹¤ë¥¸ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.|

<br>

**3) loopback**

+ loopback íƒ€ê²Ÿì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë…¸ë“œë¡œ, ë¡œì»¬ ì‹œìŠ¤í…œì—ì„œ ìŠ¤í† ë¦¬ì§€ ì˜¤ë¸Œì íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

<br>

<big> **â–  iSCSI íƒ€ê²Ÿ(Target) êµ¬ì„± - (Targetcli)** </big>

![233286083-49312aed-1d86-48ef-ad69-fef90fd077c0](https://github.com/revenge1005/kubernetes_build_ansible_playbook/assets/42735894/88028853-1069-4226-a240-d738bf3eac71)

```bash
$ apt -y install targetcli-fb


$ mkdir /var/lib/iscsi_disks


# ê´€ë¦¬ì ì½˜ì†”ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
$ targetcli


/> cd backstores/fileio 


# [disk01]ì´ë¼ëŠ” ì´ë¦„ì˜ 1Gì˜ ë””ìŠ¤í¬ ì´ë¯¸ì§€([/var/lib/iscsi_disks/disk01.img])ë¥¼ ìƒì„±
/backstores/fileio> create disk01 /var/lib/iscsi_disks/disk01.img 1G
Created fileio disk01 with size 1073741824
/backstores/fileio> cd /iscsi


# íƒ€ê²Ÿ(Target) ìƒì„±
# [ iqn.(year)-(month).(reverse of domain name):(any name you like) ]
/iscsi> create iqn.2022-08.com.test:dlp.target01
Created target iqn.2022-08.com.test:dlp.target01.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
/iscsi> cd iqn.2022-08.com.test:dlp.target01/tpg1/luns


# LUN ì„¤ì •
/iscsi/iqn.20...t01/tpg1/luns> create /backstores/fileio/disk01
Created LUN 0.
/iscsi/iqn.20...t01/tpg1/luns> cd ../acls


# ACL ì„¤ì •(ì—°ê²°ì„ í—ˆìš©í•˜ëŠ” ì´ë‹ˆì‹œì—ì´í„°(initiator)ì˜ IQN)
/iscsi/iqn.20...t01/tpg1/acls> create iqn.2022-08.com.test:node01.initiator01
Created Node ACL for iqn.2022-08.com.test:node01.initiator01
Created mapped LUN 0.
/iscsi/iqn.20...t01/tpg1/acls> cd iqn.2022-08.com.test:node01.initiator01


# ì¸ì¦ì„ ìœ„í•œ ì‚¬ìš©ì ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
/iscsi/iqn.20...1.initiator01> set auth userid=username
Parameter userid is now 'username'.
/iscsi/iqn.20...1.initiator01> set auth password=password
Parameter password is now 'password'.
/iscsi/iqn.20...1.initiator01> exit
Global pref auto_save_on_exit=true
Configuration saved to /etc/rtslib-fb-target/saveconfig.json


$ ss -napt | grep 3260
LISTEN 0      256           0.0.0.0:3260         0.0.0.0:*   


$ systemctl enable rtslib-fb-targetctl
```

<br>

<big> **â–  iSCSI ì´ë‹ˆì‹œì—ì´í„°(initiator) êµ¬ì„± - (tgt)** </big>

```bash
$ apt -y install open-iscsi
```

```bash
$ cat /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.2022-08.com.test:node01.initiator01


$ vi /etc/iscsi/iscsid.conf

...
...

# line 58 : ì£¼ì„ í•´ì œ
node.session.auth.authmethod = CHAP

# line 69,70: SCSI ëŒ€ìƒ ì„œë²„ì— ì„¤ì •í•œ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§€ì •
node.session.auth.username = username
node.session.auth.password = password

$ systemctl restart iscsid open-iscsi


$ iscsiadm -m discovery -t sendtargets -p 192.168.219.10


$ iscsiadm -m node -o show


$ iscsiadm -m node --login
Logging in to [iface: default, target: iqn.2022-08.com.test:dlp.target01, portal: 192.168.219.10,3260]
Login to [iface: default, target: iqn.2022-08.com.test:dlp.target01, portal: 192.168.219.10,3260] successful.


$ cat /proc/partitions
major minor  #blocks  name

   7        0     114636 loop0
   7        1      64976 loop1
   7        2      54516 loop2
   7        3      54536 loop3
   7        5      64968 loop5
   8        0   20971520 sda
   8        1       1024 sda1
   8        2    1857536 sda2
   8        3   19110912 sda3
   8       16   20971520 sdb
  11        0    1929660 sr0
 253        0   10485760 dm-0
   8       32    1048576 sdc


$ parted --script /dev/sdc "mklabel gpt"


$ parted --script /dev/sdc "mkpart primary 0% 100%"


$ mkfs.ext4 /dev/sdc1
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 262135 4k blocks and 65536 inodes
Filesystem UUID: 48561690-9b78-41f1-b347-12f89900c40e
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done


$ mount /dev/sdc1 /mnt


$ df -hT
Filesystem                        Type   Size  Used Avail Use% Mounted on
tmpfs                             tmpfs  193M  1.2M  192M   1% /run
/dev/mapper/ubuntu--vg-ubuntu--lv ext4   9.8G  5.5G  3.8G  59% /
tmpfs                             tmpfs  965M     0  965M   0% /dev/shm
tmpfs                             tmpfs  5.0M     0  5.0M   0% /run/lock
/dev/sda2                         ext4   1.8G  253M  1.4G  16% /boot
tmpfs                             tmpfs  193M  4.0K  193M   1% /run/user/0
/dev/sdc1                         ext4   990M   24K  923M   1% /mnt
```