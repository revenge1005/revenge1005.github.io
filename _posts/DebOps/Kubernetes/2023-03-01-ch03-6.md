---
title:  "[KUBERNETES] 15-1. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  í”„ë¡œë¹„ì €ë‹ (GlusterFS + Heketi)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [KUBERNETES] 15-1. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  í”„ë¡œë¹„ì €ë‹ (GlusterFS + Heketi)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” GlusterFS

> GlusterFSëŠ” SDS(Software Defined Storage)ë¡œ, í™•ì¥ì„±(Scale-Out)ì´ ê°€ëŠ¥í•œ NASíŒŒì¼ ì‹œìŠ¤í…œìœ¼ë¡œ, ì´ë”ë„·(Ethernet) ë˜ëŠ” ì¸í”¼ë‹ˆë°´ë“œ(InfiniBand)ë¥¼ í†µí•´ ë‹¤ìˆ˜ì˜ ìŠ¤í† ë¦¬ì§€ë¥¼ í•˜ë‚˜ì˜ ë„¤íŠ¸ì›Œí¬ íŒŒì¼ ì‹œìŠ¤í…œìœ¼ë¡œ í†µí•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

![74626191-469d2400-5192-11ea-9a7d-352d043e1f8d](https://user-images.githubusercontent.com/42735894/225661103-81169217-15dd-420c-80ed-7bd28d1aad54.png){: width="20%" height="20%"}{: .align-center}

<br>

## ğŸ”” Heketi

> HeketiëŠ” GlusterFSì˜ ìˆ˜ëª… ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” RESTful ì¸í„°í˜ì´ìŠ¤ìœ¼ë¡œ, Heketië¥¼ í†µí•´ì„œ GlusterFSì˜ ë…¸ë“œ, ì¥ì¹˜, ë³¼ë¥¨ì„ ì‰½ê²Œ ìƒì„±í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br><br> HeketiëŠ” Kubernetesì™€ ê°™ì€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì™€ ì—°ë™í•˜ì—¬ GlusterFS ë³¼ë¥¨ì„ ë™ì ìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Gluster_Heketi_Management_386133_0116_JCS_new](https://user-images.githubusercontent.com/42735894/225661301-b82e44e2-df19-4f74-93b8-4ad3de9b13d5.png){: width="70%" height="70%"}{: .align-center}

<br>

## ğŸ”” GlusterFS + Heketi [Ubuntu 22.04]

<br>

![eqwewqeqweqw](https://user-images.githubusercontent.com/42735894/226328965-e09f44fa-1ce3-4705-8d08-dd39247cb9ba.png){: width="70%" height="70%"}{: .align-center}

<br>

![212eqwewqe](https://user-images.githubusercontent.com/42735894/226326682-332afa87-7582-45e3-8eac-4e5ed2cea052.PNG)

<br>

### (a) ê¸°ë³¸ ì„¤ì • - All

#### (a-1) ssh ì„¤ì •

```bash
{
  sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  sed -i 's/.*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  systemctl reload sshd
} >/dev/null 2>&1
```

#### (a-2) /etc/hosts íŒŒì¼ ì—…ë°ì´íŠ¸

```bash
cat <<EOF >> /etc/hosts

192.168.219.200 heketi01
192.168.219.201 gluster01
192.168.219.202 gluster02
EOF
```

#### (a-3) ë°©í™”ë²½ í•´ì œ

```bash
{
    systemctl stop ufw
    systemctl disable ufw
}
```

<br>

### (b) GlusterFS ë…¸ë“œ ì„¤ì • - gluster01, gluster02

#### (b-1) GlusterFS ì„¤ì¹˜

```bash
{
  apt install -y software-properties-common
  add-apt-repository ppa:gluster/glusterfs-10
  apt update
  apt install -y glusterfs-server
  systemctl enable --now glusterd
}
```

#### (b-2) GlusterFS Peer ë“±ë¡ - gluster01ì—ì„œ gluster02 peer ë“±ë¡, ì–´ëŠ í•œìª½ì—ì„œë§Œ ë‹¤ë¥¸ ë…¸ë“œë¥¼ ì„¤ì •í•˜ë©´ë¨

```bash
gluster peer probe gluster02
```

#### (b-3) ë“±ë¡í•œ peer ìƒíƒœ í™•ì¸ - 

```bash
gluster peer status
```

<br>

### (c) Heketi ë…¸ë“œ ì„¤ì • - heketi01 

> <https://github.com/heketi/heketi>

#### (c-1) Download Heketi binaries

```bash
{
  cd /tmp
  wget https://github.com/heketi/heketi/releases/download/v10.3.0/heketi-v10.3.0.linux.amd64.tar.gz
  tar zxf heketi*
  mv heketi/{heketi,heketi-cli} /usr/local/bin/
}
```

#### (c-2) Set up user account for heketi

```bash
{
  groupadd -r heketi
  useradd -r -s /sbin/nologin -g heketi heketi
  mkdir {/var/lib,/etc,/var/log}/heketi
}
```

#### (c-3) Create ssh passwordless access to Gluster nodes

> [ì°¸ê³  ë§í¬]<https://askubuntu.com/questions/1409105/ubuntu-22-04-ssh-the-rsa-key-isnt-working-since-upgrading-from-20-04> <br><br> SSH 7.9 ë²„ì „(?) ë¶€í„° RSA ì•Œê³ ë¦¬ì¦˜ì€ ë³´ì•ˆ ì·¨ì•½ì„±ìœ¼ë¡œ ì‚¬ìš©ì´ ì¤‘ë‹¨ë˜ê³  ìˆë‹¤ê³  í•œë‹¤. (ì´ê±° ëª°ë¼ì„œ ì˜¤ë˜ ì‚½ì§ˆí•¨...) í•´ê²°ë²•ì€ 2ê°€ì§€ì´ë©° ë‹¤ìŒê³¼ ê°™ë‹¤. 

##### (c-3-1)

```bash
{
  ssh-keygen -f /etc/heketi/heketi_key -t ed25519 -C "root@heketi" -N ''
  for node in gluster01, gluster02; do
    ssh-copy-id -i /etc/heketi/heketi_key.pub root@$node
  done
}
```

##### (c-3-2)

```bash
# gluster01, gluster02 ë…¸ë“œì— ì„¤ì •
cat <<EOF >> /etc/ssh/sshd_config

HostKeyAlgorithms +ssh-rsa
PubkeyAcceptedKeyTypes +ssh-rsa
EOF
```

```bash
{
  ssh-keygen -f /etc/heketi/heketi_key -t rsa-sha2-512 -b 4096 -N ''
  for node in gluster01 gluster02; do
    ssh-copy-id -i /etc/heketi/heketi_key.pub root@$node
  done
}
```

#### (c-4) Configure heketi

> Edit /etc/heketi/heketi.json, change executor to ssh and update sshexec options as shown below

```bash
"_jwt": "Private keys for access",
	"jwt": {
	  "_admin": "Admin has access to all APIs",
	  "admin": {
	     "_key_comment": "Set the admin key in the next line",
	     "key": "keypassword"
    	  },
	  "_user": "User only has access to /volumes endpoint",
	  "user": {
	     "_key_comment": "Set the user key in the next line",
	     "key": "keypassword"
	  }

	"executor": "ssh", 

	"_sshexec_comment": "SSH username and private key file information",
	"sshexec": {
  	  "keyfile": "/etc/heketi/heketi_key", 
  	  "user": "root", 
  	  "port": "22", 
  	  "fstab": "/etc/fstab" 
	},
```

> ìµœì¢… ë³€ê²½ í›„

```bash
cat <<EOF > /etc/heketi/heketi.json
{
  "_port_comment": "Heketi Server Port Number",
  "port": "8080",

        "_enable_tls_comment": "Enable TLS in Heketi Server",
        "enable_tls": false,

        "_cert_file_comment": "Path to a valid certificate file",
        "cert_file": "",

        "_key_file_comment": "Path to a valid private key file",
        "key_file": "",


  "_use_auth": "Enable JWT authorization. Please enable for deployment",
  "use_auth": false,

  "_jwt": "Private keys for access",
  "jwt": {
    "_admin": "Admin has access to all APIs",
    "admin": {
      "_key_comment": "Set the admin key in the next line",
      "key": "keypassword"
    },
    "_user": "User only has access to /volumes endpoint",
    "user": {
      "_key_comment": "Set the user key in the next line",
      "key": "keypassword"
    }
  },

  "_backup_db_to_kube_secret": "Backup the heketi database to a Kubernetes secret when running in Kubernetes. Default is off.",
  "backup_db_to_kube_secret": false,

  "_profiling": "Enable go/pprof profiling on the /debug/pprof endpoints.",
  "profiling": false,

  "_glusterfs_comment": "GlusterFS Configuration",
  "glusterfs": {
    "_executor_comment": [
      "Execute plugin. Possible choices: mock, ssh",
      "mock: This setting is used for testing and development.",
      "      It will not send commands to any node.",
      "ssh:  This setting will notify Heketi to ssh to the nodes.",
      "      It will need the values in sshexec to be configured.",
      "kubernetes: Communicate with GlusterFS containers over",
      "            Kubernetes exec api."
    ],
    "executor": "ssh",

    "_sshexec_comment": "SSH username and private key file information",
    "sshexec": {
      "keyfile": "/etc/heketi/heketi_key",
      "user": "root",
      "port": "22",
      "fstab": "/etc/fstab"
    },

    "_db_comment": "Database file name",
    "db": "/var/lib/heketi/heketi.db",

     "_refresh_time_monitor_gluster_nodes": "Refresh time in seconds to monitor Gluster nodes",
    "refresh_time_monitor_gluster_nodes": 120,

    "_start_time_monitor_gluster_nodes": "Start time in seconds to monitor Gluster nodes when the heketi comes up",
    "start_time_monitor_gluster_nodes": 10,

    "_loglevel_comment": [
      "Set log level. Choices are:",
      "  none, critical, error, warning, info, debug",
      "Default is warning"
    ],
    "loglevel" : "debug",

    "_auto_create_block_hosting_volume": "Creates Block Hosting volumes automatically if not found or exsisting volume exhausted",
    "auto_create_block_hosting_volume": true,

    "_block_hosting_volume_size": "New block hosting volume will be created in size mentioned, This is considered only if auto-create is enabled.",
    "block_hosting_volume_size": 500,

    "_block_hosting_volume_options": "New block hosting volume will be created with the following set of options. Removing the group gluster-block option is NOT recommended. Additional options can be added next to it separated by a comma.",
    "block_hosting_volume_options": "group gluster-block",

    "_pre_request_volume_options": "Volume options that will be applied for all volumes created. Can be overridden by volume options in volume create request.",
    "pre_request_volume_options": "",

    "_post_request_volume_options": "Volume options that will be applied for all volumes created. To be used to override volume options in volume create request.",
    "post_request_volume_options": ""
  }
}
EOF
```

#### (c-4) Update permissions on heketi directories

```bash
chown -R heketi:heketi {/var/lib,/etc,/var/log}/heketi
```

#### (c-5) Create systemd unit file for heketi

```bash
cat <<EOF >/etc/systemd/system/heketi.service
[Unit]
Description=Heketi Server

[Service]
Type=simple
WorkingDirectory=/var/lib/heketi
EnvironmentFile=-/etc/heketi/heketi.env
User=heketi
ExecStart=/usr/local/bin/heketi --config=/etc/heketi/heketi.json
Restart=on-failure
StandardOutput=syslog
StandardError=syslog

[Install]
WantedBy=multi-user.target
EOF
```

#### (c-6) Enable and start heketi service

```bash
{
  systemctl daemon-reload
  systemctl enable --now heketi
}
```

#### (c-7) Quick verification that heketi is running

> From now on you can run heketi-cli commands as non-root user

```bash
curl localhost:8080/hello; echo
```

#### (c-8) Export environment variables for heketi-cli

```bash
cat <<EOF >> .bashrc

export HEKETI_CLI_USER=admin
export HEKETI_CLI_KEY=keypassword
EOF

source .bashrc
```

<br>

### (d) Heketi ì„œë¹„ìŠ¤ í† í´ë¡œì§€ ìƒì„± ë° ë¡œë”©

> heketi ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í–ˆë‹¤ë©´ glusterfsë¥¼ ì—°ë™í•  ë³¼ë¥¨ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” í† í´ë¡œì§€ë¥¼ ìƒì„±í•œë‹¤. /etc/heketi ë””ë ‰í† ë¦¬ ì•„ë˜ì— topology.json ì´ë¼ëŠ” íŒŒì¼ì„ ìƒì„±í•˜ê³ , ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ì€ ë’¤ í•´ë‹¹ glusterfs ì„œë²„ ì •ë³´ë¥¼ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•´ ì¤€ë‹¤. ê·¸ë¦¬ê³ , heketi-cli topology load ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ ìƒì„±í•œ topology.json íŒŒì¼ì„ ë¡œë”©í•˜ì—¬ gluster ì„œë²„ì˜ ë³¼ë¥¨ ì •ë³´ë¥¼ ì¶”ê°€í•œë‹¤. ì´ë•Œ heketi.jsonì˜ jwt ì„¹ì…˜ì—ì„œ ì„¤ì •í•œ admin ê³¼ admin íŒ¨ìŠ¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì • ì •ë³´ë¥¼ í•¨ê»˜ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤.

```bash
cat <<EOF > /etc/heketi/topology.json 
{
  "clusters": [
    {
      "nodes": [
        {
          "node": {
            "hostnames": {
              "manage": [
                "gluster01"
              ],
              "storage": [
                "gluster01"
              ]
            },
            "zone": 1
          },
          "devices": [
            "/dev/sdb"
          ]
        },
        {
          "node": {
            "hostnames": {
              "manage": [
                "gluster02"
              ],
              "storage": [
                "gluster02"
              ]
            },
            "zone": 1
          },
          "devices": [
            "/dev/sdb"
          ]
        }
      ]
    }
  ]
}
EOF
```

```bash
heketi-cli topology load --json=/etc/heketi/topology.json
```

<br>

### (e) Heketi ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸

#### (e-1) heketi-cli ëª…ë ¹ì–´ë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„° ëª©ë¡ê³¼ ë…¸ë“œ ëª©ë¡ í™•ì¸

```bash
$ heketi-cli cluster list
Clusters:
Id:e0e8a41c1d99ce95771d6edcda4e6f3d [file][block]


$ heketi-cli node list
Id:15135378b26e8de36221f10da7b50edf     Cluster:e0e8a41c1d99ce95771d6edcda4e6f3d
Id:35161430a360e6eb2e21708046dbe8bf     Cluster:e0e8a41c1d99ce95771d6edcda4e6f3d
```

#### (e-2) heketi-cli node info ëª…ë ¹ì–´ë¥¼ í†µí•´ ë…¸ë“œ ì •ë³´ í™•ì¸

```bash
$ heketi-cli node info 15135378b26e8de36221f10da7b50edf
Node Id: 15135378b26e8de36221f10da7b50edf
State: online
Cluster Id: e0e8a41c1d99ce95771d6edcda4e6f3d
Zone: 1
Management Hostname: gluster02
Storage Hostname: gluster02
Devices:
Id:1bbdf4bffc4c069c464bd4be94f215f6   Name:/dev/sdb            State:online    Size (GiB):9       Used (GiB):0       Free (GiB):9       Bricks:0


$ heketi-cli node info 35161430a360e6eb2e21708046dbe8bf
Node Id: 35161430a360e6eb2e21708046dbe8bf
State: online
Cluster Id: e0e8a41c1d99ce95771d6edcda4e6f3d
Zone: 1
Management Hostname: gluster01
Storage Hostname: gluster01
Devices:
Id:b92aafecdfbb7405b62e6ebc9534103b   Name:/dev/sdb            State:online    Size (GiB):9       Used (GiB):0       Free (GiB):9       Bricks:0
```

#### (e-3) heketi-cli volume create ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ 1GB ë³¼ë¥¨ ìƒì„± í…ŒìŠ¤íŠ¸

```bash
$ heketi-cli volume create --size 1 --replica 2
Name: vol_a1f5b9e960f0eb1699cffc49f47178aa
Size: 1
Volume Id: a1f5b9e960f0eb1699cffc49f47178aa
Cluster Id: e0e8a41c1d99ce95771d6edcda4e6f3d
Mount: gluster02:vol_a1f5b9e960f0eb1699cffc49f47178aa
Mount Options: backup-volfile-servers=gluster01
Block: false
Free Size: 0
Reserved Size: 0
Block Hosting Restriction: (none)
Block Volumes: []
Durability Type: replicate
Distribute Count: 1
Replica Count: 2
```

#### (e-4) ìƒì„±ëœ ë³¼ë¥¨ ëª©ë¡ í™•ì¸

```bash
$ heketi-cli volume list
Id:a1f5b9e960f0eb1699cffc49f47178aa    Cluster:e0e8a41c1d99ce95771d6edcda4e6f3d    Name:vol_a1f5b9e960f0eb1699cffc49f47178aa


$ heketi-cli cluster info e0e8a41c1d99ce95771d6edcda4e6f3d
Cluster id: e0e8a41c1d99ce95771d6edcda4e6f3d
Nodes:
15135378b26e8de36221f10da7b50edf
35161430a360e6eb2e21708046dbe8bf
Volumes:
a1f5b9e960f0eb1699cffc49f47178aa
Block: true

File: true


$ heketi-cli volume info a1f5b9e960f0eb1699cffc49f47178aa
Name: vol_a1f5b9e960f0eb1699cffc49f47178aa
Size: 1
Volume Id: a1f5b9e960f0eb1699cffc49f47178aa
Cluster Id: e0e8a41c1d99ce95771d6edcda4e6f3d
Mount: gluster02:vol_a1f5b9e960f0eb1699cffc49f47178aa
Mount Options: backup-volfile-servers=gluster01
Block: false
Free Size: 0
Reserved Size: 0
Block Hosting Restriction: (none)
Block Volumes: []
Durability Type: replicate
Distribute Count: 1
Replica Count: 2
```

<br>