---
title:  "[Retry, k8s] 19. ì„œë¹„ìŠ¤ API - ì¸ê·¸ë ˆìŠ¤(Ingress) (1)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-10-05
last_modified_at: 2023-10-05
---
# [Retry, k8s] 19. ì„œë¹„ìŠ¤ API - ì¸ê·¸ë ˆìŠ¤(Ingress) (1)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

**ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì€ ì™¸ë¶€ë¡œë¶€í„° ë‚´ë¶€ë¡œ ìœ ì…ë˜ëŠ” íŠ¸ë˜í”½ì„ ì¸ê·¸ë ˆìŠ¤(Ingress), ë‚´ë¶€ì—ì„œ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì„ ì´ê·¸ë ˆìŠ¤(Egress)ë¡œ êµ¬ë¶„í•œë‹¤. <br><br>**
**ì‹œì‘í•˜ê¸° ì „ "MetalLB ë‚´ìš©" <https://revenge1005.github.io/kubernetes/ch04-05/#-metallb> í™•ì¸...**
{: .notice--warning}

<br>

## ğŸ”” ì¸ê·¸ë ˆìŠ¤(Ingress)

> k8sì˜ ì¸ê·¸ë ˆìŠ¤ëŠ” ì¸ê·¸ë ˆìŠ¤ API ì˜¤ë¸Œì íŠ¸ì™€ ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ êµ¬ì„±ëœë‹¤.


+ ì¸ê·¸ë ˆìŠ¤ API ì˜¤ë¸Œì íŠ¸ëŠ” ì¸ê·¸ë ˆìŠ¤ API ì˜¤ë¸Œì íŠ¸ëŠ” í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë‚´ë¶€ ì„œë¹„ìŠ¤ë¡œ ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì›í•˜ëŠ” ìƒíƒœë¥¼ ê¸°ìˆ í•˜ëŠ” ê²ƒì´ê³ , ì‹¤ì œë¡œ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€ ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ë¼ê³  ë¶€ë¥´ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ë™ì‘í•˜ëŠ” íŒŒë“œë¡œ íŒŒë“œì´ì§€ë§Œ, í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì¸ê·¸ë ˆìŠ¤ì— ì •ì˜ëœ ê·œì¹™ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ íŒŒë“œë¡œ ì „ë‹¬í•œë‹¤.


+ ê¸°ì¡´ NodePort ë“±ì˜ ì„œë¹„ìŠ¤ëŠ” Layer 4ê¹Œì§€ì˜ ìš”ì²­ë§Œì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì— ëŒ€í•œ ì„¸ë¶€ì ì¸ ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•˜ê¸° ì–´ë µë‹¤.


+ í•˜ì§€ë§Œ ì¸ê·¸ë ˆìŠ¤ëŠ” Layer 7ê¹Œì§€ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, ì™¸ë¶€ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•œ ë¡œë“œ ë°¸ëŸ°ì‹±, TLS/SSL ì¸ì¦ì²˜ë¦¬,  íŠ¹ì • HTTP ê²½ë¡œë‚˜ ë„ë©”ì¸ì˜ ë¼ìš°íŒ… ë“±ì„ ìì„¸í•˜ê²Œ ì •ì˜í•  ìˆ˜ ìˆë‹¤.


![232332](https://user-images.githubusercontent.com/42735894/229810973-4a591284-4ab5-4f3c-bc07-4040ce852a0c.png){: width="70%" height="70%"}{: .align-center}

<br>

## ğŸ”” ì¸ê·¸ë ˆìŠ¤(Ingress)ì˜ ëŒ€í‘œì ì¸ ê¸°ëŠ¥


1. ê¸°ì¡´ì˜ ë¡œë“œë°¸ëŸ°ì„œë‚˜ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ëŒ€ì²´, ê³µê°œ URLê³¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§¤í•‘

2. ë³µìˆ˜ì˜ ë„ë©”ì¸ ì´ë¦„ì„ ê°€ì§€ê³  ê°€ìƒ í˜¸ìŠ¤íŠ¸ ê¸°ëŠ¥

3. í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì—¬ëŸ¬ íŒŒë“œì— ë¶„ì‚°

4. SSL/TSL ì•”í˜¸í™” í†µì‹  HTTPS

5. ì„¸ì…˜ ì–´í”¼ë‹ˆí‹°

<br>

## ğŸ”” ê³µê°œ URLê³¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë§¤í•‘


+ ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” í•˜ë‚˜ì˜ URLì´ì§€ë§Œ ë‚´ë¶€ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì ì ˆíˆ ë¶„ë¦¬ë˜ì–´ ìˆì–´ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¶„í• í•˜ê³  ëŠìŠ¨í•˜ê²Œ ì—°ê²°í•¨ìœ¼ë¡œì¨ ê° ëª¨ë“ˆì˜ ë³€ê²½ì— ì˜í•œ ì˜í–¥ì„ ìµœì†Œí™”í•  ìˆ˜ ìˆê³  ê°œë°œ ìƒì‚°ì„±ì—ë„ ìœ ë¦¬í•˜ë‹¤.


![ì˜ˆì‹œ](https://user-images.githubusercontent.com/42735894/144582635-a1851e47-5e62-47be-b177-4d8279abe3c6.PNG){: width="70%" height="70%"}{: .align-center}

<br>

## ğŸ”” ì¸ê·¸ë ˆìŠ¤(Ingress) ì¢…ë¥˜


### (1) í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•œ ì¸ê·¸ë ˆìŠ¤ (GKE ì¸ê·¸ë ˆìŠ¤, ê·¸ ì™¸ ì—¬ëŸ¬ê°€ì§€)


+ GKE ì²˜ëŸ¼ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•œ ì¸ê·¸ë ˆìŠ¤ì˜ ê²½ìš° ì¸ê·¸ë ˆìŠ¤ ë¦¬ì†ŒìŠ¤ ìƒì„±ë§Œìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì„œì˜ ê°€ìƒ IPê°€ í• ë‹¹ë˜ê³ , ë¡œë“œ ë°¸ëŸ°ì„œê°€ NodePortë¥¼ í†µí•´ íŠ¸ë˜í”½ì„ ì „ì†¡í•œë‹¤.


![2323232](https://user-images.githubusercontent.com/42735894/229482058-38865643-cc4b-41b1-b1f0-05500231c7ab.png){: width="90%" height="90%"}{: .align-center}<br>

### (2) í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì¸ê·¸ë ˆìŠ¤ìš© íŒŒë“œë¥¼ ë°°í¬í•˜ëŠ” ì¸ê·¸ë ˆìŠ¤ (Nginx ì¸ê·¸ë ˆìŠ¤)


+ "í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì¸ê·¸ë ˆìŠ¤ìš© íŒŒë“œë¥¼ ë°°í¬í•˜ëŠ” ì¸ê·¸ë ˆìŠ¤ íŒ¨í„´"ì€ ì¸ê·¸ë ˆìŠ¤ìš© íŒŒë“œì— ëŒ€í•´ LoadBalancer ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , ì¸ê·¸ë ˆìŠ¤ìš© íŒŒë“œê°€ L7 ìˆ˜ì¤€ì˜ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•œ í›„ íŒŒë“œ IP ì£¼ì†Œë¡œ íŠ¸ë˜í”½ì„ ì „ì†¡í•œë‹¤. 


![323232](https://user-images.githubusercontent.com/42735894/229482063-5cfbdff5-dbe8-43d2-850f-e4cc62ed4824.png){: width="90%" height="90%"}{: .align-center}<br>


<br>

## ğŸ”” Nginx ì¸ê·¸ë ˆìŠ¤(Ingress) ì„¤ì¹˜ì „ ì£¼ì˜ì‚¬í•­


<https://kubernetes.github.io/ingress-nginx/deploy/baremetal/>


> **ë² ì–´ë©”íƒˆ í™˜ê²½ì—ì„œëŠ” í´ë¼ìš°ë“œ í™˜ê²½ê³¼ ë‹¬ë¦¬ ë„¤íŠ¸ì›Œí¬ ë¡œë“œ ë°¸ëŸ°ì„œê°€ ì œê³µë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— nginx ingress controllerë¥¼ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì´ ë‹¤ë¥´ë‹¤.**


+ ë² ì–´ë©”íƒˆ í™˜ê²½ì—ì„œ nginx ingress controllerë¥¼ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìˆëŠ”ë°, í•˜ë‚˜ëŠ” MetalLBë¼ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ë„¤íŠ¸ì›Œí¬ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ê³ , ë‹¤ë¥¸ í•˜ë‚˜ëŠ” NodePort, LoadBalancer ë˜ëŠ” HostNetworkì™€ ê°™ì€ ì„œë¹„ìŠ¤ íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.


+ ì—¬ê¸°ì„œëŠ” **MetalLBë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì§„í–‰**í•œë‹¤.


<br>

## ğŸ”” Nginx ì¸ê·¸ë ˆìŠ¤(Ingress) ì„¤ì¹˜

<br>

<https://github.com/kubernetes/ingress-nginx/blob/main/README.md#readme>


<https://kubernetes.github.io/ingress-nginx/deploy/>

<br>

### (1) Nginx ì¸ê·¸ë ˆìŠ¤(Ingress) ì„¤ì¹˜ (MetalLBë¥¼ ì„ í–‰ ì„¤ì¹˜í•´ì•¼ í•¨)

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.7.0/deploy/static/provider/cloud/deploy.yaml
```

### (2) ì„¤ì¹˜ í™•ì¸

```bash
kubectl get all -n ingress-nginx
NAME                                            READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-czb2z        0/1     Completed   0          71s
pod/ingress-nginx-admission-patch-sz6z4         0/1     Completed   2          71s
pod/ingress-nginx-controller-6bdb654777-rqq8l   1/1     Running     0          71s

NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.99.113.110   192.168.219.190   80:30694/TCP,443:30928/TCP   71s
service/ingress-nginx-controller-admission   ClusterIP      10.100.13.201   <none>            443/TCP                      71s

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   1/1     1            1           71s

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-6bdb654777   1         1         1       71s

NAME                                       COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   1/1           14s        71s
job.batch/ingress-nginx-admission-patch    1/1           25s        71s
```

### (3) í…ŒìŠ¤íŠ¸ìš© ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼

```bash
cat <<EOF > app01.yaml
kind: Deployment
metadata:
  name: helloworld-deployment
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: hello-world
    spec:
      containers:
        - image: "strm/helloworld-http"
          name: hello-world-container
          ports:
            - containerPort: 80
  selector:
    matchLabels:
      app: hello-world
---
apiVersion: v1
kind: Service
metadata:
  name: helloworld-svc
spec:
  type: NodePort
  ports:
     -  port: 8080
        protocol: TCP
        targetPort: 80
        nodePort: 31445
  selector:
    app: hello-world
EOF
```

```bash
cat <<EOF > app02.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - image: nginx
          name:  nginx
          ports:
            - containerPort: 80
  selector:
    matchLabels:
      app: nginx
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  selector:
    app: nginx
  ports:
     -  port: 9080
        targetPort: 80
EOF
```

```bash
cat <<EOF > app03.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: java-deployment
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: liberty
    spec:
      containers:
        - image: openliberty/open-liberty:javaee8-ubi-min-amd64
          name:  open-liberty
          ports:
            - containerPort: 9080
              name: httpport
  selector:
    matchLabels:
      app: liberty
---
apiVersion: v1
kind: Service
metadata:
  name: java-svc
spec:
  selector:
    app: liberty
  ports:
     -  port: 9080
        targetPort: 9080
EOF
```

### (4) ì¸ê·¸ë ˆìŠ¤ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„±

+ <https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/>

+ <https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/>

```bash
cat <<EOF > ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-ingress
  annotations:
    kubernetes.io/ingress.class: 'nginx'
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: abc.sample.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: helloworld-svc
            port:
              number: 8080
      - path: /apl2
        pathType: Prefix
        backend:
          service:
            name: nginx-svc
            port:
              number: 9080
  - host: xyz.sample.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: java-svc
            port:
              number:  9080
EOF
```

### (5) ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©

```bash
$ kubectl get all,ingress
NAME                                         READY   STATUS    RESTARTS   AGE
pod/helloworld-deployment-7757b448c4-q2zdd   1/1     Running   0          12m
pod/java-deployment-65f66f77b-gtsgx          1/1     Running   0          12m
pod/nginx-deployment-7f456874f4-2rsn4        1/1     Running   0          12m
pod/nginx-deployment-7f456874f4-kmrf9        1/1     Running   0          12m
pod/nginx-deployment-7f456874f4-vg5pk        1/1     Running   0          12m

NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/helloworld-svc   NodePort    10.103.193.1     <none>        8080:31445/TCP   12m
service/java-svc         ClusterIP   10.103.196.241   <none>        9080/TCP         12m
service/kubernetes       ClusterIP   10.96.0.1        <none>        443/TCP          20m
service/nginx-svc        ClusterIP   10.109.159.252   <none>        9080/TCP         12m

NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/helloworld-deployment   1/1     1            1           12m
deployment.apps/java-deployment         1/1     1            1           12m
deployment.apps/nginx-deployment        3/3     3            3           12m

NAME                                               DESIRED   CURRENT   READY   AGE
replicaset.apps/helloworld-deployment-7757b448c4   1         1         1       12m
replicaset.apps/java-deployment-65f66f77b          1         1         1       12m
replicaset.apps/nginx-deployment-7f456874f4        3         3         3       12m

NAME                                      CLASS    HOSTS                           ADDRESS           PORTS   AGE
ingress.networking.k8s.io/hello-ingress   <none>   abc.sample.com,xyz.sample.com   192.168.219.190   80      11m



$ kubectl describe ingress
Name:             hello-ingress
Labels:           <none>
Namespace:        default
Address:          192.168.219.190
Ingress Class:    <none>
Default backend:  <default>
Rules:
  Host            Path  Backends
  ----            ----  --------
  abc.sample.com
                  /       helloworld-svc:8080 (10.46.0.2:80)
                  /apl2   nginx-svc:9080 (10.40.0.2:80,10.40.0.3:80,10.46.0.3:80)
  xyz.sample.com
                  /   java-svc:9080 (10.46.0.4:9080)
Annotations:      kubernetes.io/ingress.class: nginx
                  nginx.ingress.kubernetes.io/rewrite-target: /
Events:
  Type    Reason  Age                    From                      Message
  ----    ------  ----                   ----                      -------
  Normal  Sync    4m18s (x2 over 4m59s)  nginx-ingress-controller  Scheduled for sync
```

### (5) ê²°ê³¼ í™•ì¸

|OS|hosts ê²½ë¡œ|
|:---:|---|
|ìœˆë„ìš°(windows)|C:\Windows\System32\drivers\etc\hosts|
|ë¦¬ëˆ…ìŠ¤(Linux)|/etc/hosts|

```bash
# hosts íŒŒì¼ì— ì•„ë˜ ë‚´ìš© ì¶”ê°€
192.168.219.190  abc.sample.com xyz.sample.com
```

<br>

![test](https://user-images.githubusercontent.com/42735894/229763468-c5329276-16a7-4782-b845-90eb6b4bcebf.gif){: width="90%" height="90%"}{: .align-center}<br>
