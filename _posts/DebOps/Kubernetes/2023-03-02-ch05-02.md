---
title:  "[Retry, k8s] 22. ì»¨í”¼ê·¸ & ìŠ¤í† ë¦¬ì§€ API - ì‹œí¬ë¦¿" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

---
# ğŸ”” ì‹œí¬ë¦¿
---

> ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì‹œí¬ë¦¿ì€ ì•”í˜¸, í† í° ë˜ëŠ” í‚¤ì™€ ê°™ì€ ì†ŒëŸ‰ì˜ ì¤‘ìš”í•œ ë°ì´í„°ë¥¼ í¬í•¨í•˜ëŠ” ì˜¤ë¸Œì íŠ¸

+ ì‹œí¬ë¦¿ ë¦¬ì†Œì—ì„œëŠ” í•˜ë‚˜ì˜ ì‹œí¬ë¦¿ ì•ˆì— ì—¬ëŸ¬ í‚¤-ë²¨ë¥˜ ê°’ì´ ì €ì¥ëœë‹¤.

+ í•˜ë‚˜ì˜ ì‹œí¬ë¦¿ë‹¹ ì €ì¥ ê°€ëŠ¥í•œ ë°ì´í„° ì‚¬ì´ì¦ˆëŠ” ì´ 1MBë¡œ ì œí•œëœë‹¤.

|ì¢…ë¥˜|ê°œìš”|
|:---:|---|
|Qpaque|ë²”ìš© ìš©ë„|
|kubernetes.io/tls|TLS ì¸ì¦ì„œìš©|
|kubernetes.io/basic|ê¸°ë³¸ ì¸ì¦ìš©|
|kubernetes.io/dockerconfigjson|ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦ ì •ë³´ìš©|
|kubernetes.io/ssh-auth|SSH ì¸ì¦ ì •ë³´ìš©|
|kubernetes.io/service-account-token|ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ í† í°ìš©|
|bootstrap.kubernetes.io/token|Bootstrap í† í°ìš©|

<br>


## (1) ì‹œí¬ë¦¿ íƒ€ì… - ë²”ìš© ìš©ë„ì˜ ì‹œí¬ë¦¿ (Qpaque)

+ ì¼ë°˜ ì‚¬ìš©ìëª…ê³¼ íŒ¨ìŠ¤ì›Œë“œ ê°™ì€ ì¸ì¦ ì •ë³´ ë“±ì˜ **ì„ì˜ì˜ ì‚¬ìš©ì ì •ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ íƒ€ì…**

 
 
 
 
### ğŸ“œ kubectlë¡œ íŒŒì¼ì—ì„œ ê°’ì„ ì°¸ì¡°í•˜ì—¬ ìƒì„±(--from-file)

+ íŒŒì¼ëª…ì´ ê·¸ëŒ€ë¡œ í‚¤ê°€ ë˜ê¸° ë•Œë¬¸ì— í™•ì¥ìëŠ” ë¶™ì´ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤.

+ í™•ì¥ìë¥¼ ë¶™ì¼ ê²½ìš° "--from-file=username=username.txt" ë“±ê³¼ ê°™ì´ ì§€ì •í•œë‹¤.

```bash
# íŒŒì¼ ìƒì„±í•  ë•Œ ê°œí–‰ ì½”ë“œê°€ ë“¤ì–´ê°€ì§€ ì•Šë„ë¡ "echo -n" ì¶œë ¥ ê²°ê³¼ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ íŒŒì¼ì— ì“°ëŠ” ë°©ë²•ì„ ì‚¬ìš©
$ echo -n "root" > ./username
$ echo -n "rootpasswd" > ./password


# íŒŒì¼ì—ì„œ ê°’ì„ ì°¸ì¡°í•˜ì—¬ ì‹œí´ë¦¿ ìƒì„±
$ kubectl create secret generic --save-config sample-db-auth \
--from-file=./username --from-file=./password
secret/sample-db-auth created


# ì‹œí¬ë¦¿ í™•ì¸
$ kubectl get secrets sample-db-auth -o json | jq .data
{
  "password": "cm9vdHBhc3N3ZA==",
  "username": "cm9vdA=="
}


# ë³´í†µì€ base64ë¡œ ì¸ì½”ë“œë˜ì–´ ìˆë‹¤.
$ kubectl get secret sample-db-auth -o json | jq -r .data.username
cm9vdA==


# ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë³€ê²½í•˜ë ¤ë©´ base64ë¡œ ë””ì½”ë“œê°€ í•„ìš”
$ kubectl get secret sample-db-auth -o json | jq -r .data.username | base64 --decode
root
```

 
 
 
 

### ğŸ“œ kubectlë¡œ envfileì—ì„œ ê°’ì„ ì°¸ì¡°í•˜ì—¬ ìƒì„±(--from-env-file)

```bash
$ cat env-secret.txt
username=root
password=rootpassword


$ kubectl create secret generic --save-config sample-db-auth \
--from-env-file ./env-secret.txt
secret/sample-db-auth created
```
 
 
 
 

### ğŸ“œ kubectlë¡œ ì§ì ‘ ê°’ì„ ì „ë‹¬í•˜ì—¬ ìƒì„±(--from-literal)

```bash
$ kubectl create secret generic --save-config sample-db-auth \
--from-literal=username=root --from-literal=password=rootpassword
secret/sample-db-auth created
```
 
 
 
 

### ğŸ“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ìƒì„±(-f)

+ "data"ëŠ” base64ë¡œ ì¸ì½”ë”©ëœ ë¬¸ìì—´ ê°’ìœ¼ë¡œ ë°›ëŠ”ë‹¤.

+ "stringData"ëŠ” í•„ë“œëŠ” ì„ì˜ì˜ ë¬¸ìì—´ì„ ê°’ìœ¼ë¡œ ë°›ëŠ”ë‹¤.

```bash
$ cat <<EOF > sample-db-auth.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sample-db-auth
type: Opaque
data: 
  username: cm9vdA==
  password: cm9vdHBhc3N3ZA=
EOF
```

```bash
$ cat <<EOF > sample-db-auth-nobase64.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sample-db-auth
type: Opaque
stringData: 
  username: root
  password: rootpassword
EOF
```

<br>


## (2) ì‹œí¬ë¦¿ íƒ€ì… - TLS íƒ€ì… ì‹œí¬ë¦¿ (kubernetes.io/tls)

+ **TLS ì—°ê²°ì„ ìœ„í•œ ì¸ì¦ì„œì™€ ê°œì¸ í‚¤ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ íƒ€ì…**

  + TLS íƒ€ì…ì˜ ì‹œí¬ë¦¿ì€ ì¸ê·¸ë ˆìŠ¤ ë¦¬ì†ŒìŠ¤ ë“±ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤.

  + TLS íƒ€ì…ì˜ ì‹œí¬ë¦¿ì€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¡œ ìƒì„±í•  ìˆ˜ ìˆì§€ë§Œ, ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ë°€í‚¤ì™€ ì¸ì¦ì„œ íŒŒì¼ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.


```bash
# ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ ìƒì„±
$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ~/tls.key -out ~/tls.crt -subj "/CN=sample1.example.com"


# ë¹„ë°€í‚¤ì™€ ì¸ì¦ì„œ íŒŒì¼ë¡œ ìƒì„± (--key, --cert) - TLS ì‹œí¬ë¦¿ ìƒì„±
$ kubectl create secret tls --save-config tls-sample --key ~/tls.key --cert ~/tls.crt
```

<br>


## (3) ì‹œí¬ë¦¿ íƒ€ì… - ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ íƒ€ì…ì˜ ì‹œí¬ë¦¿ (kubernetes.io/dockerconfigjson)

+ **ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì¸ì¦í•˜ê¸° ìœ„í•œ ë„ì»¤ êµ¬ì„± íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ íƒ€ì…**

  + ì‚¬ìš©í•˜ê³  ìˆëŠ” ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ê°€ í”„ë¼ì´ë¹— ì €ì¥ì†Œì¸ ê²½ìš°, ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ ì¸ì¦ì´ í•„ìš”í•˜ë‹¤.

  + ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” ì´ ì¸ì¦ ì •ë³´ë¥¼ ì‹œí´ë¦¿ìœ¼ë¡œ ì •ì˜í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

  + ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦ìš© ì‹œí¬ë¦¿ë„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¡œ ìƒì„±í•  ìˆ˜ ìˆì§€ë§Œ, í˜•ì‹ì´ íŠ¹ìˆ˜í•˜ë¯€ë¡œ kubectlë¡œ ì§ì ‘ ìƒì„±í•˜ëŠ” ê²ƒì´ í¸í•˜ë‹¤.

  + ì´ íƒ€ì…ì˜ ì‹œí¬ë¦¿ì€ ~/.docker/config.json íŒŒì¼ ëŒ€ì²´ìš©ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.



### (3-1) kubectlë¡œ ì§ì ‘ ìƒì„±

```bash
# ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦ ì •ë³´ì˜ ì‹œí¬ë¦¿ ìƒì„±
$ kubectl create secret docker-registry --save-config sample-registry-auth \
--docker-server=REGISTRY_SERVER \
--docker-username=REGISTRY_USER \
--docker-password=REGISTRY_USER_PASSWORD \
--docker-email=REGISTRY_USER_EMAIL


# base64ë¡œ ì¸ì½”ë“œëœ dockercfg í˜•ì‹ì˜ JSON ë°ì´í„°
$ kubectl get secrets -o json sample-registry-auth | jq .data
{
  ".dockerconfigjson": "eyJhdXRocyI6eyJSRUdJU1RSWV9TRVJWRVIiOnsidXNlcm5hbWUiOiJSRUdJU1RSWV9VU0VSIiwicGFzc3dvcmQiOiJSRUdJU1RSWV9VU0VSX1BBU1NXT1JEIiwiZW1haWwiOiJSRUdJU1RSWV9VU0VSX0VNQUlMIiwiYXV0aCI6IlVrVkhTVk5VVWxsZlZWTkZVanBTUlVkSlUxUlNXVjlWVTBWU1gxQkJVMU5YVDFKRSJ9fX0="
}


# base64ë¡œ ë””ì½”ë“œí•œ dockercfg í˜•ì‹ì˜ JSON ë°ì´í„°
$ kubectl get secrets sample-registry-auth -o yaml | grep "\.dockerconfigjson" | awk -F' ' '{print $2}' | base64 --decode
{"auths":{"REGISTRY_SERVER":{"username":"REGISTRY_USER","password":"REGISTRY_USER_PASSWORD","email":"REGISTRY_USER_EMAIL","auth":"UkVHSVNUUllfVVNFUjpSRUdJU1RSWV9VU0VSX1BBU1NXT1JE"}}}
```



### (3-2) ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹œ ì‹œí¬ë¦¿ ì‚¬ìš©

> ì¸ì¦ì´ í•„ìš”í•œ ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì˜ í”„ë¼ì´ë¹— ì €ì¥ì†Œì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ê²½ìš°, ì‹œí¬ë¦¿ì„ ì‚¬ì „ì— ìƒì„±í•œ í›„, íŒŒë“œì˜ ì •ì˜ "spec.imagePullSecrets"ì— docker-registry íƒ€ì…ì˜ ì‹œí¬ë¦¿ì„ ì§€ì •í•´ì•¼ í•œë‹¤.

```bash
apiVersion: v1
kind: Pod
metadata:
  name: sample-pull-secret
spec:
  containers:
  - name: secret-image-container
    image: REGISTRY_NAME/secret-image:latest
  imagePullSecrets:
  - name: sample-registry-auth
```

<br>


## (4) ì‹œí¬ë¦¿ íƒ€ì… - ê¸°ë³¸ ì¸ì¦ íƒ€ì…ì˜ ì‹œí¬ë¦¿ (kubernetes.io/basic-auth)

+ **ê¸°ë³¸ ì¸ì¦ì„ ìœ„í•œ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ íƒ€ì…**



### (4-1) kubectlë¡œ ì§ì ‘ ì „ë‹¬í•˜ì—¬ ìƒì„± (--from-literal)

```bash
$ kubectl create secret generic --save-config sample-basic-auth \
--type kubernetes.io/basic-auth \
--from-literal=username=root --from-literal=password=rootpassword
```



### (4-2) ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ìƒì„±()

```bash
apiVersion: v1
kind: Secret
metadata:
  name: sample-basic-auth
type: kubernetes.io/basic-auth
data:
  username: cm9vdA==
  password: cm9vdHBhc3N3ZA=
```

<br>


## (5) ì‹œí¬ë¦¿ íƒ€ì… - SSH ì¸ì¦ íƒ€ì…ì˜ ì‹œí¬ë¦¿ (kubernetes.io/ssh-auth)

+ **SSHë¥¼ ìœ„í•œ ê°œì¸ í‚¤ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì‹œí¬ë¦¿ íƒ€ì…**



### (5-1) kubectlë¡œ íŒŒì¼ì—ì„œ ê°’ì„ ì°¸ì¡°í•˜ì—¬ ìƒì„± (--from-file)

```bash
$ ssh-keygen -t rsa -b 2048 -f sample-key -C "sample"

$ kubectl create secret generic --save-config sample-ssh-auth \
--type kubernetes.io/ssh-auth
--from-file=ssh-privatekey=./sample-key
```



### (5-2) ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±

```bash
apiVersion: v1
kind: Secret
metadata:
  name: sample-ssh-auth
type: kubernetes.io/ssh-auth
data:
  ssh-privatekey: LS0tLS1CRUdJTIBPUEVOU1NIIFB...
```

<br>


## (6) ì‹œí¬ë¦¿ ì‚¬ìš©

+ ì‹œí¬ë¦¿ì„ ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ìš©í•  ê²½ìš° í¬ê²Œ ë‘ ê°€ì§€ íŒ¨í„´ìœ¼ë¡œ ë‚˜ë£° ìˆ˜ ìˆë‹¤.

  1. í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬

      - ì‹œí¬ë¦¿ì˜ íŠ¹ì • í‚¤ë§Œ

      - ì‹œí¬ë¦¿ì˜ ì „ì²´ í‚¤

  2. ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸

      - ì‹œí¬ë¦¿ì˜ íŠ¹ì • í‚¤ë§Œ

      - ì‹œí¬ë¦¿ì˜ ì „ì²´ í‚¤


### (6-1) í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬


```bash
$ cat <<EOF > sample-db-auth-nobase64.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sample-db-auth
type: Opaque
stringData: 
  username: root
  password: rootpassword
EOF
```


+ envë¡œ í•˜ë‚˜ì”© ì •ì˜í•˜ê¸° ë•Œë¬¸ì— í™˜ê²½ ë³€ìˆ˜ëª…ì„ ì§€ì •í•  ìˆ˜ ìˆëŠ” ê²ƒì´ íŠ¹ì§•

```bash
# íŠ¹ì • í‚¤ë§Œ
$ cat <<EOF > sample-secret-single-env.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-secret-single-env
spec:
  containers:
  - name: secret-container
    image: nginx:1.16
    env:
    - name: DB_USERNAME
      valueFrom:
        secretKeyRef:
          name: sample-db-auth
          key: username
EOF


# sample-secret-single-env íŒŒë“œì˜ DB_USERNAME í™˜ê²½ ë³€ìˆ˜ í™•ì¸
$ kubectl exec -it sample-secret-single-env -- env | grep DB_USERNAME
DB_USERNAME=root
```


+ envFromìœ¼ë¡œ ì‹œí¬ë¦¿ ì „ì²´ë¥¼ ë³€ìˆ˜ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆì–´, í‚¤ë§ˆë‹¤ ê°ê° ì„¤ì •í•  í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ê°€ ê¸¸ì–´ì§€ì§€ëŠ” ì•Šì§€ë§Œ ì‹œí¬ë¦¿ì— ì–´ë–¤ ê°’ì´ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ì˜ì—ì„œëŠ” íŒë‹¨í•˜ê¸° í˜ë“¤ë‹¤.

```bash
# ì „ì²´ í‚¤
$ cat <<EOF > sample-secret-multi-env.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-secret-multi-env
spec:
  containers:
  - name: secret-container
    image: nginx:1.16
    envFrom:
    - secretRef:
        name: sample-db-auth
EOF


# sample-secret-multi-env íŒŒë“œì˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
$ kubectl exec -it sample-secret-multi-env -- env
..(ìƒëµ)..
password=rootpassword
username=root
..(ìƒëµ)..
```


+ envFromì—ì„œ ì—¬ëŸ¬ ì‹œí¬ë¦¿ì„ ê°€ì ¸ì˜¤ë©´ ì¶©ëŒí•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤. ì´ëŸ° ê²½ìš°ì—ëŠ” ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ ì¶©ëŒì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.

```bash
# ì „ì²´ í‚¤
$ cat <<EOF > sample-secret-prefix-env.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-secret-prefix-env
spec:
  containers:
  - name: secret-container
    image: nginx:1.16
    envFrom:
    - secretRef:
        name: sample-db-auth
      prefix: DB1_
    - secretRef:
        name: sample-db-auth
      prefix: DB2_
EOF


# sample-secret-multi-env íŒŒë“œì˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
$ kubectl exec -it sample-secret-prefix-env -- env | grep ^DB
DB1_password=rootpassword
DB1_username=root
DB2_password=rootpassword
DB2_username=root
```


### (6-2) ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸


```bash
$ cat <<EOF > sample-db-auth-nobase64.yaml
apiVersion: v1
kind: Secret
metadata:
  name: sample-db-auth
type: Opaque
stringData:
  username: root
  password: rootpassword
EOF
```

```bash
# ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ëŠ” ê²½ìš°ì—ë„ íŠ¹ì • í‚¤ë¥¼ ë§ˆìš´íŠ¸ í•˜ëŠ” ê²½ìš°
$ cat <<EOF > sample-secret-single-volume.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-secret-single-volume
spec:
  containers:
  - name: secret-container
    image: nginx:1.16
    volumeMounts:
    - name: config-volume
      mountPath: /config
  volumes:
  - name: config-volume
    secret:
      secretName: sample-db-auth
      items:
      - key: username
        path: username.txt
EOF


# sample-secret-single-volume íŒŒë“œì˜ /config/username.txt íŒŒì¼ í™•ì¸
$ kubectl exec -it sample-secret-single-volume -- cat /config/username.txt
root
```

```bash
# ì‹œí¬ë¦¿ ì „ì²´ë¥¼ ë§ˆìš´íŠ¸
$ cat <<EOF > sample-secret-multi-volume.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-secret-single-volume
spec:
  containers:
  - name: secret-container
    image: nginx:1.16
    volumeMounts:
    - name: config-volume
      mountPath: /config
  volumes:
  - name: config-volume
    secret:
      secretName: sample-db-auth
EOF


# íŒŒë“œ ë‚´ë¶€ì˜ /config ë””ë ‰í„°ë¦¬ ë‚´ìš© í™•ì¸
$ kubectl exec -it sample-secret-single-volume -- ls /config/
password  username
```