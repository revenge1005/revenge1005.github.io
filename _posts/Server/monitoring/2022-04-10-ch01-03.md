---
title:  "[Monitoring] 03. 프로메테우스 - Target 노드 추가, 경고 알림 설정(E-mail)" 

categories:
  - MONITORING
tags:
  - [linux, monitoring]

toc: true
toc_sticky: true

date: 2022-04-10
last_modified_at: 2022-04-10
---
<br>

# 01. 프로메테우스 - Target 노드 추가 (node_exporter 설치)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
small { 
    font-size: 18px 
}
</style>

+ node exporter는 Linux 시스템의 메트릭 데이터(CPU/Memory/Disk/Network Traffic 등)를 수집하고, 제공한다.

+ https://prometheus.io/download/#node_exporter

<br>

<big> **■ node_exporter 사용자 생성** </big> <br>

```bash
useradd -m -s /bin/false node_exporter
```

<br>

<big> **■ node_exporter 패키지 다운로드** </big> <br>

```bash
{
    wget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz
    tar -zxpvf node_exporter-1.6.1.linux-amd64.tar.gz
    cp node_exporter-1.6.1.linux-amd64/node_exporter /usr/local/bin/
    chown node_exporter:node_exporter /usr/local/bin/node_exporter
}
```

<br>

<big> **■ 서비스 파일 생성** </big> <br>

```bash
cat <<EOF > /etc/systemd/system/node_exporter.service
[Unit]
Description=Prometheus Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF

{
    systemctl daemon-reload
    systemctl enable node_exporter --now
    systemctl status node_exporter
    netstat -nlp | grep 9100
}
```

<br>

<big> **■ 방화벽 설정** </big> <br>

```bash
{
	firewall-cmd --add-port=9100/tcp --permanent
	firewall-cmd --reload
}
```

<br>

<big> **■ node_exporter 노드 정보 추가 (프로메테우스 서버)** </big> <br>

```bash
vi /etc/prometheus/prometheus.yml

# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

  # 추가
  - job_name: "node"
    static_configs:
    - targets: ["localhost:9100", "node01.test.srv:9100"]

  # 추가
  - job_name: "Test"
    static_configs:
    - targets: ["node01.test.srv:9100"]
```

<br>

<big> **■ prometheus 서비스를 재기동** </big> <br>

```bash
systemctl restart prometheus
```

<br>

<big> **■ [Status] - [Targets]를 클릭하여 새 노드가 나열되는지 확인** </big> <br>

![77777](https://github.com/revenge1005/WEB-Server-3-Tier-Architecture/assets/42735894/d3a88484-ef19-466f-b724-27bf1994c734){: width="80%" height="80%"}{: .align-center}

<br>

<br>

# 02. 프로메테우스 - 경고 알림 설정 (E-mail)
---

+ 알림을 받는 방법은 여러가지가 있지만 예제에서는 이메일로 알림을 구성한다.

+ [Alerting에 대한 문서](https://prometheus.io/docs/alerting/configuration/)

<br>

<big> **■ SMTP 서버 설치 및 설정** </big> <br>

+ 이 예제에서는 SMTP 서버가 localhost에서 실행되는 환경을 기반으로 한다.

```bash
# postfix 설치
dnf -y install postfix mailx
```

```bash
vi /etc/postfix/main.cf

# 95행 : 주석 제거, 호스트 이름 지정 
myhostname = mail.test.srv

# 102행 : 주석 제거, 도메인 이름 지정
mydomain = test.srv

# 118행 : 주석 제거
myorigin = $mydomain

# 135행 : 변경
inet_interfaces = all

# 138헹 : IPv4만 사용하는 경우 변경 
inet_protocols = ipv4

# 183행 : 추가
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain

# 283행 : 주석 제거, 로컬 네트워크 지정
mynetworks = 127.0.0.0/8, 192.168.219.0/24

# 438행 : 주석 제거
home_mailbox = Maildir/
```

```bash
# Dovecot 설치
dnf -y install dovecot
```

```bash
# 1) /etc/dovecot/dovecot.conf 파일 수정
vi /etc/dovecot/dovecot.conf
# 30번 라인: 주석 해제 (만약 IPv6를 사용하지 않는다면 [::] 부분 제거)
listen = *, ::


# 2) /etc/dovecot/conf.d/10-auth.conf 파일 수정
vi /etc/dovecot/conf.d/10-auth.conf
# 10번 라인: 주석 해제하고 (평문 인증 허용)으로 변경
disable_plaintext_auth = no

# 100번 라인: 추가
auth_mechanisms = plain login


# 3) /etc/dovecot/conf.d/10-mail.conf 파일 수정
vi /etc/dovecot/conf.d/10-mail.conf
# 30번 라인: 주석 해제하고 다음과 같이 추가
mail_location = maildir:~/Maildir


# 4) /etc/dovecot/conf.d/10-master.conf 파일 수정
vi /etc/dovecot/conf.d/10-master.conf
# 107-109번 라인: 주석 해제하고 다음과 같이 추가
  # Postfix smtp-auth
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = postfix
    group = postfix
  }

# 4) /etc/dovecot/conf.d/10-ssl.conf 파일 수정
vi /etc/dovecot/conf.d/10-ssl.conf
# 8번 라인: (SSL 필요하지 않음)으로 변경
ssl = yes
```

```bash
{
  systemctl enable --now dovecot
  firewall-cmd --add-service={pop3,imap}
  firewall-cmd --runtime-to-permanent
}
```

```bash
# 메일 클라이언트 프로그램 설치
dnf -y install mailx

# Maildir을 사용하기 위한 환경 변수 설정
echo 'export MAIL=$HOME/Maildir' >> /etc/profile.d/mail.sh
```

<br>

<big> **■ 경고 알림 설정** </big> <br>

<br>

<small> **▶ 프로메테우스 서버에 Alertmanager 설치** </small> <br>

+ https://prometheus.io/download/#alertmanager

```bash
{
    mkdir /etc/alertmanager
    dnf -y install wget
	wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz -P /tmp
	cd /tmp/
    tar -zxpvf alertmanager-0.25.0.linux-amd64.tar.gz
    cp alertmanager-0.25.0.linux-amd64/* /etc/alertmanager/
}
```

```bash
cat <<EOF > /etc/systemd/system/alertmanager.service
[Unit]
Description=Alert Manager
Wants=network-online.target
After=network-online.target

[Service]
User=root
Group=root
Type=simple
ExecStart=/etc/alertmanager/alertmanager --config.file=/etc/alertmanager/alertmanager.yml

[Install]
WantedBy=multi-user.target
EOF
```

```bash
{
	systemctl daemon-reload
	systemctl enable alertmanager --now
	systemctl status alertmanager
	netstat -nlp | grep 9093
}
```

<br>

<small> **▶ 프로메테우스 알림 설정** </small> <br>

```bash
mv /etc/alertmanager/alertmanager.yml /etc/alertmanager/alertmanager.yml.org

vim /etc/alertmanager/alertmanager.yml
# create new
global:
  # SMTP server to use
  smtp_smarthost: 'localhost:25'
  # require TLS or not
  smtp_require_tls: false
  # notification sender's Email address
  smtp_from: 'Alertmanager <root@dlp.test.srv>'
  # if set SMTP Auth on SMTP server, set below, too
  # smtp_auth_username: 'alertmanager'
  # smtp_auth_password: 'password'

route:
  # Receiver name for notification
  receiver: 'email-notice'
  # grouping definition
  group_by: ['alertname', 'Service', 'Stage', 'Role']
  group_wait:      30s
  group_interval:  5m
  repeat_interval: 4h

receivers:
# any name of Receiver
- name: 'email-notice'
  email_configs:
  # destination Email address
  - to: "root@localhost"
```

```bash
# configure Alerting rules
vi /etc/prometheus/alert_rules.yml
# create new
# for example, monitor node-exporter's [Up/Down]
groups:
- name: Instances
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.'
      summary: 'Instance {{ $labels.instance }} down'
```

```bash
vi /etc/prometheus/prometheus.yml

...
...

alerting:
  alertmanagers:
  - static_configs:
    - targets:
      # line 12 : change to (Alertmanager Host):(Port)
      - 'localhost:9093'

# line 18 : add alert rules created above
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"
  - "alert_rules.yml"
```

```bash
{
  systemctl restart prometheus alertmanager
  systemctl enable alertmanager
}
```