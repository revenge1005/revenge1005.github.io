---
title:  "[Retry, k8s] 01. ë³µìŠµí•  ê²¸ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„± (v1.26+cri-docker, Ubuntu 22.04) " 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 01. ë³µìŠµí•  ê²¸ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„± (v1.26+cri-docker, Ubuntu 22.04)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

![ewewqewq](https://user-images.githubusercontent.com/42735894/224997494-9559fdb4-836b-4780-a9ef-2821197f0352.png){: .align-center}

<br>

## ğŸ”” ë³µìŠµí•  ê²¸ ...

> ì˜ˆì „ì— êµ¬ê¸€ë§, ë¸”ë¡œê·¸ ìš”ì•½ ì •ë¦¬ê¸€ ë“±ì„ ì°¾ì•„ê°€ë©´ì„œ ê³µë¶€í–ˆë˜ê±´ë° ìµœê·¼ì— ì¿ ë²„ë„¤í‹°ìŠ¤ ì±…ì´ ìƒê²¨ì„œ ë³µìŠµí• ê²¸ ë‹¤ì‹œ ì‹œì‘.

<https://github.com/revenge1005/Kubernetes-Study>

[(ansible) k8s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ Playbook] <https://github.com/revenge1005/kubernetes_build_ansible_playbook>

<br>

## ğŸ”” ì‚¬ì „ ì¤€ë¹„

```bash
cat <<EOF >> /etc/hosts

192.168.219.10 k8s-master
192.168.219.101 k8s-node01
192.168.219.102 k8s-node02
EOF

# ë°©í™”ë²½ ë¹„í™œì„±í™”
{
  systemctl stop ufw.service; 
  systemctl disable ufw.service; 
  systemctl status ufw
}

# ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ë¹„í™œì„±í™”
{
  swapoff -a && sed -i '/swap/s/^/#/' /etc/fstab
  swapon -s
}

# br_netfilter ëª¨ë“ˆì„ ë¡œë“œ
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

{ 
  modprobe overlay
  modprobe br_netfilter
}

# bridge taffic ë³´ê²Œ ì»¤ë„ íŒŒë¼ë©”í„° ìˆ˜ì •
# í•„ìš”í•œ sysctl íŒŒë¼ë¯¸í„°ë¥¼ /etc/sysctl.d/conf íŒŒì¼ì— ì„¤ì •í•˜ë©´, ì¬ë¶€íŒ… í›„ì—ë„ ê°’ì´ ìœ ì§€ëœë‹¤.
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# ì¬ë¶€íŒ…í•˜ì§€ ì•Šê³  sysctl íŒŒë¼ë¯¸í„° ì ìš©í•˜ê¸°
sysctl --system
```

<br>

## ğŸ”” ë„ì»¤ ì„¤ì¹˜

> <https://docs.docker.com/engine/install/>

### (1) Set up the repository

```bash
{
  apt-get update; apt-get -y install ca-certificates curl gnupg lsb-release
  mkdir -m 0755 -p /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
}
```

### (2) Install Docker Engine

```bash
{
  apt-get update
  apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  systemctl enable docker
  systemctl start docker
}

# ì„¤ì¹˜ í™•ì¸
docker run hello-world
docker version
```

### (3) cri-docker

<https://kubernetes.io/docs/setup/production-environment/container-runtimes/#docker>

<https://github.com/Mirantis/cri-dockerd>

```bash
# ì„¤ì¹˜ì „ì— ìµœì‹ ë²„ì „ì¸ì§€ í™•ì¸í•˜ì…”ì„œ ìµœì‹ ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”.
#230301 ì— í™•ì¸í•œ ë²„ì „ì€ 0.3.1.3-0 ì…ë‹ˆë‹¤.
{
  wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.1/cri-dockerd_0.3.1.3-0.debian-bullseye_amd64.deb
  dpkg -i cri-dockerd_0.3.1.3-0.debian-bullseye_amd64.deb
  systemctl status cri-docker
}

ls -l  /var/run/cri-dockerd.sock
srw-rw---- 1 root docker 0 Mar  1 22:02 /var/run/cri-dockerd.sock
```

<br>

## ğŸ”” ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜

### (1) kubeadm ì„¤ì¹˜ - ëª¨ë“  ë…¸ë“œ

> <https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>

```bash
{
  apt-get update; 
  apt-get install -y apt-transport-https ca-certificates curl
  curl -fsSLo /etc/apt/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
  echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
  apt-get update
  apt-get install -y kubelet kubeadm kubectl
  apt-mark hold kubelet kubeadm kubectl
  systemctl start kubelet
  systemctl enable kubelet
  systemctl status kubelet
}
```

### (2) control-plan ì„¤ì • - k8s-master

```bash
# control-plaine(master) ì»´í¬ë„ŒíŠ¸ êµ¬ì„±
kubeadm init --pod-network-cidr=192.168.0.0/16 --cri-socket unix:///var/run/cri-dockerd.sock

# Kubectlì„ ëª…ë ¹ ì‹¤í–‰ í—ˆìš©í•˜ë ¤ë©´ kubeadm init ëª…ë ¹ì˜ ì‹¤í–‰ê²°ê³¼ ë‚˜ì˜¨ ë‚´ìš©ì„ ë™ì‘í•´ì•¼ í•¨
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# kubeadm init ëª…ë ¹ì˜ ì‹¤í–‰ê²°ê³¼ ë‚˜ì˜¨ ë‚´ìš© ë³„ë„ ì €ì¥í•´ë‘ . (root ê¶Œí•œìœ¼ë¡œ worker node joinì„ ìœ„í•œ ëª…ë ¹ì–´. ë³„ë„ ì €ì¥í•´ë‘ .)
vi token.join
kubeadm join 192.168.219.10:6443 --token 2whvdj...qbbib \
  --cri-socket unix:///var/run/cri-dockerd.sock \
  --discovery-token-ca-cert-hash sha256:7125...78570b57
```

### (3) Installing a Pod network add-on - k8s-master

<https://kubernetes.io/ko/docs/concepts/cluster-administration/addons/>

```bash
kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml

kubectl get nodes
```

### (4) Joining node - node01, node02

```bash
kubeadm join 192.168.219.10:6443 --token 2whv...bbib \
  --discovery-token-ca-cert-hash sha256:712538d8a5a...6a5078570b57 \
  --cri-socket unix:///var/run/cri-dockerd.sock
```

<br>

## ğŸ”” kubectl ëª…ë ¹ì–´ ìë™ ì™„ì„± ì„¤ì •

```bash
apt-get install bash-completion -y

source <(kubeadm completion bash); echo "source <(kubeadm completion bash)" >> ~/.bashrc 

source /usr/share/bash-completion/bash_completion
```

<br>