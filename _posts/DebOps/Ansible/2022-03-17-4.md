---
title:  "[Ansible] 04. When, Block, Hendler" 

categories:
  - ANSIBLE
tags:
  - [ansible]

toc: true
toc_sticky: true

date: 2022-03-17
last_modified_at: 2022-03-17
---
# [Ansible] 04. When, Block, Hendler
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

## ğŸ”” ìì„¸í•œ ëª¨ë“ˆ ë‚´ìš©ì€ ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ê³ 

> **ëª¨ë“ˆ ë‚´ìš© :** <https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html#modules><br><br>
**ì˜ˆì œ Github :** <https://github.com/revenge1005/Ansible_study>

<br>

## ğŸ”” When, Block, Hendler

|êµ¬ë¶„|ì„¤ëª…|
|:---:|---|
|When|ì¡°ê±´ë¬¸, ì¡°ê±´ì´ ì°¸(True)ì¼ ê²½ìš° Task ì‹¤í–‰, ê±°ì§“(False)ì¼ ê²½ìš° Task ë¯¸ì‹¤í–‰|
|Block|Task ê·¸ë£¹|
|Handler|ì¡°ê±´ë¶€ í˜•ì‹ ì¤‘ì— í•˜ë‚˜ (ì¡°ê±´ë¶€ í˜•ì‹ì´ë€, if ì•ì˜ í…ŒìŠ¤í¬ê°€ ë™ì‘í•˜ê±°ë‚˜ ë˜ëŠ” ì¡°ê±´ì— ë§ëŠ”ë‹¤ë©´ handlerë¥¼ ì‹¤í–‰í•œë‹¤)<br><br>Taskì—ì„œ notifyë¥¼ ì´ìš©í•˜ì—¬ handlerì˜ nameì„ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•˜ì—¬ ì•Œë¦°ë‹¤.<br><br>ëª¨ë“  Taskê°€ ëª¨ë‘ ì‹¤í–‰ëœ í›„ì— Handlerê°€ ì‹¤í–‰ëœë‹¤.<br><br>ì—¬ëŸ¬ ì°¨ë ˆ ì•ŒëŒì„ ë°›ì•„ë„ í•¸ë“¤ëŸ¬ëŠ” í•œ ë²ˆë§Œ ì‹¤í–‰ëœë‹¤.<br><br>í”Œë ˆì´ì— ì—¬ëŸ¬ handlerë¥¼ í¬í•¨í•˜ë©´, í•´ë‹¹ í•¸ë“¤ëŸ¬ëŠ” ì•Œë¦¼ ìˆœì„œê°€ ì•„ë‹ˆë¼, handler ì„¹ì…˜ì— ì •ì˜ëœ ìˆœì„œëŒ€ë¡œ í•­ìƒ ì‹¤í–‰ëœë‹¤.|

<br>

## ğŸ”” Managed ë…¸ë“œì˜ OS ì •ë³´ í™•ì¸

```bash
$ ansible all -m gather_facts --limit node01 | grep ansible_distribution
        "ansible_distribution": "Rocky",
        "ansible_distribution_file_parsed": true,
        "ansible_distribution_file_path": "/etc/redhat-release",
        "ansible_distribution_file_variety": "RedHat",
        "ansible_distribution_major_version": "8",
        "ansible_distribution_release": "Green Obsidian",
        "ansible_distribution_version": "8.5",
```

<br>

## ğŸ”” ì˜ˆì œ1. ë‹¤ë¥¸ OS ë³„ë¡œ Apache ì„¤ì¹˜ (Wen ì‚¬ìš©)

### (1) Ubuntu ë…¸ë“œ ì¶”ê°€

```bash
$ cat <<EOF >> /etc/hosts
192.168.219.203  node03  node03.test.com
EOF

ssh-copy-id -i ~/.ssh/id_ed25519.pub node03

cat <<EOF >> inventory
node03
EOF

$ ansible -m ping all
```

### (2) Playbook ì‘ì„±

```bash
$ cat <<EOF > install_apache2.yml
---

- hosts: all
  become: true
  tasks:

  - name: update repository index (Ubuntu)
    apt:
      update_cache: yes
    when: ansible_distribution == "Ubuntu" and ansible_distribution_version == "20.04"

  - name: install apache2 package (Ubuntu)
    apt:
      name: apache2
      state: latest
    when: ansible_distribution in ["Ubuntu", "Debiain"]

  - name: apache2 Service Start & enable (Ubuntu)
    service:
      name: apache2
      state: started
      enabled: yes
    when: ansible_distribution in ["Ubuntu", "Debiain"]

  - name: update repository index (Rocky)
    dnf:
      update_cache: yes
    when: ansible_distribution == "Rocky"

  - name: install httpd packge (Rocky)
    dnf:
      name: httpd
      state: latest
    when: ansible_distribution == "Rocky"

  - name: httpd Service Start & enable (Rocky)
    service:
      name: httpd
      state: started
      enabled: yes
    when: ansible_distribution == "Rocky"
EOF

$ ansible-playbook install_apache2.yml
```

![023](https://user-images.githubusercontent.com/42735894/223370572-3858b405-d0c0-48dd-a1af-ad4fb957256e.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ”” ì˜ˆì œ2. Handler ì˜ˆì‹œ

### (1) êµ¬ì„±

```bash
$ # tree .
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ files
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ install_apache3.yml
â””â”€â”€ inventory

# cat files/index.html
<h1>Hello World!!!</h1>
```

### (2) Playbook ì‘ì„±

```bash
$ cat <<EOF > install_apache3.yml
---
- name: Install Apache and Upload my Home Page
  hosts: all
  become: yes

  vars:
    source_file: ./files/index.html
    destin_file: /var/www/html/

  tasks:

  - name: Install Apache WEB Server
    dnf:
      name: httpd
      state: latest
    when: ansible_distribution == "Rocky"

  - name: Copy HomePage file to WEB Server
    copy:
      src: "{{ source_file  }}"
      dest: "{{ destin_file  }}"
      mode: 0555
    when: ansible_distribution == "Rocky"
    notify: Restart Apache

  - name: Start WEB Server service
    service:
      name: httpd
      state: started
      enabled: yes
    when: ansible_distribution == "Rocky"

  handlers:
  - name: Restart Apache
    service:
      name: httpd
      state: restarted
EOF

$ ansible-playbook install_apache3.yml
```

![123](https://user-images.githubusercontent.com/42735894/223370579-dff252d2-cf31-4201-a6ad-cea8d10e48ea.png){: width="100%" height="100%"}{: .align-center}

<br>

## ğŸ”” ì˜ˆì œ3. block, When ì˜ˆì œ

### (1) êµ¬ì„±

```bash
$ tree .
.
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ files
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ install_apache4.yml
â””â”€â”€ inventory

$ cat files/index.html
<h1>Hello World!!!</h1>
```

### (2) Playbook ì‘ì„±

```bash
$ cat <<EOF > install_apache4.yml
---
- name: Install Apache and Upload my Home Page
  hosts: all
  become: yes

  vars:
    source_file: ./files/index.html
    destin_file: /var/www/html/

  tasks:

  - name: Check and Print Linux Version
    debug:
      var: ansible_os_family

  - block:   # ======Block for RedHat======

      - name: Install Apache WEB Server for RedHat
        yum:
          name: httpd
          state: latest

      - name: Copy HomePage file to WEB Server
        copy:
          src: "{{ source_file  }}"
          dest: "{{ destin_file  }}"
          mode: 0555
        notify: Restart Apache RedHat

      - name: Start WEB Server service for RedHat
        service:
          name: httpd
          state: started
          enabled: yes

    when: ansible_os_family == "RedHat"

  - block:   # ======Block for Debian======

      - name: Install Apache WEB Server for Debian
        apt:
          name: apache2
          state: latest

      - name: Copy HomePage file to WEB Server
        copy:
          src: "{{ source_file  }}"
          dest: "{{ destin_file  }}"
          mode: 0555
        notify: Restart Apache Debian

      - name: Start WEB Server service for Debian
        service:
          name: apache2
          state: started
          enabled: yes

    when: ansible_os_family == "Debian"

  handlers:
  - name: Restart Apache RedHat
    service:
      name: httpd
      state: restarted

  - name: Restart Apache Debian
    service:
      name: apache2
      state: restarted
EOF

$ ansible-playbook install_apache4.yml
```

![image](https://user-images.githubusercontent.com/42735894/223370580-c3cd204f-87b1-422d-8eb7-2ed6e85259fe.png){: width="100%" height="100%"}{: .align-center}

<br>