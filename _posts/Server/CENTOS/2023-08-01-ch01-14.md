---
title:  "[CentOS] 14. WEB(Apache) + WAS(PHP) + DB(MariaDB)" 

categories:
  - CENTOS
tags:
  - [centos, linux]

toc: true
toc_sticky: true

date: 2023-05-23
last_modified_at: 2023-10-23
---
<br>

# ğŸ”” WEB êµ¬ì„±ìš”ì†Œ
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
big {
    font-size: 15pt;
}
</style>

![www](https://github.com/revenge1005/kubernetes_build_ansible_playbook/assets/42735894/a3a86ff9-2509-4165-80be-7bde890f3b77)

<br>

# 02) ì„œë²„ ì •ë³´
---

![02dasewq](https://user-images.githubusercontent.com/42735894/236681067-c4d9a874-0021-4362-a63d-9034ef8274cb.PNG){: width="100%" height="100%"}

![php-fpm 01](https://user-images.githubusercontent.com/42735894/148756011-f712330c-0f48-44b0-97fa-deea412219b1.PNG){: width="100%" height="100%"}

<br>

# 03) ì„œë²„ êµ¬ì„±
---

<br>

## a) WEB Server - Apache install and configuration

```bash
# /etc/hostsì— ì„œë²„ IP ì£¼ì†Œ ì •ë³´ ì¶”ê°€
$ cat <<EOF >> /etc/hosts

192.168.219.100 web
192.168.219.111 was01
192.168.219.200 db
EOF
```

```bash
# Apache ì„¤ì¹˜
$ yum -y install httpd
```

```bash
# /etc/httpd/conf/httpd.conf íŒŒì¼ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€
$ vim /etc/httpd/conf/httpd.conf

<VirtualHost *:80>
	ProxyRequests Off
	ProxyPreserveHost On
	ProxyErrorOverride on
	ProxyTimeout 600

    # WAS ì„œë²„ë¥¼ 2ëŒ€ ì´ìƒ ì‚¬ìš©í•˜ê³  ë¶„ì‚°í•˜ê³  ì‹¶ì„ ë•Œ
    #<Proxy balancer://mycluster>
	#	BalancerMember "fcgi://was01:9000" route=1 
	#	BalancerMember "fcgi://was02:9000" route=2 
		#BalancerMember "fcgi://was01:9000" route=1 enablereuse=On max=5
		#BalancerMember "fcgi://was02:9000" route=2 enablereuse=On max=5
		# enablereuse ì˜µì…˜ì„ í†µí•´ì„œ WASì™€ DB ê°„ì˜ Connection Poolê³¼ ìœ ì‚¬í•˜ê²Œ Apacheì™€ PHP-FPM ê°„ì˜ ë¯¸ë¦¬ ì—°ê²°ì„ í™•ë³´í•˜ì—¬ Connectionì„ ì¬ì‚¬ìš© í• ìˆ˜ ìˆë‹¤.
		# enablereuse ì˜µì…˜ ì‚¬ìš©ì‹œ ì‚¬ì „ì— ê²€í† ë‚˜ ê³ ë ¤ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤.
		# enablereuse ì˜µì…˜ ë¯¸ì‚¬ìš© ë•Œë³´ë‹¤ php-fpm ì—ì„œì˜ í”„ë¡œì„¸ìŠ¤ í™•ë³´ê°€ ë” í•„ìš”í•´ ì˜¤íˆë ¤ ëŠ¦ì–´ì§€ê±°ë‚˜ ì €í•˜ í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
	#	ProxySet lbmethod=bytraffic
		# -> Load Balance ë°©ë²• : byrequests (ìš”ì²­ë³„ ë¶„ë°°), bytraffic (byte íŠ¸ë˜í”½ ê°€ì¤‘ì¹˜ ë¶„ë°°), bybussyness( ë³´ë¥˜ì¤‘ ìš”ì²­ ë¶„ë°°)
	#	ProxySet stickysession=ROUTEID
	#</Proxy>
	# 
	#<FilesMatch \.php$>
	#	SetHandler proxy:balancer://mycluster
	#</FilesMatch>

	<FilesMatch \.(php|phar)$>
		SetHandler "proxy:fcgi://was01:9000"
	</FilesMatch>
    
</VirtualHost>
```

```bash
# ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì‹œì‘(start)í•˜ë„ë¡ ì§€ì •
$ systemctl enable --now httpd

# ë°©í™”ë²½ í—ˆìš©
$ firewall-cmd --add-service=http

$ firewall-cmd --add-port=9000/tcp

$ firewall-cmd --runtime-to-permanent

# Apacheê°€ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
$ setsebool -P httpd_can_network_connect on
```

<br>

## b) WAS Server - PHP-FPM install and configuration

```bash
# /etc/hostsì— ì„œë²„ IP ì£¼ì†Œ ì •ë³´ ì¶”ê°€
$ cat <<EOF >> /etc/hosts

192.168.219.100 web
192.168.219.111 was01
192.168.219.200 db
EOF
```

```bash
# PHP ì„¤ì¹˜
$ dnf module list php
CentOS Stream 9 - AppStream
Name      Stream      Profiles                        Summary
php       8.1         common [d], devel, minimal      PHP scripting language

$ dnf module reset php

$ dnf module -y enable php:8.1

$ dnf module -y install php:8.1/common; dnf -y install php-mysqlnd
```

```bash
# /etc/php-fpm.d/www.conf íŒŒì¼ì—ì„œ ì•„ë˜ ë‚´ìš© ì¶”ê°€
$ vim /etc/php-fpm.d/www.conf

listen = 9000
listen.allowed_clients = 192.168.219.100
```

```bash
# ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì‹œì‘(start)í•˜ë„ë¡ ì§€ì •
$ systemctl enable --now php-fpm

# ë°©í™”ë²½ í—ˆìš©
$ firewall-cmd --add-service=http

$ firewall-cmd --add-port=9000/tcp

$ firewall-cmd --add-port=3306/tcp

$ firewall-cmd --runtime-to-permanent

# Apacheê°€ SELinuxë¥¼ í†µí•´ ì›ê²© ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ë„ë¡ í—ˆìš©
$ setsebool -P httpd_can_network_connect_db 1
```

```bash
# í…ŒìŠ¤íŠ¸ php íŒŒì¼ ìƒì„±
$ mkdir -p /var/www/html

$ cat <<EOF >> /var/www/html/info.php
<?php phpinfo(); ?>
EOF
```

<br>

## c) DB Server - MariaDB Install

```bash
# MariaDB ì„¤ì¹˜
$ yum -y install mariadb-server mariadb
```

```bash
# ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì‹œì‘(start)í•˜ë„ë¡ ì§€ì •
$ systemctl enable --now mariadb

# ë°©í™”ë²½ í—ˆìš©
$ firewall-cmd --add-port=3306/tcp
```

```bash
# MariaDB ì„¤ì •
$ mysql_secure_installation
```

```bash
# test ìš© DB ìƒì„±
$ mysql -u root -p

$ create database test;

# ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©
$ GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'PASSWORD';

$ exit;
```

<br>

## d) WAS Server - DB connection check

```bash
# DB ì—°ê²° ì²´í¬ìš© php íŒŒì¼ ì‘ì„±
$ cat <<EOF >> /var/www/html/dbtest.php
WAS01
<?php
    \$host = '192.168.219.200';
    \$user = 'root';
    \$pw = '1234';
    \$dbName = 'test';
    \$mysqli = new mysqli(\$host, \$user, \$pw, \$dbName);
 
    if(\$mysqli){
        echo "MySQL ì ‘ì† ì„±ê³µ";
    }else{
        echo "MySQL ì ‘ì† ì‹¤íŒ¨";
    }
?>
EOF
```