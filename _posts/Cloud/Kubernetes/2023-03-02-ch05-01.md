---
title:  "[Retry, k8s] 21. ì»¨í”¼ê·¸ & ìŠ¤í† ë¦¬ì§€ API - í™˜ê²½ ë³€ìˆ˜" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-10-15
last_modified_at: 2023-10-15
---
# [Retry, k8s] 21. ì»¨í”¼ê·¸ & ìŠ¤í† ë¦¬ì§€ API - í™˜ê²½ ë³€ìˆ˜
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” í™˜ê²½ ë³€ìˆ˜

> k8sì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì „ë‹¬í•  ë•ŒëŠ” íŒŒë“œ í…œí”Œë¦¿ì— env ë˜ëŠ” envFormì„ ì§€ì •í•˜ë©°, í¬ê²Œ ë‚˜ëˆ  **"ì •ì  ì„¤ì •", "íŒŒë“œ ì •ë³´", "ì»¨í…Œì´ë„ˆ ì •ë³´", "ì‹œí¬ë¦¿ ë¦¬ì†ŒìŠ¤ ê¸°ë°€ ì •ë³´", "ì»¨í”¼ê·¸ë§µ ë¦¬ì†ŒìŠ¤ ì„¤ì •ê°’" í™˜ê²½ ë³€ìˆ˜ì— í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆë‹¤.**

|ì„¤ì •|ì„¤ëª…|
|:---:|---|
|env|íŒŒë“œ í…œí”Œë¦¿ì—ì„œ ì§ì ‘ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•|
|envForm|ì»¨í”¼ê·¸ë§µ, ì‹œí¬ë¦¿ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ê°€ì ¸ì™€ì„œ íŒŒë“œ í…œí”Œë¦¿ì— ì ìš©í•˜ëŠ” ë°©ë²•|

<br>


### (1) ì •ì  ì„¤ì •

```bash
$ cat <<EOF > sample-env.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-env
  labels:
    app: sample-app
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    env:
    - name: MAX_CONNECTION
      value: "100"
    - name: TZ
      value: Asia/Seoul
EOF

$ kubectl exec -it sample-env -- env | grep MAX_CONNECTION
MAX_CONNECTION=100
```


### (2) íŒŒë“œ ì •ë³´

+ **fieldRefëŠ” íŒŒë“œì˜ ì •ë³´ë¥¼ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©**í•˜ëŠ”ë°, íŒŒë“œì˜ ëŒ€í•œ ëª¨ë“  ì •ë³´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ”ê²ƒì€ ì•„ë‹ˆê³  **íŒŒë“œì˜ ë‹¤ìš´ì›Œë“œ APIë¥¼ í†µí•´ íŒŒë“œì˜ ì •ë³´ ì¤‘ ì¼ë¶€ë§Œì„ ì°¸ì¡°**í•  ìˆ˜ ìˆë‹¤.

+ **[fieldRef - ë‹¤ìš´ì›Œë“œ API ì •ë³´] :** <https://kubernetes.io/ko/docs/concepts/workloads/pods/downward-api/#downwardapi-fieldRef>

```bash
# í•´ë‹¹ ì˜ˆì œë¥¼ í†µí•´ íŒŒë“œê°€ ê¸°ë™í•˜ê³  ìˆëŠ” ë…¸ë“œì˜ ì´ë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
$ cat <<EOF > sample-env-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-env-pod
  labels:
    app: sample-app
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    env:
    - name: K8S_NODE
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
EOF


$ kubectl get pod -o wide sample-env-pod
NAME             READY   STATUS    RESTARTS   AGE   IP          NODE         
sample-env-pod   1/1     Running   0          45s   10.38.0.1   k8s-node02   


$ kubectl exec -it sample-env-pod -- env | grep K8S_NODE
K8S_NODE=k8s-node02
```


### (3) ì»¨í…Œì´ë„ˆ ì •ë³´

+ **resourceFieldRefëŠ” ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ì˜ ì •ë³´ë¥¼ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©**í•˜ê³ , fieldRefì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë‹¤ìš´ì›Œë“œ APIë¥¼ í†µí•´ ì¼ë¶€ë§Œì„ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.

+ **[resourceFieldRef - ë‹¤ìš´ì›Œë“œ API ì •ë³´] :** <https://kubernetes.io/ko/docs/concepts/workloads/pods/downward-api/#downwardapi-resourceFieldRef> 

```bash
cat <<EOF > sample-env-container.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-env-container
  labels:
    app: sample-app
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    env:
    - name: CPU_REQUESTS
      valueFrom:
        resourceFieldRef:
          containerName: nginx-container
          resource: requests.cpu
    - name: CPU_LIMITS
      valueFrom:
        resourceFieldRef:
          containerName: nginx-container
          resource: limits.cpu
EOF


$ kubectl exec -it sample-env-container -- env | grep CPU
CPU_REQUESTS=0
CPU_LIMITS=2
```


### (4) í™˜ê²½ ë³€ìˆ˜ ì´ìš© ì‹œ ì£¼ì˜ ì‚¬í•­


#### ğŸ“œ ì˜ˆì œ-1


+ command, argsë¡œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë¥¼ ì§€ì •í•  ë•ŒëŠ” ì¼ë°˜ì ì¸ ë°©ì‹ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. (ì¦‰, ${}ê°€ ì•„ë‹Œ $()ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.)

```bash
apiVersion: v1
kind: Pod
metadata:
  name: sample-env-fail
  labels:
    app: sample-app
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    command: ["echo"]
    args: ["$(TESTENV)", "$(HOSTNAME)"]
    env:
    - name: TESTENV
      value: "100"
```

```bash
$ kubectl logs sample-env-fail
100 $(HOSTNAME)
```


+ **commandì™€ argsì—ì„œ ì°¸ì¡° ê°€ëŠ¥í•œ ê²ƒì€ ê·¸ íŒŒë“œì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ë¶€ì— ì •ì˜ëœ í™˜ê²½ ë³€ìˆ˜ë§Œì´ë¼ëŠ” ì ì— ì£¼ì˜**í•´ì•¼ í•œë‹¤.

+ ë§Œì•½ OSì—ì„œë§Œ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° Entrypoint(spec.containers[].command)ë¥¼ entrypoint.sh ë“±ì˜ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ í•˜ì—¬ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

+ ì‹œí¬ë¦¿ì´ë‚˜ ì»¨í”¼ê·¸ë§µì—ì„œ ì •ì˜í•œ env, íŒŒë“œë‚˜ ì»¨í…Œì´ë„ˆ ì •ë³´ë¥¼ fieldPath, resourceFieldRefì—ì„œ ì°¸ì¡°í•œ envë„ ë§ˆì°¬ê°€ì§€ë¡œ [$(SOME_ENVIRONMENT)] í˜•ì‹ìœ¼ë¡œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```bash
$ cat sample-env-fail2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-env-fail2
  labels:
    app: sample-app
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    command: ["echo"]
    args: ["$(K8S_NODE)", "${K8S_NODE}"]
    env:
    - name: K8S_NODE
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName


$ kubectl logs sample-env-fail2
k8s-node02 ${K8S_NODE}
```

<br>