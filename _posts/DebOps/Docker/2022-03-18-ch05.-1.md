---
title:  "[Docker] 13. Docker Compose" 

categories:
  - DOCKER
tags:
  - [docker]

toc: true
toc_sticky: true

date: 2022-03-18
last_modified_at: 2022-03-18
---
# [Docker] 13. Docker Compose
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” Docker Compose ì´ë€?

> ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ëª¨ì•„ì„œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ íˆ´ë¡œ, ã€Œdocker-compose.ymlã€ë¼ëŠ” íŒŒì¼ì— ì»¨í…Œì´ë„ˆì˜ êµ¬ì„± ì •ë³´ë¥¼ ì •ì˜í•¨ìœ¼ë¡œì¨ ë™ì¼ í˜¸ìŠ¤íŠ¸ìƒì˜ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. <br><br>
ì»¨í…Œì´ë„ˆì˜ êµ¬ì„± ì •ë³´ë¥¼ YAML í˜•ì‹ì˜ íŒŒì¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì§€ì†ì  ë””í”Œë¡œì´ë‚˜ ì§€ì†ì  ì¸í‹°ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤ì— ìˆì–´ì„œ ìë™ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œì˜ í™˜ê²½ êµ¬ì¶•ì—ë„ ì´ìš© ê°€ëŠ¥í•˜ë‹¤.

<br>

## ğŸ”” Docker Compose ê°œìš”

> Compose ì •ì˜ íŒŒì¼ì—ëŠ” ê´€ë¦¬í•˜ê³  ì‹¶ì€ ì»¨í…Œì´ë„ˆì˜ ì„œë¹„ìŠ¤(services:), ë„¤íŠ¸ì›Œí¬(networks:), ë³¼ë¥¨(volumes:)ì„ ì •ì˜í•œë‹¤. <br><br>
ë˜í•œ **Compose ì •ì˜ íŒŒì¼ì€ ë²„ì „ì— ë”°ë¼ ê¸°ìˆ í•  ìˆ˜ ìˆëŠ” í•­ëª©ì´ ë‹¤ë¥´ë©°, Compose ì •ì˜ íŒŒì¼ì˜ ë²„ì „ì€ Docker Engineì˜ ë²„ì „ê³¼ ê´€ê³„ê°€ ìˆë‹¤.**

+ ë²„ì „ ì •ë³´ ë° ì‘ì„± ë°©ë²• : <https://docs.docker.com/compose/compose-file/compose-file-v3/>

```yaml
# ë²„ì „ì„ ì§€ì •
version: "3.9"

#ì„œë¹„ìŠ¤ ì •ì˜ 
services:
    webserver:
        image: ubuntu
        ports: 
            - "80:80"
        networks:
            - webnet

    redis: 
        image: redis 
        networks:
            - webnet

#ë„¤íŠ¸ì›Œí¬ ì •ì˜
networks:
    webnet:

# ë°ì´í„° ë³¼ë¥¨ ì •ì˜
volumes:
    data-volume:
```

### (1) ì´ë¯¸ì§€ ì§€ì •

> ì»¨í…Œì´ë„ˆì˜ ë°”íƒ•ì´ ë˜ëŠ” ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ì§€ì •

```yaml
services:
    webserver:
        image: ubuntu
```

```yaml
services:
    webserver:
        image: ubuntu:kinetic-20230217
```

- webserverë¼ëŠ” ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆì˜ ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ centos: 7ìœ¼ë¡œ ì§€ì •

- ì´ë¯¸ì§€ë¥¼ ë¡œì»¬ í™˜ê²½ì— ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ë„ì»¤ í—ˆë¸Œì—ì„œ ë‹¤ìš´ë¡œë“œ

- ì´ë¯¸ì§€ì˜ íƒœê·¸ë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ê²½ìš° ìµœì‹  ë²„ì „(latest)ì´ ë‹¤ìš´ë¡œë“œ 

<br>

### (2) ì´ë¯¸ì§€ ë¹Œë“œ

> Dockerfileë¡œ ì´ë¯¸ì§€ë¥¼ ê·¸ìˆ í•˜ê³  ê·¸ê²ƒì„ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ì—¬ ë² ì´ìŠ¤ë¡œ ì§€ì •í•  ë•Œ ì‚¬ìš©

```yaml
services:
    webserver:
        build: .
```

```yaml
services:
    webserver:
        build: 
            context: ./dir
            dockerfile: Dockerfile-alternate
            args:
                projetno: 1
                user: choi
```

- build : Dockerfileì˜ ê²½ë¡œ

- context : Dockerfileì´ ìˆëŠ” ë””ë ‰í„°ë¦¬ì˜ ê²½ë¡œ ë˜ëŠ” ë¦¬í¬ì§€í† ë¦¬ì˜ URLì„ ì§€ì •

- dockerfile : í•´ë‹¹ ë„ì»¤ íŒŒì¼ì˜ ì´ë¦„ì„ ì§€ì •

- args: Dockerfileì˜ ARG ëª…ë ¹ê³¼ ë¹„ìŠ·í•œ ëª…ë ¹ìœ¼ë¡œ, docker-compose ëª…ë ¹ì´ ì‹¤í–‰ë˜ëŠ” êµ¬ê°„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€ìˆ˜


#### (a) ì˜ˆì‹œ

##### ã€ë””ë ‰í„°ë¦¬ êµ¬ì„±ã€‘

![image](https://user-images.githubusercontent.com/42735894/223957069-b6fc805d-b8a8-4850-8621-48a81ea70ba0.png){: width="80%" height="80%"}{: .align-center}

##### íŒŒì¼ ë‚´ìš©

```yaml
# docker-compose.yml
services:
    webserver:
        build: .
```
```Dockerfile
# Dockerfile
FROM ubuntu
```

##### ã€ì»¨í…Œì´ë„ˆ ìƒì„±ã€‘

```bash
$ docker-compose up --build Building webserver
Step 1/1 FROM ubuntu
---> 747cb2d60bbe
Successfully built 747cb2d60bbe
Successfully tagged sample_webserver:latest
Starting sample_webserver_1
Attaching to sample_webserver_1
```

<br>

### (3) ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ì‘ë™í•˜ëŠ” ëª…ë ¹ - command, entrypoint

> Dockerfileì˜ ëª…ë ¹ê³¼ ê°™ìŒ, ë² ì´ìŠ¤ ì´ë¯¸ì§€ì— ì§€ì •ë˜ì–´ ìˆì„ ë•ŒëŠ” ê·¸ ëª…ë ¹ì„ ë®ì–´ì“´ë‹¤.

```yaml
services:
    webserver:
        image: centos:7
        command: /bin/bash -c "yum update && yum install net-tools"
```

```yaml
services:
    webserver:
        image: centos:7
        entrypoint: cat /etc/hosts
        # ë˜ëŠ”
        entrypoint: 
            - /bin/cat
            - /etc/hosts
```

<br>

### <s>(4) ì»¨í…Œì´ë„ˆ ê°„ ì—°ê²° - links</s>

> <s>ìµœì‹  ë²„ì „ ë¶€í„°ëŠ” linksë¥¼ ì‘ì„±í•˜ì§€ ì•Šì•„ë„, ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.</s>

<br>

### (5) ì»¨í…Œì´ë„ˆ ê°„ í†µì‹  - ports, expose

> ports : í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì— ì»¨í…Œì´ë„ˆë¥¼ ê³µê°œí•˜ëŠ” í¬íŠ¸ ì§€ì •

- "í˜¸ìŠ¤íŠ¸ì˜ Portë²ˆí˜¸:ì»¨í…Œì´ë„ˆ Portë²ˆí˜¸"ë¥¼ ì§€ì •

- ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸ ë²ˆí˜¸ë§Œ ì§€ì •í•œ ê²½ìš°ëŠ” í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì˜ í¬íŠ¸ì˜ ëœë¤í•œ ê°’ìœ¼ë¡œ ì„¤ì •

```yaml
services:
    webserver:
        image: httpd:latest
        ports:
            - "80"
            - "8000:8000"
            - "127.0.0.1:8001:8001"
            # ë˜ëŠ”
            - target: 8080       ## ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
              published: 8080    ## í˜¸ìŠ¤íŠ¸OSì—ì„œ ê³µê°œí•  í¬íŠ¸
              protocol: tcp      ## í¬íŠ¸ í”„ë¡œí† ì½œ
              mode: host         ## hostê° ë…¸ë“œì— í˜¸ìŠ¤íŠ¸ í¬íŠ¸ë¥¼ ê²Œì‹œí•˜ê±°ë‚˜ ingressë¡œë“œ ë°¸ëŸ°ì‹±í•  ìŠ¤ì›œ ëª¨ë“œ í¬íŠ¸ì— ì‚¬ìš©
```

> expose : í˜¸ìŠ¤íŠ¸OSì— í¬íŠ¸ë¥¼ ê³µê°œí•˜ì§€ ì•Šê³ , ì»¨í…Œì´ë„ˆë§Œ í¬íŠ¸ë¥¼ ê³µê°œ, í˜¸ìŠ¤íŠ¸OSì™€ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•Šê³  ë§í¬ë“±ìœ¼ë¡œ ì—°ê²°ëœ ì»¨í…Œì´ë„ˆ-ì»¨í…Œì´ë„ˆê°„ì˜ í†µì‹ ë§Œì´ í•„ìš”í•œ ê²½ìš° ë“±ì— ì‚¬ìš© ë©ë‹ˆë‹¤.

```yaml
services:
    webserver:
        image: httpd:latest
        expose:
            - "8000"
```

<br>

### (5) ì„œë¹„ìŠ¤ì˜ ì˜ì¡´ê´€ê³„ ì •ì˜ - depends_on

> web ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•˜ê¸° ì „ì— DBì™€ Redis ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©

- ì£¼ì˜í•  ì ì€ depends_onì€ ì»¨í…Œì´ë„ˆì˜ ì‹œì‘ ìˆœì„œë§Œ ì œì•„í•  ë¿, ì»¨í…Œì´ë„ˆìƒì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì´ìš© ê°€ëŠ¥í•´ ì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ì œì–´ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.

```yaml
version: "3.9"
services:
  web:
    build: .
    depends_on:
      - db
      - redis
  redis:
    image: redis
  db:
    image: postgres
```

<br>

### (6) ì»¨í…Œì´ë„ˆ í™˜ê²½ë³€ìˆ˜ ì§€ì • - environment, env_file

> ì»¨í…Œì´ë„ˆ ì•ˆì˜ í™˜ê²½ë³€ìˆ˜ë¥¼ ì§€ì •í•  ë•Œ environment, íŒŒì¼ë¡œ ì½ì–´ ë“¤ì´ ë•Œ env_file

```yaml
version: "3.9"
services:
  web:
    build: .
    environment:
        - RACK_ENV=devlop
        - SHOW=ture
    # ë˜ëŠ”
    environment:
        RACK_ENV: devlop
        SHOW: ture
```

```yaml
version: "3.9"
services:
  web:
    build: .
    env_file:
        - ./common.env
        - /apps/web.env
```

<br>

### (7) ì»¨í…Œì´ë„ˆ ì •ë³´ ì„¤ì • - container_name, labels

> container_name : ì»¨í…Œì´ë„ˆì— ë¶™ì¼ ì´ë¦„ì„ ì§€ì • (ë‹¨, ê³ ìœ í•´ì•¼ í•¨)

```yaml
container_name: my-web-container
```

> labels : ì´ë¯¸ì§€ êµ¬ì„±ì´ë‚˜ ì»¨í…Œì´ë„ˆ, ë³¼ë¥¨, ë„¤íŠ¸ì›Œí¬ê°„ì˜ ê´€ê³„ì— ì£¼ì„ì„ ë‹¬ê±°ë‚˜ í•  ë•Œ ì‚¬ìš©

```yaml
labels:
  com.example.description: "Accounting webapp"
  com.example.department: "Finance"
  com.example.label-with-empty-value: ""

labels:
  - "com.example.description=Accounting webapp"
  - "com.example.department=Finance"
  - "com.example.label-with-empty-value"
```

<br>

### (8) ì»¨í…Œì´ë„ˆ ë°ì´í„° ê´€ë¦¬ - volumes

> ì»¨í…Œì´ë„ˆì— ë³¼ë¥¨ì„ ë§ˆìš´íŠ¸í•  ë•Œ volumesë¥¼ ì§€ì •

- í˜¸ìŠ¤íŠ¸ì—ì„œ ë§ˆìš´íŠ¸í•  ê²½ë¡œë¥¼ ì§€ì •í•˜ë ¤ë©´ "í˜¸ìŠ¤íŠ¸ì˜ ë””ë ‰í„°ë¦¬:ì»¨í…Œì´ë„ˆ ë””ë ‰í„°ë¦¬"

```yaml
volumes:
    - /var/lib/mysql
    - cache/:/tmp/cache
```

```yaml
# ì½ê¸° ì „ìš© ë³¼ë¥¨ ì§€ì •
volumes:
    - ~/configs:/etc/configs/:ro
```

```yaml
# ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë¡œë¶€í„° ëª¨ë“  ë³¼ë¥¨ì„ ë§ˆìš´íŠ¸í•  ë•ŒëŠ” volume_fromì— ì»¨í…Œì´ë„ˆëª…ì„ ì§€ì •í•œë‹¤
# ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì§€ì •
volumes_from:
    - log
```

<br>