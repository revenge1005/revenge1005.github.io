---
title:  "[Retry, k8s] 24. ì»¨í”¼ê·¸ & ìŠ¤í† ë¦¬ì§€ API - ì˜êµ¬ ë³¼ë¥¨ í´ë ˆì„(PVC)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-09-02
last_modified_at: 2023-09-02
---
<br>

# ğŸ”” ì˜êµ¬ ë³¼ë¥¨ í´ë ˆì„
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

**ì‹œì‘í•˜ê¸° ì „ ì„ í–‰ ì‘ì—… ë° í™•ì¸í•´ì•¼í•  ë‚´ìš©** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-1/>** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-2/>** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-3/>**
{: .notice--warning}

> **PVCëŠ” ì˜êµ¬ ë³¼ë¥¨(PV)ì„ ìš”ì²­í•˜ëŠ” ë¦¬ì†ŒìŠ¤**ë¡œ, PVCì—ì„œ ì§€ì •í•œ ì¡°ê±´(ìš©ëŸ‰, ë ˆì´ë¸”)ì„ ê¸°ë°˜ìœ¼ë¡œ PVì— ëŒ€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” í˜„ì¬ ê°€ì§€ê³  ìˆëŠ” ì˜êµ¬ ë³¼ë¥¨ì—ì„œ ì ë‹¹í•œ ë³¼ë¥¨ì„ í• ë‹¹í•œë‹¤.


## (1) PVC ì„¤ì •

+ ì´ì „ ë‚´ìš© ì´ì–´ì„œ <https://revenge1005.github.io/kubernetes/ch05-05/>

+ ë ˆì´ë¸” ì…€ë ‰í„°

+ ìš©ëŸ‰ 

+ ì ‘ê·¼ ëª¨ë“œ

+ ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤

```bash
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sample-pvc
spec:
  selector:
    matchLabels:
      type: ceph-pv
    matchExpressions:
    - key: environment
      operator: In
      values:
      - stg
  resources:
    requests:
      storage: 1Gi
  accessModes:
  - ReadWriteMany
  storageClassName: csi-fs-sc
```

<br>

## (2) PVC ìƒì„±

```bash
# PVC ì •ë³´ í™•ì¸
$ kubectl get pvc sample-pvc
NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE
sample-pvc   Bound    sample-pv   1Gi        RWX            csi-fs-sc      49s


# PV ì •ë³´ í™•ì¸
$ kubectl get pv sample-pv
NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE
sample-pv   1Gi        RWX            Retain           Bound    default/sample-pvc   csi-fs-sc               49m
```

<br>

## (2) PVC ì‚­ì œ

+ Retain ì •ì±…ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²½ìš° PVCë¥¼ ì‚­ì œí•  ë•Œ PVì˜ STATUSê°€ Boundì—ì„œ Releasedë¡œ ë³€ê²½ëœë‹¤.

+ Released ìƒíƒœì˜ PVì€ ë‹¤ì‹œ PVCì—ì„œ í• ë‹¹í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

```bash
$ kubectl delete pvc sample-pvc
persistentvolumeclaim "sample-pvc" deleted


$ kubectl get pv sample-pv
NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                STORAGECLASS   REASON   AGE
sample-pv   1Gi        RWX            Retain           Released   default/sample-pvc   csi-fs-sc               55m
```

<br>

## (3) ë™ì  í”„ë¡œë¹„ì €ë‹

+ ì§€ê¸ˆê¹Œì§€ PVCì—ì„œëŠ” PVì„ ë¯¸ë¦¬ ìƒì„±í•´ ë‘ê³  PVC ìš”ì²­ì— ë”°ë¼ ë³¼ë¥¨ì„ í• ë‹¹í•˜ëŠ” ìˆœì„œë¡œ ì§„í–‰ë˜ì—ˆë‹¤.

+ ê·¸ë˜ì„œ ì‚¬ì „ì— PVì„ ìƒì„±í•´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ê³¼ PVCì´ ìš”ì²­í•˜ëŠ” ìš©ëŸ‰ ì´ìƒìœ¼ë¡œ ì˜êµ¬ ë³¼ë¥¨ì´ í• ë‹¹ë˜ì–´ ë‚­ë¹„ê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.

+ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê²ƒì´ ë™ì  í”„ë¡œë¹„ì €ë‹ì´ë‹¤.

+ ë™ì  í”„ë¡œë¹„ì €ë‹ì„ ì‚¬ìš©í•œ PVCì˜ ê²½ìš° PVCì´ ìƒì„±ë˜ëŠ” íƒ€ì´ë°ì— ë™ì ìœ¼ë¡œ PVë¥¼ ìƒì„±í•˜ê³  í• ë‹¹í•œë‹¤.

+ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œëŠ” ë”°ë¡œ ì„¤ì •í•  ê²ƒì€ ì—†ìœ¼ë‚˜, ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œëŠ” ë”°ë¡œ ì‘ì—…ì„ í•´ì¤˜ì•¼ í•œë‹¤.

  + ceph ì„œë²„ êµ¬ì„±: <https://revenge1005.github.io/kubernetes/ch03-6-2/>
  
  + k8s cephfs csi ì„¤ì •: <https://revenge1005.github.io/kubernetes/ch03-6-3/>


![022](https://user-images.githubusercontent.com/42735894/231082220-fe9eaa75-c3d8-4812-8e44-4515f3eb8ade.png){: width="100%" height="100%"}{: .align-center}

<br>

### ã€ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ìƒì„±ã€‘

+ ë™ì  í”„ë¡œë¹„ì €ë‹ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì‚¬ì „ì— ì–´ë–¤ PVë¥¼ ìƒì„±í• ì§€ ì •ì˜í•œ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.

```bash
cat csi-fs-sc.yaml
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
   name: csi-fs-sc
allowVolumeExpansion: true
provisioner: cephfs.csi.ceph.com
parameters:
   clusterID: myceph
   fsName: kubernetes
   csi.storage.k8s.io/controller-expand-secret-name: csi-fs-secret
   csi.storage.k8s.io/controller-expand-secret-namespace: ceph-csi-cephfs
   csi.storage.k8s.io/provisioner-secret-name: csi-fs-secret
   csi.storage.k8s.io/provisioner-secret-namespace: ceph-csi-cephfs
   csi.storage.k8s.io/node-stage-secret-name: csi-fs-secret
   csi.storage.k8s.io/node-stage-secret-namespace: ceph-csi-cephfs
reclaimPolicy: Delete
mountOptions:
   - debug
```

<br>

### ã€PVC ìƒì„±ã€‘

+ ë™ì  í”„ë¡œë¹„ì €ë‹ìš© ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ë¥¼ ì§€ì •í•˜ì—¬ PVCë¥¼ ìƒì„±í•œë‹¤.

+ ì´ PVCì„ ìƒì„±í•˜ë©´ pvc-ë¡œ ì‹œì‘í•˜ëŠ” ì´ë¦„ì´ ë¶™ì€ PVê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ê³  í• ë‹¹ëœë‹¤.

```bash
$ cat /root/fs-pvc.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: csi-cephfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: csi-fs-sc


# PVC í™•ì¸
$ kubectl get pvc csi-cephfs-pvc
NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
csi-cephfs-pvc   Bound    pvc-7f521f85-af28-437f-be7b-0da7efe38628   1Gi        RWX            csi-fs-sc      3h19m


# ìƒìƒí•œ PV í™•ì¸
$ kubectl get pv pvc-7f521f85-af28-437f-be7b-0da7efe38628
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
pvc-7f521f85-af28-437f-be7b-0da7efe38628   1Gi        RWX            Delete           Bound    default/csi-cephfs-pvc   csi-fs-sc               3h18m
```

<br>

### ã€íŒŒë“œ ìƒì„±ã€‘

```bash
$ cat <<EOF > sample-pvc-dynamic-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-pvc-pod
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    volumeMounts:
    - mountPath: "/usr/share/nginx/html"
      name: nginx-pvc
  volumes:
  - name: nginx-pvc
    persistentVolumeClaim:
      claimName: csi-cephfs-pvc
EOF
```

<br>

## (4) PVC ì¡°ì •ì„ ì‚¬ìš©í•œ ë³¼ë¥¨ í™•ì¥

+ PVC í¬ê¸°ë¥¼ ì¡°ì •í•˜ë ¤ë©´ ì‚¬ì „ì— ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ì— **"allowVolumeExpansion: true"ë¥¼ ì„¤ì •**í•˜ê³  ê·¸ ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ë¡œ PVCë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.

+ ìœ„ ìŠ¤í† ë¦¬ì§€í´ë˜ìŠ¤ ì˜ˆì œì— ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆë‹¤.


![08](https://user-images.githubusercontent.com/42735894/231084378-682ad2b6-a22f-4cc8-9e89-6ff574a307ee.png){: width="100%" height="100%"}{: .align-center}


```bash
# í¬ê¸° ì¡°ì •ì´ ê°€ëŠ¥í•œ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•œ PVC ì˜ˆì œ
$ cat <<EOF > sample-pvc-resize.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sample-pvc-resize
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 2Gi
  storageClassName: csi-fs-sc
EOF


# PVCë¥¼ ì‚¬ìš©í•˜ì—¬ 2Gi PV ìƒì„±
$ kubectl apply -f sample-pvc-resize.yaml
persistentvolumeclaim/sample-pvc-resize created


$ kubectl get pvc sample-pvc-resize
NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
sample-pvc-resize   Bound    pvc-10b5ff6e-c5fa-4ef5-84d5-94f73ae693bf   2Gi        RWX            csi-fs-sc      12s


$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                       STORAGECLASS   REASON   AGE
pvc-10b5ff6e-c5fa-4ef5-84d5-94f73ae693bf   2Gi        RWX            Delete           Bound    default/sample-pvc-resize   csi-fs-sc               25s
```

<br>

### íŒŒë“œ ë§¤ë‹ˆíŒ¨ìŠ¤íŠ¸ ì‘ì„±

```bash
$ cat <<EOF > sample-pvc-resize-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-pvc-resize-pod
spec:
  containers:
  - name: nginx-container
    image: nginx:1.16
    volumeMounts:
    - mountPath: "/usr/share/nginx/html"
      name: nginx-pvc
  volumes:
  - name: nginx-pvc
    persistentVolumeClaim:
      claimName: sample-pvc-resize
EOF


$ kubectl exec -it sample-pvc-resize-pod -- df -h | grep /usr/share/nginx/html
192.168.219.51:6789:/volumes/csi/csi-vol-cf3a02d2-f785-43f5-af56-8c9f6aa8b194/4c930cb3-d90d-42e6-9df9-e167aca8cd38  2.0G     0  2.0G   0% /usr/share/nginx/html


# PVCì—ì„œ ìš”ì²­í•˜ëŠ” ìš©ëŸ‰ ë³€ê²½
$ kubectl patch pvc sample-pvc-resize --patch '{"spec": {"resources": {"requests": {"storage": "4Gi"}}}}'
persistentvolumeclaim/sample-pvc-resize patched


# PVì´ í™•ì¥ëœ ê²ƒì„ í™•ì¸
$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                       STORAGECLASS   REASON   AGE
pvc-10b5ff6e-c5fa-4ef5-84d5-94f73ae693bf   4Gi        RWX            Delete           Bound    default/sample-pvc-resize   csi-fs-sc               10m
```

<br>

### PVC ì¡°ì •ì€ **ë””ìŠ¤í¬ í¬ê¸°ë¥¼ í™•ì¥í•  ìˆ˜ ìˆì§€ë§Œ ì¶•ì†Œí•  ìˆ˜ëŠ” ì—†ë‹¤ëŠ” ì ì— ì£¼ì˜**í•´ì•¼ í•œë‹¤.

```bash
$ kubectl patch pvc sample-pvc-resize --patch '{"spec": {"resources": {"requests": {"storage": "1Gi"}}}}'
The PersistentVolumeClaim "sample-pvc-resize" is invalid: spec.resources.requests.storage: Forbidden: field can not be less than previous value
```

<br>

## (5) ìŠ¤í…Œì´íŠ¸í’€ì…‹ì—ì„œ PVC - volumeClaimTemplate

+ ìŠ¤í…Œì´íŠ¸í’€ì…‹ì˜ ì›Œí¬ë¡œë“œì—ì„œëŠ” ì˜êµ¬ ë°ì´í„° ì˜ì—­ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤. 

+ spec.volumeClaimTemplateì„ ì‚¬ìš©í•˜ë©´ PVCì„ ë³„ë„ë¡œ ì •ì˜í•˜ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ PVCë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

+ ë˜ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ volumeMountsì— volumeClaimTemplate ì´ë¦„ì„ ì§€ì •í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì™„ë£Œë˜ê³ , ìŠ¤í…Œì´íŠ¸í’€ì…‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë§Œìœ¼ë¡œ ì„¤ì •ì´ ëë‚œë‹¤.


![26](https://user-images.githubusercontent.com/42735894/231085834-a97e1ad4-30e2-48c2-95ef-a52709630a5c.png){: width="60%" height="60%"}{: .align-center}


```bash
cat <<EOF > sample-statefulset-with-pvc.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sample-statefulset-with-pvc
spec:
  serviceName: stateful-with-pvc
  replicas: 2
  selector:
    matchLabels:
      app: sample-pvc
  template:
    metadata:
      labels:
        app: sample-pvc
    spec:
      containers:
      - name: sample-pvc
        image: nginx:1.16
        volumeMounts:
        - name: pvc-template-volume
          mountPath: /tmp
  volumeClaimTemplates:
  - metadata:
      name: pvc-template-volume
    spec:
      accessModes:
      - ReadWriteMany
      resources:
        requests:
          storage: 1Gi
      storageClassName: csi-fs-sc
EOF
```

```bash
# ìŠ¤í…Œì´í”„í’€ì…‹ì„ ìƒì„±í•˜ë©´ PVC ë‘ ê°œê°€ ìƒì„±ë˜ê³  ê°ê° ì˜êµ¬ ë³¼ë¥¨ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
$ kubectl get pvc
NAME                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
pvc-template-volume-sample-statefulset-with-pvc-0   Bound    pvc-bc55a161-7305-4fbd-bafb-1a518571ed3a   1Gi        RWX            csi-fs-sc      99s
pvc-template-volume-sample-statefulset-with-pvc-1   Bound    pvc-821ec652-c920-4053-977d-1aa5d062b822   1Gi        RWX            csi-fs-sc      85s
```