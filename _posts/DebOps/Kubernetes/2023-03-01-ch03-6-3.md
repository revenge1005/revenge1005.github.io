---
title:  "[Retry, k8s] 06. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  ë³¼ë¥¨ í”„ë¡œë¹„ì €ë‹(CephFS) - (3)"

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
# [Retry, k8s] 06. ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œ SDSì— ì˜í•œ ë™ì  ë³¼ë¥¨ í”„ë¡œë¹„ì €ë‹(CephFS) - (3)
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

<br>

## ğŸ”” kubernetesì— ceph-csi êµ¬ì„± (Helm chartë¡œ ì„¤ì¹˜í•˜ê³  ì‚¬ìš©í•˜ê¸°)

> ceph-csiëŠ” ceph ì»¤ë®¤ë‹ˆí‹°ì—ì„œ kubernetesì˜ ì €ì¥ì†Œ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ [cephìš© êµ¬í˜„ì²´](https://github.com/ceph/ceph-csi)ì´ë‹¤. <br><br>
Ceph CSI í”ŒëŸ¬ê·¸ì¸ì€ container orchestrator(kubernetes)ì™€ ceph í´ëŸ¬ìŠ¤í„°ê°„ ì¸í„°í˜ì´ìŠ¤ì— ëŒ€í•œ êµ¬í˜„ì´ë‹¤. <br><br>
eph ë³¼ë¥¨ì„ ë™ì ìœ¼ë¡œ ë°°í¬í•˜ê³  ì›Œí¬ë¡œë“œì™€ ì—°ê²°ì‹œí‚¨ê³ , cephì˜ ë‹¤ì–‘í•œ ì œê³µê¸°ëŠ¥ì¸ [rbd(rbd ë¬¸ì„œ ì°¸ì¡°)](https://github.com/ceph/ceph-csi/blob/devel/docs/deploy-rbd.md)ì™€ [cephfs ë³¼ë¥¨(cephFS ë¬¸ì„œì°¸ì¡°)](https://github.com/ceph/ceph-csi/blob/devel/docs/deploy-cephfs.md), nfs ë³¼ë¥¨ì„ ì§€ì›í•œë‹¤.

<br>

### (1) Helm repo

> <https://github.com/ceph/ceph-csi/tree/devel/charts/ceph-csi-cephfs>

```bash
root@k8s-master:~# helm repo add ceph-csi https://ceph.github.io/csi-charts


root@k8s-master:~# helm search repo ceph-csi
NAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       
ceph-csi/ceph-csi-cephfs        3.6.1           3.6.1           Container Storage Interface (CSI) driver, provi...
ceph-csi/ceph-csi-rbd           3.6.1           3.6.1           Container Storage Interface (CSI) driver, provi...helm repo add ceph-csi https://ceph.github.io/csi-charts
```


### (2) í™˜ê²½ë°˜ì˜

> Helm ì„¤ì¹˜ë¥¼ ìœ„í•´ í™˜ê²½ì— ë§ë„ë¡ ê°’ ì¬ì§€ì •(value-override) íŒŒì¼ì„ ì¤€ë¹„í•˜ì. ì „ì²´ ê°’ì€ ë‹¤ìŒ ë§í¬(<https://github.com/ceph/ceph-csi/tree/devel/charts/ceph-csi-rbd#configuration>)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ê³  ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì—°ê²°í•œ ceph í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ monitorë§Œ ì§€ì •í•œë‹¤. ê·¸ ì™¸ storage classë“±ì„ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë‚˜ ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë”°ë¡œ ì¶”ê°€í•œë‹¤.

```bash
root@k8s-master:~# cat <<EOF > ceph-csi.vo
csiConfig:
- clusterID: "myceph"
  monitors:
  - "192.168.219.51:6789"
EOF
```


### (3) ì„¤ì¹˜í•˜ê¸° (í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ì„¤ì¹˜í•˜ëŠ”ë° ì‹œê°„ì´ ì¢€ ê±¸ë¦¼)

```bash
root@k8s-master:~# kubectl create namespace "ceph-csi-cephfs"

root@k8s-master:~# helm install --namespace "ceph-csi-cephfs" "ceph-csi-cephfs" ceph-csi/ceph-csi-cephfs -f ceph-csi.vo

root@k8s-master:~# kubectl get all -n ceph-csi-cephfs
```


### (4) secret êµ¬ì„± ë° ë°°í¬

```bash
# userkeyëŠ” ceph í´ëŸ¬ìŠ¤íŠ¸ì˜ ê´€ë¦¬ ë…¸ë“œì—ì„œ "ceph auth list" ëª…ë ¹ìœ¼ë¡œ í™•ì¸
root@k8s-master:~# cat csi-fs-secret.yaml 
---
apiVersion: v1
kind: Secret
metadata:
  name: csi-fs-secret
  namespace: ceph-csi-cephfs
stringData:
  userID: cephfs
  userKey: AQBgJ1Rg9DMzEhAA/y3+g2tDGHOujxPVjFHS6A==
  adminID: admin
  adminKey: AQBs/FJgC6z2OhAAoPp0WFfPvhp0DiLEKk01xw==


root@k8s-master:~# kubectl apply -f csi-fs-secret.yaml 
```


### (5) StorageClass êµ¬ì„± ë° ë°°í¬í•˜ê³ 

```bash
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
   name: csi-fs-sc
allowVolumeExpansion: true
provisioner: cephfs.csi.ceph.com
parameters:
   clusterID: myceph
   fsName: kubernetes
   csi.storage.k8s.io/controller-expand-secret-name: csi-fs-secret
   csi.storage.k8s.io/controller-expand-secret-namespace: ceph-csi-cephfs
   csi.storage.k8s.io/provisioner-secret-name: csi-fs-secret
   csi.storage.k8s.io/provisioner-secret-namespace: ceph-csi-cephfs
   csi.storage.k8s.io/node-stage-secret-name: csi-fs-secret
   csi.storage.k8s.io/node-stage-secret-namespace: ceph-csi-cephfs
reclaimPolicy: Delete
mountOptions:
   - debug

root@k8s-master:~# kubectl apply -f csi-fs-sc.yaml 
```


### (5) pvc ìƒì„± ë° ë°°í¬

```bash
root@k8s-master:~# cat fs-pvc.yaml 
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: csi-cephfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: csi-fs-sc


root@k8s-master:~# kubectl apply -f fs-pvc.yaml 
```


### (5) í™•ì¸

```bash
# k8s í´ëŸ¬ìŠ¤í„°ì˜ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í™•ì¸
root@k8s-master:~# kubectl get pvc
NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
csi-cephfs-pvc   Bound    pvc-dcc50cf4-5d58-4b04-8f90-b6942755b1a2   1Gi        RWX            csi-fs-sc      3s
```

```bash
# cpeh í´ëŸ¬ìŠ¤í„°ì˜ ê´€ë¦¬ ë…¸ë“œì—ì„œ í™•ì¸
root@osd01:/mnt/volumes/kubernetes# ceph fs subvolume ls kubernetes kubernetes
[
    {
        "name": "csi-vol-8d13f788-8882-11eb-8e8b-22b3dcc00ebf"
    },
    {
        "name": "csi-vol-f80fe59d-8882-11eb-8e8b-22b3dcc00ebf"
    }
]
```

<br>