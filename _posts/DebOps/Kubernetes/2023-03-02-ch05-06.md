---
title:  "[Retry, k8s] 24. 컨피그 & 스토리지 API - 영구 볼륨 클레임(PVC)" 

categories:
  - KUBERNETES
tags:
  - [kubernetes]

toc: true
toc_sticky: true

date: 2023-03-01
last_modified_at: 2023-03-01
---
<br>

# 🔔 영구 볼륨 클레임
---

<style>
table {
    font-size: 12pt;
}
table th:first-of-type {
    width: 5%;
}
table th:nth-of-type(2) {
    width: 15%;
}
table th:nth-of-type(3) {
    width: 50%;
}
table th:nth-of-type(4) {
    width: 30%;
}
</style>

**시작하기 전 선행 작업 및 확인해야할 내용** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-1/>** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-2/>** <br> - **<https://revenge1005.github.io/kubernetes/ch03-6-3/>**
{: .notice--warning}

> **PVC는 영구 볼륨(PV)을 요청하는 리소스**로, PVC에서 지정한 조건(용량, 레이블)을 기반으로 PV에 대한 요청이 들어오면 스케줄러는 현재 가지고 있는 영구 볼륨에서 적당한 볼륨을 할당한다.


<br>

## (1) PVC 설정

+ 레이블 셀렉터

+ 용량 

+ 접근 모드

+ 스토리지클래스

```bash
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sample-pvc
spec:
  selector:
    matchLabels:
      type: ceph-pv
    matchExpressions:
    - key: environment
      operator: In
      values:
      - stg
  resources:
    requests:
      storage: 1Gi
  accessModes:
  - ReadWriteMany
  storageClassName: csi-fs-sc
```

<br>

## (2) PVC 생성

```bash
# PVC 정보 확인
$ kubectl get pvc sample-pvc
NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE
sample-pvc   Bound    sample-pv   1Gi        RWX            csi-fs-sc      49s


# PV 정보 확인
$ kubectl get pv sample-pv
NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE
sample-pv   1Gi        RWX            Retain           Bound    default/sample-pvc   csi-fs-sc               49m
```

<br>

## (2) PVC 삭제

+ Retain 정책을 사용하고 있는 경우 PVC를 삭제할 때 PV의 STATUS가 Bound에서 Released로 변경된다.

+ Released 상태의 PV은 다시 PVC에서 할당하여 사용할 수 없다.

```bash
$ kubectl delete pvc sample-pvc
persistentvolumeclaim "sample-pvc" deleted


$ kubectl get pv sample-pv
NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                STORAGECLASS   REASON   AGE
sample-pv   1Gi        RWX            Retain           Released   default/sample-pvc   csi-fs-sc               55m
```

<br>

## (3) 동적 프로비저닝

+ 지금까지 PVC에서는 PV을 미리 생성해 두고 PVC 요청에 따라 볼륨을 할당하는 순서로 진행되었다.

+ 그래서 사전에 PV을 생성해야 하는 번거로움과 PVC이 요청하는 용량 이상으로 영구 볼륨이 할당되어 낭비가 발생하는 문제가 있었다.

+ 이런 문제를 해결하는 것이 동적 프로비저닝이다.

+ 동적 프로비저닝을 사용한 PVC의 경우 PVC이 생성되는 타이밍에 동적으로 PV를 생성하고 할당한다.

